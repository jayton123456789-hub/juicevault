<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>JuiceVault</title>
<link rel="icon" type="image/png" href="/assets/JuiceVaultIconLOGO.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Sora:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════
   JUICEVAULT V1 — Complete Design System
   ═══════════════════════════════════════════════════════ */

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  /* Core Palette */
  --bg-deep: #050508;
  --bg: #0a0a10;
  --bg-raised: #0f0f18;
  --bg-card: #131320;
  --bg-card-hover: #1a1a2e;
  --bg-surface: #16162a;
  --bg-input: #0d0d16;

  /* Purple Spectrum - Juice WRLD Aesthetic */
  --purple-50: #f5f0ff;
  --purple-100: #ece0ff;
  --purple-200: #d4b8ff;
  --purple-300: #b07fff;
  --purple-400: #9b5de5;
  --purple-500: #8b47d6;
  --purple-600: #7432b8;
  --purple-700: #5e2599;
  --purple-800: #421a6e;
  --purple-900: #2a1145;

  /* Accent Colors */
  --pink: #f15bb5;
  --pink-glow: rgba(241, 91, 181, 0.15);
  --cyan: #00f5d4;
  --cyan-glow: rgba(0, 245, 212, 0.12);
  --orange: #ff9e2c;
  --red: #ff4757;
  --green: #2ed573;

  /* Text */
  --text: #ededf5;
  --text-secondary: #8b8ba0;
  --text-muted: #55556a;
  --text-faint: #3a3a50;

  /* Glass & Borders */
  --glass: rgba(255,255,255,0.03);
  --glass-hover: rgba(255,255,255,0.06);
  --glass-active: rgba(255,255,255,0.08);
  --border: rgba(255,255,255,0.06);
  --border-hover: rgba(255,255,255,0.12);
  --border-accent: rgba(155,93,229,0.3);

  /* Shadows */
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 48px rgba(0,0,0,0.5);
  --shadow-glow: 0 0 40px rgba(155,93,229,0.15);

  /* Layout */
  --sidebar-w: 240px;
  --player-h: 90px;
  --header-h: 64px;
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-full: 9999px;

  /* Typography */
  --font-body: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
  --font-display: 'Sora', 'Plus Jakarta Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;

  /* Transitions */
  --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
}

html {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-size: 15px;
  scrollbar-width: thin;
  scrollbar-color: var(--purple-800) transparent;
}

body { min-height: 100vh; overflow: hidden; }
input,button,select,textarea { font-family: inherit; color: inherit; }
a { color: var(--purple-300); text-decoration: none; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--purple-800); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--purple-600); }
::selection { background: var(--purple-600); color: #fff; }

/* ═══════════════════════════════════════════════════════
   V3: 50 NEW FEATURES - COMPREHENSIVE CSS
   ═══════════════════════════════════════════════════════ */

/* Feature 1: Mini Player Widget */
.mini-player { position: fixed; bottom: calc(var(--player-h) + 16px); right: 16px; width: 320px; background: var(--bg-raised); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; z-index: 40; box-shadow: var(--shadow-lg); display: none; animation: slideUp 0.3s var(--ease-out); }
.mini-player.visible { display: block; }
.mini-player.always-on-top { z-index: 9999; }
.mini-player-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.mini-player-content { display: flex; align-items: center; gap: 12px; }
.mini-player-art { width: 56px; height: 56px; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-card); flex-shrink: 0; }
.mini-player-progress { height: 3px; background: var(--bg-card); border-radius: 2px; margin-top: 12px; cursor: pointer; overflow: hidden; }
.mini-player-progress-fill { height: 100%; background: linear-gradient(90deg, var(--purple-400), var(--pink)); width: 0%; transition: width 0.1s; }
.mini-player-play { width: 36px; height: 36px; border-radius: 50%; background: var(--purple-500); border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }

/* Feature 2: Picture-in-Picture */
.pip-container { position: fixed; bottom: 100px; right: 20px; width: 300px; height: 170px; background: var(--bg-raised); border: 2px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; z-index: 50; display: none; box-shadow: var(--shadow-lg); }
.pip-container.open { display: block; }
.pip-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 50%); display: flex; flex-direction: column; justify-content: flex-end; padding: 12px; }

/* Feature 3: Visualizer */
.visualizer-overlay { position: fixed; inset: 0; z-index: 90; display: none; background: rgba(5,5,8,0.95); backdrop-filter: blur(20px); }
.visualizer-overlay.open { display: flex; flex-direction: column; }
.visualizer-canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
#visualizerCanvas { width: 100%; height: 100%; }
.visualizer-controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; padding: 12px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-full); }

/* Feature 4: Audio Effects */
.audio-effects-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 420px; background: var(--bg-raised); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 24px; z-index: 160; display: none; }
.audio-effects-panel.open { display: block; }
.effect-group { margin-bottom: 20px; padding: 16px; background: var(--bg-card); border-radius: var(--radius-md); }
.effect-toggle { width: 44px; height: 24px; background: var(--bg-surface); border-radius: 12px; position: relative; cursor: pointer; }
.effect-toggle.active { background: var(--purple-500); }
.effect-toggle::after { content: ''; position: absolute; width: 20px; height: 20px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s; }
.effect-toggle.active::after { left: 22px; }

/* Features 5-9: Speed, Audio Controls, Crossfade */
.speed-popup { position: absolute; bottom: calc(100% + 10px); left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; min-width: 200px; display: none; }
.speed-popup.open { display: block; }
.crossfade-control { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-card); border-radius: var(--radius-md); margin-top: 12px; }
.smart-shuffle-badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: linear-gradient(135deg, rgba(155,93,229,0.2), rgba(241,91,181,0.1)); border: 1px solid rgba(155,93,229,0.3); border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 700; color: var(--purple-300); }

/* Features 11-13: Social Panel */
.social-panel { position: fixed; top: 0; right: 0; bottom: var(--player-h); width: 320px; background: var(--bg-raised); border-left: 1px solid var(--border); z-index: 25; display: none; flex-direction: column; transform: translateX(100%); transition: transform 0.35s var(--ease-out); }
.social-panel.open { display: flex; transform: none; }
.activity-item { display: flex; gap: 12px; padding: 12px; border-radius: var(--radius-md); margin-bottom: 8px; }
.activity-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--purple-600), var(--pink)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }

/* Feature 14: Share Dialog */
.share-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: var(--bg-raised); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 24px; z-index: 200; display: none; }
.share-dialog.open { display: block; }

/* Features 15-16: Comments & Ratings */
.comments-section { margin-top: 32px; padding: 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); }
.comment-input { flex: 1; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px; color: var(--text); font-size: 0.9rem; resize: vertical; min-height: 48px; }
.rating-star { width: 28px; height: 28px; background: none; border: none; cursor: pointer; color: var(--text-muted); }
.rating-star.active { color: #ffd700; }

/* Features 17-18: Leaderboard & Achievements */
.leaderboard-item { display: flex; align-items: center; gap: 16px; padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
.leaderboard-rank.gold { color: #ffd700; }
.leaderboard-rank.silver { color: #c0c0c0; }
.leaderboard-rank.bronze { color: #cd7f32; }
.achievement-card { display: flex; gap: 16px; padding: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 12px; }
.achievement-icon { width: 56px; height: 56px; border-radius: var(--radius-md); background: linear-gradient(135deg, var(--purple-500), var(--pink)); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }

/* Features 19-20: Stats */
.stat-card-large { padding: 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); text-align: center; }
.wrapped-container { background: linear-gradient(135deg, var(--purple-900) 0%, var(--bg-deep) 50%, rgba(241,91,181,0.2) 100%); border-radius: var(--radius-xl); padding: 40px; text-align: center; margin-bottom: 32px; }

/* Features 21-30: Discovery */
.advanced-search-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 24px; }
.trending-item { display: flex; align-items: center; gap: 16px; padding: 14px 20px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
.leak-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; background: linear-gradient(135deg, rgba(255,71,87,0.15), rgba(255,71,87,0.05)); border: 1px solid rgba(255,71,87,0.3); border-radius: var(--radius-full); font-size: 0.65rem; font-weight: 700; color: var(--red); animation: badgePulse 2s ease-in-out infinite; }

/* Features 31-35: Organization */
.tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
.song-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius-full); font-size: 0.8rem; color: var(--text-secondary); }
.bookmark-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; margin-bottom: 8px; }
.bookmark-time { font-family: var(--font-mono); font-size: 0.85rem; color: var(--purple-300); min-width: 50px; }

/* Features 36-40: Queue & Session */
.priority-queue-section { background: linear-gradient(135deg, rgba(255,158,44,0.1), rgba(255,158,44,0.02)); border: 1px solid rgba(255,158,44,0.2); border-radius: var(--radius-md); padding: 12px; margin-bottom: 12px; }
.session-restore-toast { position: fixed; top: 20px; right: 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px 20px; box-shadow: var(--shadow-lg); z-index: 200; display: none; }
.session-restore-toast.open { display: block; }

/* Features 41-45: Analysis */
.audio-analysis-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 20px; }
.analysis-stat { text-align: center; padding: 16px; background: var(--bg-input); border-radius: var(--radius-md); }
.energy-bar { width: 100%; height: 8px; background: var(--bg-surface); border-radius: 4px; margin-top: 8px; overflow: hidden; }
.energy-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--purple-400), var(--pink)); }

/* Features 46-47: Shortcuts & Voice */
.voice-overlay { position: fixed; inset: 0; background: rgba(5,5,8,0.9); backdrop-filter: blur(10px); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; }
.voice-overlay.open { display: flex; }
.voice-pulse { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, var(--purple-500) 0%, transparent 70%); opacity: 0.3; animation: voicePulse 2s ease-in-out infinite; }

/* Features 48-50: Timer & Auto-pause */
.timer-panel { position: fixed; bottom: calc(var(--player-h) + 16px); left: 16px; background: var(--bg-raised); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; width: 280px; display: none; }
.timer-panel.open { display: block; }
.timer-display-value { font-family: var(--font-display); font-size: 2.5rem; font-weight: 800; color: var(--purple-300); }
.autopause-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 14px 24px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-full); box-shadow: var(--shadow-lg); z-index: 200; display: none; }
.autopause-toast.open { display: flex; align-items: center; gap: 12px; }

/* ═══ V3 KEYFRAMES ═══ */
@keyframes fadeIn { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:none } }
@keyframes visualizerPulse { 0%,100% { transform:scaleY(0.3) } 50% { transform:scaleY(1) } }
@keyframes voicePulse { 0%,100% { transform:scale(0.8); opacity:0.3 } 50% { transform:scale(1.2); opacity:0.6 } }
@keyframes floatUp { 0% { transform:translateY(0); opacity:1 } 100% { transform:translateY(-20px); opacity:0 } }
@keyframes achievementUnlock { 0% { transform:scale(0) rotate(-10deg) } 50% { transform:scale(1.1) rotate(2deg) } 100% { transform:scale(1) rotate(0) } }
@keyframes slideUp { from { opacity:0; transform:translateY(30px) } to { opacity:1; transform:none } }
@keyframes slideDown { from { opacity:0; transform:translateY(-20px) } to { opacity:1; transform:none } }
@keyframes slideRight { from { transform:translateX(100%); opacity:0 } to { transform:none; opacity:1 } }
@keyframes scaleIn { from { opacity:0; transform:scale(0.92) } to { opacity:1; transform:scale(1) } }
@keyframes spin { to { transform:rotate(360deg) } }
@keyframes pulse { 0%,100% { opacity:1 } 50% { opacity:0.5 } }
@keyframes shimmer { 0% { background-position:-200% 0 } 100% { background-position:200% 0 } }
@keyframes float { 0%,100% { transform:translateY(0) } 50% { transform:translateY(-12px) } }
@keyframes orbMove1 { 0% { transform:translate(0,0) scale(1) } 33% { transform:translate(100px,-50px) scale(1.1) } 66% { transform:translate(-50px,80px) scale(0.9) } 100% { transform:translate(0,0) scale(1) } }
@keyframes orbMove2 { 0% { transform:translate(0,0) scale(1) } 33% { transform:translate(-80px,60px) scale(0.95) } 66% { transform:translate(60px,-40px) scale(1.05) } 100% { transform:translate(0,0) scale(1) } }
@keyframes orbMove3 { 0% { transform:translate(0,0) scale(1) } 33% { transform:translate(50px,70px) scale(1.08) } 66% { transform:translate(-70px,-30px) scale(0.92) } 100% { transform:translate(0,0) scale(1) } }
@keyframes barPulse { 0%,100% { height:4px } 50% { height:20px } }
@keyframes gradientShift { 0% { background-position:0% 50% } 50% { background-position:100% 50% } 100% { background-position:0% 50% } }

/* ═══════════════════════════════════════════════════════
   AUTH SCREEN
   ═══════════════════════════════════════════════════════ */

.auth-screen {
  position: fixed; inset: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg-deep);
  overflow: hidden;
  z-index: 1000;
}

.auth-bg {
  position: absolute; inset: 0;
  overflow: hidden;
  background: url('/assets/JuiceVaultBG.png') center/cover no-repeat;
  background-color: #0a0a0f;
}
.auth-bg::before {
  content: '';
  position: absolute; inset: 0;
  background: 
    radial-gradient(ellipse at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
  z-index: 1;
}

/* Netflix-style Scrolling Albums */
/* Netflix-style Scrolling Albums - FIXED for seamless infinite scroll */
.album-scroll-container {
  position: absolute;
  inset: -10%;
  display: flex;
  flex-direction: column;
  gap: 20px;
  transform: rotate(-5deg) scale(1.25);
  z-index: 0;
  opacity: 0.55;
  overflow: hidden;
}
.album-row {
  display: flex;
  gap: 20px;
  width: max-content;
  will-change: transform;
}
.album-row:nth-child(odd) {
  animation: scroll-left 50s linear infinite;
}
.album-row:nth-child(even) {
  animation: scroll-right 55s linear infinite;
}
/* Stagger animation durations for variety */
.album-row:nth-child(1) { animation-duration: 48s; }
.album-row:nth-child(2) { animation-duration: 55s; }
.album-row:nth-child(3) { animation-duration: 42s; }
.album-row:nth-child(4) { animation-duration: 60s; }
.album-row:nth-child(5) { animation-duration: 50s; }
.album-row:nth-child(6) { animation-duration: 45s; }
.album-row:nth-child(7) { animation-duration: 53s; }

/* Keyframes that account for duplicated content */
@keyframes scroll-left {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}
@keyframes scroll-right {
  0% { transform: translateX(-50%); }
  100% { transform: translateX(0); }
}
.album-cover {
  width: 160px;
  height: 160px;
  border-radius: 10px;
  overflow: hidden;
  flex-shrink: 0;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
  transition: transform 0.3s ease;
}
.album-cover:hover { transform: scale(1.05); }
.album-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: brightness(0.65) saturate(0.9);
}
.auth-vignette {
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 0%, rgba(10, 10, 15, 0.5) 70%, rgba(10, 10, 15, 0.95) 100%);
  z-index: 2;
  pointer-events: none;
}

.auth-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.5;
}
.auth-orb-1 {
  width: 500px; height: 500px;
  background: radial-gradient(circle, var(--purple-600) 0%, transparent 70%);
  top: -10%; left: -5%;
  animation: orbMove1 20s ease-in-out infinite;
}
.auth-orb-2 {
  width: 400px; height: 400px;
  background: radial-gradient(circle, var(--pink) 0%, transparent 70%);
  bottom: -15%; right: -5%;
  animation: orbMove2 25s ease-in-out infinite;
  opacity: 0.3;
}
.auth-orb-3 {
  width: 300px; height: 300px;
  background: radial-gradient(circle, var(--cyan) 0%, transparent 70%);
  top: 40%; right: 20%;
  animation: orbMove3 18s ease-in-out infinite;
  opacity: 0.15;
}

.auth-noise {
  position: absolute; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  opacity: 0.4;
  pointer-events: none;
}

.auth-card {
  position: relative;
  width: 100%; max-width: 420px;
  padding: 48px 40px;
  margin: 20px;
  background: linear-gradient(145deg, rgba(25, 25, 40, 0.85) 0%, rgba(15, 15, 25, 0.95) 50%, rgba(10, 10, 20, 0.98) 100%);
  backdrop-filter: blur(60px) saturate(2.5);
  -webkit-backdrop-filter: blur(60px) saturate(2.5);
  border-radius: 24px;
  box-shadow: 
    0 32px 100px rgba(0, 0, 0, 0.7),
    0 0 0 1px rgba(139, 92, 246, 0.15),
    inset 0 1px 0 rgba(255, 255, 255, 0.08),
    0 0 60px rgba(139, 92, 246, 0.15),
    0 0 120px rgba(139, 92, 246, 0.05);
  animation: scaleIn 0.6s var(--ease-out), floatCard 6s ease-in-out infinite;
  z-index: 10;
  overflow: hidden;
}

/* Animated gradient border */
.auth-card::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 24px;
  padding: 2px;
  background: linear-gradient(135deg, 
    rgba(139, 92, 246, 0.8) 0%, 
    rgba(236, 72, 153, 0.6) 25%, 
    rgba(34, 211, 238, 0.5) 50%, 
    rgba(236, 72, 153, 0.6) 75%, 
    rgba(139, 92, 246, 0.8) 100%);
  background-size: 300% 300%;
  animation: gradientRotate 8s linear infinite;
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  pointer-events: none;
}

/* Inner glow layer */
.auth-card::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 24px;
  background: radial-gradient(ellipse at 50% 0%, rgba(139, 92, 246, 0.15) 0%, transparent 60%);
  pointer-events: none;
  opacity: 0.6;
}

@keyframes gradientRotate {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes floatCard {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-6px); }
}

.auth-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--purple-400), var(--pink), var(--purple-400), transparent);
  opacity: 0.6;
}

.auth-brand {
  text-align: center;
  margin-bottom: 36px;
}
.auth-brand .brand-icon {
  width: 180px;
  height: auto;
  margin: 0 auto 10px;
  display: block;
  animation: float 3s ease-in-out infinite, iconGlow 2s ease-in-out infinite alternate;
  filter: drop-shadow(0 0 20px rgba(139, 92, 246, 0.4));
}
.auth-brand .brand-icon img { width: 100%; height: auto; }
@keyframes iconGlow {
  0% { filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.3)); }
  100% { filter: drop-shadow(0 0 25px rgba(236, 72, 153, 0.5)); }
}
.auth-brand h1 {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.auth-brand h1 .brand-gradient {
  background: linear-gradient(135deg, var(--purple-300), var(--pink), var(--purple-400));
  background-size: 200% auto;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradientShift 4s ease infinite;
}
.auth-brand .brand-tag {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin-top: 6px;
  letter-spacing: 2px;
  text-transform: uppercase;
  font-weight: 500;
}

.auth-tabs {
  display: flex; gap: 4px;
  margin-bottom: 28px;
  background: var(--bg-deep);
  border-radius: var(--radius-md);
  padding: 4px;
  border: 1px solid var(--border);
}
.auth-tab {
  flex: 1;
  padding: 10px 16px;
  text-align: center;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--text-muted);
  transition: all 0.3s var(--ease-out);
  border: none;
  background: none;
  position: relative;
}
.auth-tab:hover { color: var(--text-secondary); }
.auth-tab.active {
  background: var(--purple-800);
  color: var(--text);
  box-shadow: 0 2px 12px rgba(155,93,229,0.2);
}

.form-group {
  margin-bottom: 18px;
}
.form-group label {
  display: block;
  font-size: 0.72rem;
  color: var(--text-secondary);
  margin-bottom: 7px;
  font-weight: 600;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.form-group input {
  width: 100%;
  padding: 13px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 0.92rem;
  outline: none;
  transition: all 0.3s var(--ease-out);
  color: var(--text);
}
.form-group input:focus {
  border-color: var(--purple-500);
  box-shadow: 0 0 0 3px rgba(155,93,229,0.15);
}
.form-group input::placeholder { color: var(--text-faint); }

.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 0.92rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s var(--ease-out);
  position: relative;
  overflow: hidden;
}
.btn-primary {
  background: linear-gradient(135deg, var(--purple-500), var(--purple-700));
  color: #fff;
  box-shadow: 0 4px 16px rgba(155,93,229,0.3);
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(155,93,229,0.4);
}
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.4; transform: none; cursor: not-allowed; }

.auth-error {
  color: var(--red);
  font-size: 0.82rem;
  margin-bottom: 14px;
  text-align: center;
  padding: 10px 14px;
  background: rgba(255,71,87,0.08);
  border: 1px solid rgba(255,71,87,0.15);
  border-radius: var(--radius-sm);
  animation: fadeIn 0.3s;
}

.auth-footer {
  text-align: center;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
  font-size: 0.78rem;
  color: var(--text-muted);
}

/* ═══════════════════════════════════════════════════════
   APP SHELL
   ═══════════════════════════════════════════════════════ */

.app { display: none; height: 100vh; flex-direction: column; background: url('/assets/JuiceVaultBG.png') center/cover no-repeat fixed; background-color: var(--bg-deep); }
.app.visible { display: flex; }

.app-body { display: flex; flex: 1; overflow: hidden; position: relative; }

/* ═══ SIDEBAR ═══ */
.sidebar {
  width: var(--sidebar-w);
  background: rgba(10, 10, 20, 0.82);
  backdrop-filter: blur(24px) saturate(1.3);
  -webkit-backdrop-filter: blur(24px) saturate(1.3);
  border-right: 1px solid rgba(155, 93, 229, 0.12);
  display: flex; flex-direction: column;
  flex-shrink: 0;
  transition: width 0.3s var(--ease-out);
  z-index: 20;
}

.sidebar-brand {
  padding: 20px 20px 16px;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer;
}
.sidebar-brand .sb-icon { width: 36px; height: 36px; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
.sidebar-brand .sb-icon img { width: 100%; height: 100%; object-fit: contain; }
.sidebar-brand .sb-text {
  font-family: var(--font-display);
  font-weight: 800;
  font-size: 1.15rem;
  letter-spacing: -0.3px;
}
.sidebar-brand .sb-text span {
  background: linear-gradient(135deg, var(--purple-300), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.sidebar-nav {
  flex: 1;
  padding: 8px 12px;
  overflow-y: auto;
}

.nav-section {
  margin-bottom: 24px;
}
.nav-section-title {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 700;
  padding: 0 8px;
  margin-bottom: 8px;
}

.nav-item {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.2s var(--ease-out);
  color: var(--text-secondary);
  font-size: 0.88rem;
  font-weight: 500;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}
.nav-item:hover {
  background: var(--glass-hover);
  color: var(--text);
}
.nav-item.active {
  background: linear-gradient(135deg, rgba(155,93,229,0.18), rgba(241,91,181,0.08));
  color: var(--purple-200);
  border: 1px solid rgba(155,93,229,0.2);
  box-shadow: 0 0 20px rgba(155,93,229,0.08);
}
.nav-item svg { width: 20px; height: 20px; flex-shrink: 0; opacity: 0.7; }
.nav-item.active svg { opacity: 1; }
.nav-item .nav-badge {
  margin-left: auto;
  background: var(--purple-700);
  color: var(--purple-100);
  font-size: 0.7rem;
  padding: 2px 7px;
  border-radius: var(--radius-full);
  font-weight: 700;
}

.sidebar-user {
  padding: 16px;
  border-top: 1px solid rgba(155, 93, 229, 0.1);
  display: flex; align-items: center; gap: 10px;
}
.sidebar-user .su-avatar {
  width: 34px; height: 34px;
  border-radius: var(--radius-full);
  background: linear-gradient(135deg, var(--purple-600), var(--pink));
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.8rem;
  flex-shrink: 0;
}
.sidebar-user .su-info { flex: 1; min-width: 0; }
.sidebar-user .su-name {
  font-size: 0.82rem;
  font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.sidebar-user .su-role {
  font-size: 0.68rem;
  color: var(--text-muted);
  text-transform: capitalize;
}
.sidebar-user .su-logout {
  background: none; border: none; cursor: pointer;
  color: var(--text-muted); padding: 6px;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
}
.sidebar-user .su-logout:hover { color: var(--red); background: rgba(255,71,87,0.1); }

/* ═══ MAIN CONTENT ═══ */
.main {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  background: rgba(10, 10, 16, 0.55);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  scroll-behavior: smooth;
}

.main-header {
  position: sticky; top: 0;
  height: var(--header-h);
  padding: 0 28px;
  display: flex; align-items: center; gap: 16px;
  background: rgba(10, 10, 20, 0.7);
  backdrop-filter: blur(24px) saturate(1.2);
  -webkit-backdrop-filter: blur(24px) saturate(1.2);
  border-bottom: 1px solid rgba(155, 93, 229, 0.1);
  z-index: 15;
}

.search-box {
  flex: 1; max-width: 480px;
  position: relative;
}
.search-box svg {
  position: absolute;
  left: 14px; top: 50%; transform: translateY(-50%);
  width: 18px; height: 18px;
  color: var(--text-muted);
  pointer-events: none;
}
.search-box input {
  width: 100%;
  padding: 10px 14px 10px 42px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.88rem;
  outline: none;
  transition: all 0.3s var(--ease-out);
  color: var(--text);
}
.search-box input:focus {
  border-color: var(--purple-600);
  background: var(--bg-surface);
  box-shadow: 0 0 0 3px rgba(155,93,229,0.1);
}
.search-box input::placeholder { color: var(--text-faint); }

.header-actions {
  display: flex; align-items: center; gap: 8px;
  margin-left: auto;
}
.header-btn {
  background: none; border: none;
  color: var(--text-secondary); cursor: pointer;
  padding: 8px; border-radius: var(--radius-sm);
  transition: all 0.2s;
  position: relative;
}
.header-btn:hover { color: var(--text); background: var(--glass-hover); }
.header-btn svg { width: 20px; height: 20px; }
.header-btn .notif-dot {
  position: absolute; top: 5px; right: 5px;
  width: 7px; height: 7px;
  background: var(--pink);
  border-radius: 50%;
}

.page-content {
  padding: 28px;
  min-height: calc(100vh - var(--header-h) - var(--player-h));
  animation: fadeIn 0.4s var(--ease-out);
}

/* ═══ SECTION TITLES ═══ */
.section-header {
  display: flex; align-items: baseline; gap: 12px;
  margin-bottom: 20px;
}
.section-title {
  font-family: var(--font-display);
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: -0.3px;
}
.section-subtitle {
  color: var(--text-muted);
  font-size: 0.82rem;
}
.section-action {
  margin-left: auto;
  font-size: 0.8rem;
  color: var(--text-secondary);
  cursor: pointer;
  font-weight: 600;
  transition: color 0.2s;
}
.section-action:hover { color: var(--purple-300); }

/* ═══ HERO BANNER ═══ */
.hero {
  position: relative;
  padding: 48px 36px;
  border-radius: var(--radius-xl);
  overflow: hidden;
  margin-bottom: 36px;
  background: linear-gradient(135deg, var(--purple-900) 0%, var(--bg-card) 50%, rgba(241,91,181,0.1) 100%);
  border: 1px solid var(--border);
}
.hero::before {
  content: '';
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at 30% 50%, rgba(155,93,229,0.15), transparent 60%),
              radial-gradient(ellipse at 80% 80%, rgba(241,91,181,0.08), transparent 50%);
  pointer-events: none;
}
.hero-content { position: relative; z-index: 1; }
.hero-label {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 14px;
  background: rgba(155,93,229,0.15);
  border: 1px solid rgba(155,93,229,0.25);
  border-radius: var(--radius-full);
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--purple-200);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
}
.hero h2 {
  font-family: var(--font-display);
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  line-height: 1.2;
  margin-bottom: 10px;
}
.hero h2 .gradient-text {
  background: linear-gradient(135deg, var(--purple-200), var(--pink), var(--cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.hero p {
  color: var(--text-secondary);
  font-size: 0.92rem;
  max-width: 500px;
  line-height: 1.5;
}
.hero-stats {
  display: flex; gap: 28px;
  margin-top: 24px;
}
.hero-stat {
  display: flex; flex-direction: column;
}
.hero-stat-val {
  font-family: var(--font-display);
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--purple-200);
}
.hero-stat-label {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.hero-999 {
  position: absolute;
  right: 36px; bottom: 20px;
  font-family: var(--font-display);
  font-size: 8rem;
  font-weight: 900;
  color: rgba(155,93,229,0.06);
  line-height: 1;
  letter-spacing: -4px;
  pointer-events: none;
  user-select: none;
}

/* Hero Buttons */
.hero-actions {
  display: flex; gap: 12px;
  margin-top: 20px;
  margin-bottom: 8px;
}
.hero-btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 12px 28px;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.88rem;
  cursor: pointer;
  border: none;
  transition: all 0.25s var(--ease-out);
}
.hero-btn-primary {
  background: linear-gradient(135deg, var(--purple-400), var(--pink));
  color: #fff;
  box-shadow: 0 4px 20px rgba(155,93,229,0.35);
}
.hero-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 28px rgba(155,93,229,0.5);
}
.hero-btn-secondary {
  background: rgba(255,255,255,0.08);
  color: var(--text);
  border: 1px solid var(--border);
}
.hero-btn-secondary:hover {
  background: rgba(255,255,255,0.14);
}

/* Quick Access Cards */
.home-quick-access {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  margin-bottom: 36px;
}
.quick-card {
  display: flex; align-items: center; gap: 14px;
  padding: 18px 20px;
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.25s var(--ease-out);
  border: 1px solid transparent;
}
.quick-card:hover {
  transform: translateY(-2px);
  border-color: var(--border);
}
.qc-icon { font-size: 1.5rem; }
.qc-label {
  font-weight: 700;
  font-size: 0.88rem;
}
.qc-released { background: linear-gradient(135deg, rgba(46,213,115,0.1), rgba(46,213,115,0.02)); }
.qc-released:hover { background: linear-gradient(135deg, rgba(46,213,115,0.18), rgba(46,213,115,0.05)); }
.qc-unreleased { background: linear-gradient(135deg, rgba(155,93,229,0.12), rgba(155,93,229,0.02)); }
.qc-unreleased:hover { background: linear-gradient(135deg, rgba(155,93,229,0.2), rgba(155,93,229,0.05)); }
.qc-vault { background: linear-gradient(135deg, rgba(241,91,181,0.1), rgba(241,91,181,0.02)); }
.qc-vault:hover { background: linear-gradient(135deg, rgba(241,91,181,0.18), rgba(241,91,181,0.05)); }
.qc-sessions { background: linear-gradient(135deg, rgba(72,219,251,0.1), rgba(72,219,251,0.02)); }
.qc-sessions:hover { background: linear-gradient(135deg, rgba(72,219,251,0.18), rgba(72,219,251,0.05)); }

/* Home Carousels */
.home-carousel-wrap {
  position: relative;
  margin-bottom: 36px;
}
.home-carousel {
  display: flex;
  gap: 16px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scrollbar-width: none;
  padding-bottom: 8px;
}
.home-carousel::-webkit-scrollbar { display: none; }
.home-carousel .song-card {
  flex: 0 0 180px;
  scroll-snap-align: start;
}

/* Vault Cards */
.vault-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
}
.vault-card {
  display: flex; align-items: center; gap: 14px;
  padding: 16px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  transition: all 0.2s;
}
.vault-card:hover { border-color: rgba(241,91,181,0.3); background: var(--bg-elevated); }
.vc-lock { font-size: 1.2rem; opacity: 0.5; }
.vc-name { font-weight: 700; font-size: 0.88rem; flex: 1; }
.vc-meta { font-size: 0.75rem; color: var(--text-muted); }
.vc-era {
  font-size: 0.65rem; padding: 2px 8px;
  background: rgba(155,93,229,0.12); color: var(--purple-200);
  border-radius: var(--radius-full);
}

/* Sessions Cards */
.sessions-card {
  padding: 16px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.2s;
}
.sessions-card:hover { border-color: rgba(72,219,251,0.3); background: var(--bg-elevated); }
.sc-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 4px; }
.sc-meta { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; }
.sc-play {
  font-size: 0.72rem; font-weight: 600;
  color: var(--cyan); cursor: pointer;
}

/* ═══ SONG GRID ═══ */
.song-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
}

.song-card {
  background: rgba(19, 19, 32, 0.65);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(155, 93, 229, 0.1);
  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s var(--ease-out);
  position: relative;
  group: true;
}
.song-card:hover {
  transform: translateY(-4px);
  border-color: rgba(155, 93, 229, 0.25);
  box-shadow: 0 8px 32px rgba(155, 93, 229, 0.15), 0 4px 16px rgba(0,0,0,0.3);
  background: rgba(26, 26, 46, 0.8);
}

.song-card-art {
  aspect-ratio: 1;
  position: relative;
  overflow: hidden;
  background: url('/assets/JuiceVaultAlbumCoverPlaceHolder.png') center/cover no-repeat;
  background-color: var(--bg-card);
}
.song-card-art img {
  width: 100%; height: 100%;
  object-fit: cover;
  transition: transform 0.4s var(--ease-out);
}
.song-card:hover .song-card-art img { transform: scale(1.05); }

.song-card-art .art-placeholder {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem;
  background: url('/assets/JuiceVaultAlbumCoverPlaceHolder.png') center/cover no-repeat;
  background-color: var(--bg-card);
}

.song-card-play {
  position: absolute;
  bottom: 10px; right: 10px;
  width: 42px; height: 42px;
  border-radius: 50%;
  background: var(--purple-500);
  display: flex; align-items: center; justify-content: center;
  opacity: 0;
  transform: translateY(8px);
  transition: all 0.3s var(--ease-out);
  box-shadow: 0 4px 16px rgba(155,93,229,0.4);
  border: none;
  cursor: pointer;
}
.song-card-play svg { width: 18px; height: 18px; color: #fff; margin-left: 2px; }
.song-card:hover .song-card-play { opacity: 1; transform: translateY(0); }

/* Unavailable song indicator */
.song-card-unavailable {
  position: absolute;
  bottom: 10px;
  right: 10px;
  padding: 6px 10px;
  background: rgba(0,0,0,0.7);
  border-radius: var(--radius-full);
  font-size: 0.7rem;
  color: var(--text-muted);
  pointer-events: none;
}

.song-card-info { padding: 14px; }
.song-card-name {
  font-weight: 600;
  font-size: 0.88rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}
.song-card-meta {
  font-size: 0.76rem;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* ═══ PLAYLIST DETAIL PAGE ═══ */
.playlist-back-btn {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  margin-bottom: 20px;
  font-size: 0.88rem;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: var(--radius-md);
  transition: all 0.2s;
}
.playlist-back-btn:hover {
  color: var(--text);
  background: var(--glass-hover);
}

.playlist-hero {
  display: flex;
  gap: 32px;
  margin-bottom: 32px;
  padding: 24px;
  background: linear-gradient(135deg, rgba(155,93,229,0.1) 0%, rgba(241,91,181,0.05) 100%);
  border-radius: var(--radius-xl);
  border: 1px solid var(--border);
}

.playlist-hero-art {
  flex-shrink: 0;
}

.playlist-art-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 4px;
  width: 232px;
  height: 232px;
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-lg);
}

.playlist-art-item {
  width: 114px;
  height: 114px;
  overflow: hidden;
  animation: fadeIn 0.5s var(--ease-out) both;
}

.playlist-art-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.playlist-art-placeholder {
  width: 232px;
  height: 232px;
  border-radius: var(--radius-lg);
  background: linear-gradient(135deg, var(--purple-900), var(--bg-card));
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-lg);
  color: var(--purple-300);
}

.playlist-hero-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}

.playlist-type {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.playlist-name {
  font-family: var(--font-display);
  font-size: 2.5rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--text), var(--purple-200));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.playlist-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--text-secondary);
  font-size: 0.9rem;
  margin-bottom: 24px;
}

.playlist-dot {
  color: var(--text-muted);
}

.playlist-hero-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.playlist-play-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 32px;
  background: linear-gradient(135deg, var(--purple-500), var(--pink));
  color: #fff;
  border: none;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.25s var(--ease-out);
  box-shadow: 0 4px 20px rgba(155,93,229,0.35);
}

.playlist-play-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 28px rgba(155,93,229,0.5);
}

.playlist-shuffle-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 12px 24px;
  background: var(--glass);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: var(--radius-full);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.playlist-shuffle-btn:hover {
  background: var(--glass-hover);
  border-color: var(--border-hover);
}

.playlist-like-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--glass);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.playlist-like-btn:hover {
  transform: scale(1.05);
  color: var(--pink);
  border-color: var(--pink);
}

.playlist-like-btn.liked {
  color: var(--pink);
  background: rgba(241,91,181,0.1);
  border-color: var(--pink);
}

.playlist-more-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--glass);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.playlist-more-btn:hover {
  color: var(--text);
  background: var(--glass-hover);
}

.playlist-collaborators {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 16px;
}

.collab-label {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.collab-avatars {
  display: flex;
  gap: -8px;
}

.collab-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--purple-500), var(--pink));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.75rem;
  color: #fff;
  border: 2px solid var(--bg-card);
  margin-left: -8px;
}

.collab-avatar:first-child {
  margin-left: 0;
}

.playlist-toolbar {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
  padding: 0 8px;
}

.playlist-search {
  flex: 1;
  max-width: 320px;
  position: relative;
}

.playlist-search svg {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
}

.playlist-search input {
  width: 100%;
  padding: 10px 12px 10px 40px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  color: var(--text);
  font-size: 0.9rem;
  outline: none;
  transition: all 0.2s;
}

.playlist-search input:focus {
  border-color: var(--purple-500);
  box-shadow: 0 0 0 3px rgba(155,93,229,0.1);
}

.playlist-sort select {
  padding: 10px 36px 10px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text);
  font-size: 0.9rem;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b8ba0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
}

.playlist-songs-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.playlist-songs-header {
  display: grid;
  grid-template-columns: 50px 1fr 150px 120px 70px 80px;
  gap: 12px;
  padding: 12px 20px;
  background: var(--glass);
  border-bottom: 1px solid var(--border);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  font-weight: 600;
}

.playlist-songs-list {
  padding: 8px;
}

.playlist-song-row {
  display: grid;
  grid-template-columns: 30px 20px 50px 1fr 150px 120px 70px 80px;
  gap: 12px;
  align-items: center;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  transition: all 0.15s;
  cursor: pointer;
}

.playlist-song-row:hover {
  background: var(--glass-hover);
}

.playlist-song-row.dragging {
  opacity: 0.5;
  background: var(--purple-800);
}

.pl-song-num {
  color: var(--text-muted);
  font-size: 0.9rem;
  text-align: center;
  font-variant-numeric: tabular-nums;
}

.pl-song-drag-handle {
  color: var(--text-muted);
  cursor: grab;
  opacity: 0;
  transition: opacity 0.2s;
}

.playlist-song-row:hover .pl-song-drag-handle {
  opacity: 1;
}

.pl-song-art {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  position: relative;
}

.pl-song-art img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.pl-song-play {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  border: none;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s;
  cursor: pointer;
}

.playlist-song-row:hover .pl-song-play {
  opacity: 1;
}

.pl-song-info {
  min-width: 0;
}

.pl-song-name {
  font-weight: 600;
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.pl-song-artist {
  font-size: 0.8rem;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.pl-song-album,
.pl-song-date,
.pl-song-duration {
  font-size: 0.8rem;
  color: var(--text-muted);
  white-space: nowrap;
}

.pl-song-duration {
  font-variant-numeric: tabular-nums;
  text-align: right;
}

.pl-song-actions {
  display: flex;
  justify-content: flex-end;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}

.playlist-song-row:hover .pl-song-actions {
  opacity: 1;
}

.pl-action-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px;
  border-radius: var(--radius-sm);
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pl-action-btn:hover {
  color: var(--text);
  background: var(--glass);
}

.pl-action-btn.liked {
  color: var(--pink);
}

.playlist-empty {
  text-align: center;
  padding: 60px 20px;
}

.playlist-empty-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}

.playlist-empty h3 {
  font-family: var(--font-display);
  font-size: 1.3rem;
  margin-bottom: 8px;
}

.playlist-empty p {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.playlist-dropdown {
  position: fixed;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 8px;
  box-shadow: var(--shadow-lg);
  z-index: 100;
  min-width: 180px;
}

.playlist-dropdown button {
  width: 100%;
  text-align: left;
  padding: 10px 12px;
  background: none;
  border: none;
  color: var(--text);
  font-size: 0.9rem;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all 0.15s;
}

.playlist-dropdown button:hover {
  background: var(--glass-hover);
}

.playlist-dropdown button.danger {
  color: var(--red);
}

.playlist-dropdown button.danger:hover {
  background: rgba(255,71,87,0.1);
}

.playlist-error {
  text-align: center;
  padding: 60px 20px;
}

.error-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}

.playlist-comments-section {
  margin-top: 40px;
  padding: 24px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
}

.section-header-v2 {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.section-header-v2 h3 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
}

.comment-count {
  padding: 2px 10px;
  background: var(--glass);
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.comment-input-wrap {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.comment-input-area {
  flex: 1;
  display: flex;
  gap: 12px;
}

.comment-input-area textarea {
  flex: 1;
  padding: 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text);
  font-size: 0.9rem;
  resize: vertical;
  min-height: 60px;
  font-family: inherit;
}

.comment-input-area textarea:focus {
  outline: none;
  border-color: var(--purple-500);
}

.comment-submit-btn {
  padding: 12px 20px;
  background: var(--purple-500);
  border: none;
  border-radius: var(--radius-md);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  align-self: flex-start;
}

.comment-submit-btn:hover {
  background: var(--purple-400);
}

.playlist-comments-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.playlist-comment {
  display: flex;
  gap: 12px;
}

.comment-content {
  flex: 1;
}

.comment-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.comment-author {
  font-weight: 600;
  font-size: 0.9rem;
}

.comment-time {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.comment-text {
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

.no-comments {
  text-align: center;
  color: var(--text-muted);
  font-style: italic;
  padding: 20px;
}

.song-card-badges {
  display: flex; gap: 5px; margin-top: 8px;
}
.song-badge {
  font-size: 0.62rem;
  padding: 2px 7px;
  border-radius: var(--radius-full);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.badge-available { background: rgba(46,213,115,0.12); color: var(--green); }
.badge-lyrics { background: rgba(155,93,229,0.12); color: var(--purple-300); }
.badge-category { background: rgba(255,158,44,0.12); color: var(--orange); }

/* ═══ SONG LIST VIEW ═══ */
.song-list { display: flex; flex-direction: column; gap: 2px; }

.song-row {
  display: grid;
  grid-template-columns: 36px 50px 1fr 140px 80px 60px;
  align-items: center;
  gap: 14px;
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 0.88rem;
}
.song-row:hover { background: var(--glass-hover); }
.song-row.active { background: rgba(155,93,229,0.1); }

.song-row-num {
  color: var(--text-muted);
  font-size: 0.82rem;
  text-align: center;
  font-variant-numeric: tabular-nums;
}
.song-row.active .song-row-num { color: var(--purple-400); }

.song-row-art {
  width: 44px; height: 44px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  background: var(--bg-card);
  flex-shrink: 0;
}
.song-row-art img { width: 100%; height: 100%; object-fit: cover; }
.song-row-art .art-ph {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.1rem;
  background: url('/assets/JuiceVaultAlbumCoverPlaceHolder.png') center/cover no-repeat;
  background-color: var(--bg-card);
}

.song-row-title {
  font-weight: 600;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-row-artist {
  color: var(--text-secondary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  font-size: 0.82rem;
}
.song-row-duration {
  color: var(--text-muted);
  font-size: 0.82rem;
  text-align: right;
  font-variant-numeric: tabular-nums;
}
.song-row-actions {
  display: flex; justify-content: flex-end; gap: 4px;
}
.song-row-btn {
  background: none; border: none;
  color: var(--text-muted); cursor: pointer;
  padding: 4px; border-radius: 4px;
  transition: all 0.15s;
  opacity: 0;
}
.song-row:hover .song-row-btn { opacity: 1; }
.song-row-btn:hover { color: var(--purple-300); }

/* Playing indicator */
.playing-bars {
  display: flex; align-items: flex-end; gap: 2px;
  height: 16px;
}
.playing-bars span {
  width: 3px;
  background: var(--purple-400);
  border-radius: 2px;
  animation: barPulse 1.2s ease-in-out infinite;
}
.playing-bars span:nth-child(1) { animation-delay: 0s; height: 8px; }
.playing-bars span:nth-child(2) { animation-delay: 0.2s; height: 14px; }
.playing-bars span:nth-child(3) { animation-delay: 0.4s; height: 6px; }
.playing-bars span:nth-child(4) { animation-delay: 0.1s; height: 12px; }

/* ═══ SONG DETAIL VIEW ═══ */
.detail-view {
  display: none;
  animation: fadeIn 0.4s var(--ease-out);
}
.detail-view.visible { display: block; }

.detail-header {
  display: flex; gap: 28px;
  margin-bottom: 32px;
}
.detail-art {
  width: 240px; height: 240px;
  border-radius: var(--radius-lg);
  overflow: hidden;
  flex-shrink: 0;
  box-shadow: var(--shadow-lg), 0 0 60px rgba(155,93,229,0.25);
  background: url('/assets/JuiceVaultAlbumCoverPlaceHolder.png') center/cover no-repeat;
  background-color: var(--bg-card);
}
.detail-art img { width: 100%; height: 100%; object-fit: cover; }
.detail-art .art-ph {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 4rem;
}

.detail-info { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; }
.detail-type {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
  margin-bottom: 8px;
}
.detail-name {
  font-family: var(--font-display);
  font-size: 2.4rem;
  font-weight: 800;
  letter-spacing: -0.5px;
  line-height: 1.1;
  margin-bottom: 10px;
}
.detail-artist {
  font-size: 0.95rem;
  color: var(--text-secondary);
  margin-bottom: 16px;
}
.detail-meta {
  display: flex; flex-wrap: wrap; gap: 16px;
  font-size: 0.82rem;
  color: var(--text-muted);
}
.detail-meta span { display: flex; align-items: center; gap: 5px; }

.detail-actions {
  display: flex; gap: 12px;
  margin-top: 20px;
}
.detail-btn {
  padding: 11px 28px;
  border-radius: var(--radius-full);
  font-weight: 700;
  font-size: 0.88rem;
  cursor: pointer;
  transition: all 0.2s var(--ease-out);
  border: none;
  display: flex; align-items: center; gap: 8px;
}
.detail-btn-play {
  background: linear-gradient(135deg, var(--purple-500), var(--pink));
  color: #fff;
  box-shadow: 0 4px 20px rgba(155,93,229,0.35);
}
.detail-btn-play:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(155,93,229,0.5), 0 0 40px rgba(241,91,181,0.2); }
.detail-btn-play svg { width: 18px; height: 18px; }
.detail-btn-queue {
  background: var(--glass-hover);
  border: 1px solid var(--border);
  color: var(--text);
}
.detail-btn-queue:hover { background: var(--glass-active); border-color: var(--border-hover); }

.detail-lyrics {
  margin-top: 36px;
}
.detail-lyrics h3 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px;
}
.lyrics-body {
  white-space: pre-wrap;
  font-size: 0.92rem;
  line-height: 2;
  color: var(--text-secondary);
  max-height: 500px;
  overflow-y: auto;
  padding-right: 16px;
}
.lyrics-body .lyric-line {
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.3s;
  cursor: pointer;
}
.lyrics-body .lyric-line:hover { background: var(--glass-hover); }
.lyrics-body .lyric-line.active {
  color: var(--text);
  background: rgba(155,93,229,0.1);
  font-weight: 600;
}
.lyrics-body .lyric-line.past { opacity: 0.4; }
.no-lyrics {
  color: var(--text-muted);
  font-style: italic;
  padding: 24px;
  text-align: center;
  background: var(--bg-card);
  border-radius: var(--radius-md);
  border: 1px dashed var(--border);
}

.detail-extra {
  margin-top: 32px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}
.detail-extra-card {
  padding: 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
}
.detail-extra-card .dec-label {
  font-size: 0.68rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}
.detail-extra-card .dec-val {
  font-size: 0.92rem;
  font-weight: 600;
}

/* ═══ FILTER BAR / TOOLBAR ═══ */
.toolbar {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filter-chip {
  padding: 7px 16px;
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text-secondary);
  transition: all 0.2s;
}
.filter-chip:hover { background: var(--glass-hover); color: var(--text); }
.filter-chip.active {
  background: var(--purple-800);
  border-color: var(--purple-600);
  color: var(--purple-100);
}
.view-toggle {
  margin-left: auto;
  display: flex; gap: 2px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 3px;
  border: 1px solid var(--border);
}
.view-toggle button {
  background: none; border: none;
  padding: 6px 10px;
  border-radius: 5px;
  cursor: pointer;
  color: var(--text-muted);
  transition: all 0.2s;
}
.view-toggle button.active { background: var(--purple-800); color: var(--text); }
.view-toggle button:hover:not(.active) { color: var(--text-secondary); }
.view-toggle svg { width: 16px; height: 16px; display: block; }

/* ═══ PAGINATION ═══ */
.pagination {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  margin-top: 28px;
  padding: 16px 0;
}
.page-btn {
  padding: 8px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all 0.2s;
}
.page-btn:hover { background: var(--glass-hover); color: var(--text); }
.page-btn.active { background: var(--purple-700); border-color: var(--purple-500); color: #fff; }
.page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.page-info {
  font-size: 0.8rem;
  color: var(--text-muted);
  padding: 0 8px;
}

/* ═══ PLAYER BAR ═══ */
.player {
  height: var(--player-h);
  background: rgba(10, 10, 20, 0.85);
  backdrop-filter: blur(24px) saturate(1.3);
  -webkit-backdrop-filter: blur(24px) saturate(1.3);
  border-top: 1px solid rgba(155, 93, 229, 0.15);
  display: grid;
  grid-template-columns: 1fr 2fr 1fr;
  align-items: center;
  padding: 0 20px;
  z-index: 30;
  position: relative;
}

.player-left {
  display: flex; align-items: center; gap: 14px;
  min-width: 0;
}
.player-art {
  width: 56px; height: 56px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  flex-shrink: 0;
  background: var(--bg-card);
  cursor: pointer;
}
.player-art img { width: 100%; height: 100%; object-fit: cover; }
.player-art .pa-ph {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
  background: url('/assets/JuiceVaultAlbumCoverPlaceHolder.png') center/cover no-repeat;
  background-color: var(--bg-card);
}
.player-song-info { min-width: 0; }
.player-song-name {
  font-weight: 600;
  font-size: 0.88rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  cursor: pointer;
}
.player-song-name:hover { text-decoration: underline; }
.player-song-artist {
  font-size: 0.76rem;
  color: var(--text-muted);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.player-center {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.player-controls {
  display: flex; align-items: center; gap: 16px;
}
.p-btn {
  background: none; border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 6px;
  border-radius: var(--radius-full);
  transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.p-btn:hover { color: var(--text); }
.p-btn.active { color: var(--purple-300); }
.p-btn svg { width: 18px; height: 18px; }

.p-btn.player-like-btn { color: var(--pink); }
.p-btn.player-like-btn.liked { color: var(--pink); }
.p-btn.player-like-btn svg { fill: none; }
.p-btn.player-like-btn.liked svg { fill: currentColor; }
.p-btn.player-playlist-btn:hover { color: var(--purple-300); }

.p-btn-play {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, var(--purple-400), var(--pink));
  color: #fff !important;
  border-radius: 50%;
  box-shadow: 0 0 20px rgba(155, 93, 229, 0.3);
}
.p-btn-play:hover { transform: scale(1.06); background: linear-gradient(135deg, var(--purple-300), var(--pink)); box-shadow: 0 0 28px rgba(155, 93, 229, 0.45); }
.p-btn-play svg { width: 18px; height: 18px; }

.player-progress {
  display: flex; align-items: center; gap: 10px;
  width: 100%; max-width: 600px;
}
.player-time {
  font-size: 0.72rem;
  color: var(--text-muted);
  font-variant-numeric: tabular-nums;
  min-width: 38px;
  text-align: center;
  font-family: var(--font-mono);
}
.progress-bar {
  flex: 1;
  height: 4px;
  background: var(--bg-card);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
  transition: height 0.15s;
}
.progress-bar:hover { height: 6px; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--purple-500), var(--purple-300), var(--pink));
  border-radius: 2px;
  width: 0%;
  position: relative;
  transition: background 0.2s;
}
.progress-bar:hover .progress-fill { background: linear-gradient(90deg, var(--purple-400), var(--pink)); }
.progress-fill::after {
  content: '';
  position: absolute;
  right: -5px; top: 50%;
  transform: translateY(-50%) scale(0);
  width: 12px; height: 12px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: transform 0.15s;
}
.progress-bar:hover .progress-fill::after { transform: translateY(-50%) scale(1); }

.player-right {
  display: flex; align-items: center; justify-content: flex-end; gap: 10px;
}
.volume-wrap {
  display: flex; align-items: center; gap: 6px;
}
.volume-bar {
  width: 90px; height: 4px;
  background: var(--bg-card);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}
.volume-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--purple-400), var(--purple-300));
  border-radius: 2px;
  width: 70%;
}

/* ═══ QUEUE PANEL ═══ */
.queue-panel {
  position: fixed;
  top: 0; right: 0; bottom: var(--player-h);
  width: 360px;
  background: var(--bg-raised);
  border-left: 1px solid var(--border);
  z-index: 25;
  display: flex; flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.35s var(--ease-out);
}
.queue-panel.open { transform: none; }

.queue-header {
  padding: 20px;
  display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.queue-header h3 {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
}
.queue-close {
  background: none; border: none;
  color: var(--text-muted); cursor: pointer;
  padding: 6px; border-radius: var(--radius-sm);
}
.queue-close:hover { color: var(--text); }

.queue-body {
  flex: 1; overflow-y: auto;
  padding: 12px;
}
.queue-section-title {
  font-size: 0.68rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: 8px 8px 4px;
  font-weight: 700;
}
.queue-item {
  display: flex; align-items: center; gap: 12px;
  padding: 8px;
  border-radius: var(--radius-sm);
  transition: background 0.15s;
}
.queue-item:hover { background: var(--glass-hover); }
.queue-item.now-playing { background: rgba(155,93,229,0.1); }
.qi-art {
  width: 40px; height: 40px;
  border-radius: 6px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--bg-card);
}
.qi-art img { width: 100%; height: 100%; object-fit: cover; }
.qi-art .qi-ph {
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.9rem;
  background: linear-gradient(135deg, var(--purple-900), var(--bg-card));
}
.qi-info { flex: 1; min-width: 0; }
.qi-name { font-size: 0.84rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.qi-artist { font-size: 0.72rem; color: var(--text-muted); }
.qi-remove {
  background: none; border: none;
  color: var(--text-muted); cursor: pointer;
  padding: 4px; border-radius: 4px;
  opacity: 0; transition: all 0.15s;
}
.queue-item:hover .qi-remove { opacity: 1; }
.qi-remove:hover { color: var(--red); }

.queue-empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-muted);
  font-size: 0.88rem;
}

/* ═══════════════════════════════════════════════════════
   FULLSCREEN LYRICS V3 — Cinematic Redesign
   ═══════════════════════════════════════════════════════ */

/* ═══ Core Layout ═══ */
.fs-lyrics {
  position: fixed; inset: 0;
  z-index: 100;
  display: none;
  flex-direction: column;
  background: var(--bg-deep);
  overflow: hidden;
}
.fs-lyrics.open { display: flex; }

/* ═══ Cinematic Animated Background ═══ */
.fs-bg {
  position: absolute; inset: 0;
  overflow: hidden;
}
.fs-bg-img {
  position: absolute; inset: -60px;
  background-size: cover;
  background-position: center;
  filter: blur(80px) saturate(0.6) brightness(0.2);
  transform: scale(1.2);
  animation: bgPulse 20s ease-in-out infinite, bgZoom 30s ease-in-out infinite;
}
@keyframes bgPulse {
  0%, 100% { filter: blur(80px) saturate(0.6) brightness(0.2); }
  50% { filter: blur(100px) saturate(0.8) brightness(0.25); }
}
@keyframes bgZoom {
  0%, 100% { transform: scale(1.2); }
  50% { transform: scale(1.35); }
}
.fs-bg-overlay {
  position: absolute; inset: 0;
  background: 
    radial-gradient(ellipse at 20% 20%, rgba(155,93,229,0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(241,91,181,0.1) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 50%, rgba(0,245,212,0.05) 0%, transparent 60%),
    rgba(5,5,8,0.7);
  animation: gradientShift 15s ease infinite;
  background-size: 400% 400%;
}
.fs-gradient-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.4;
  pointer-events: none;
}
.fs-orb-1 {
  width: 600px; height: 600px;
  background: radial-gradient(circle, var(--purple-600) 0%, transparent 70%);
  top: -20%; left: -10%;
  animation: orbFloat1 25s ease-in-out infinite;
}
.fs-orb-2 {
  width: 500px; height: 500px;
  background: radial-gradient(circle, var(--pink) 0%, transparent 70%);
  bottom: -25%; right: -10%;
  animation: orbFloat2 30s ease-in-out infinite;
}
.fs-orb-3 {
  width: 400px; height: 400px;
  background: radial-gradient(circle, var(--cyan) 0%, transparent 70%);
  top: 50%; right: 30%;
  animation: orbFloat3 20s ease-in-out infinite;
  opacity: 0.2;
}
@keyframes orbFloat1 {
  0%, 100% { transform: translate(0,0) scale(1); }
  33% { transform: translate(80px,-40px) scale(1.1); }
  66% { transform: translate(-40px,60px) scale(0.9); }
}
@keyframes orbFloat2 {
  0%, 100% { transform: translate(0,0) scale(1); }
  33% { transform: translate(-60px,50px) scale(0.95); }
  66% { transform: translate(40px,-30px) scale(1.05); }
}
@keyframes orbFloat3 {
  0%, 100% { transform: translate(0,0) scale(1); }
  50% { transform: translate(30px,-30px) scale(1.08); }
}

/* ═══ Glassmorphism Header ═══ */
.fs-header {
  position: relative; z-index: 10;
  display: flex; align-items: center; gap: 16px;
  padding: 16px 24px;
  background: rgba(10,10,16,0.4);
  backdrop-filter: blur(20px) saturate(1.5);
  -webkit-backdrop-filter: blur(20px) saturate(1.5);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.fs-close {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  cursor: pointer;
  width: 38px; height: 38px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: var(--text);
  transition: all 0.25s var(--ease-out);
  flex-shrink: 0;
}
.fs-close:hover { 
  background: rgba(255,255,255,0.12); 
  border-color: rgba(255,255,255,0.2);
  transform: scale(1.05);
}
.fs-close:active { transform: scale(0.95); }

/* 3D Tilt Album Art */
.fs-song-info { 
  display: flex; align-items: center; gap: 14px; 
  flex: 1;
  min-width: 0;
}
.fs-art-wrap {
  perspective: 1000px;
  flex-shrink: 0;
}
.fs-art {
  width: 52px; height: 52px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
  transition: transform 0.3s var(--ease-out), box-shadow 0.3s;
  transform-style: preserve-3d;
}
.fs-art:hover {
  transform: rotateY(-8deg) rotateX(5deg) scale(1.05);
  box-shadow: 0 12px 40px rgba(155,93,229,0.3), 0 0 0 1px rgba(155,93,229,0.3);
}
.fs-art img { width: 100%; height: 100%; object-fit: cover; }
.fs-song-meta { min-width: 0; }
.fs-song-name { 
  font-weight: 700; 
  font-size: 0.95rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.fs-song-artist { 
  font-size: 0.8rem; 
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Header Tools */
.fs-header-tools {
  display: flex; gap: 8px;
  align-items: center;
}
.fs-tool-btn {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  cursor: pointer;
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-secondary);
  transition: all 0.25s var(--ease-out);
  position: relative;
}
.fs-tool-btn:hover { 
  background: rgba(255,255,255,0.12); 
  border-color: rgba(255,255,255,0.2);
  color: #fff;
  transform: translateY(-2px);
}
.fs-tool-btn.active {
  background: rgba(155,93,229,0.25);
  border-color: rgba(155,93,229,0.4);
  color: var(--purple-200);
}
.fs-tool-btn .tool-tooltip {
  position: absolute;
  bottom: -28px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  font-size: 0.65rem;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  z-index: 100;
}
.fs-tool-btn:hover .tool-tooltip { opacity: 1; }

/* Display Mode Selector */
.fs-mode-selector {
  display: flex;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: var(--radius-full);
  padding: 3px;
  gap: 2px;
}
.fs-mode-btn {
  background: transparent;
  border: none;
  color: var(--text-muted);
  padding: 6px 12px;
  border-radius: var(--radius-full);
  font-size: 0.72rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.fs-mode-btn:hover { color: var(--text); }
.fs-mode-btn.active {
  background: rgba(155,93,229,0.3);
  color: var(--purple-100);
}

/* ═══ Main Content Area ═══ */
.fs-content {
  flex: 1;
  display: flex;
  overflow: hidden;
  position: relative;
}

/* ═══ Lyrics Body ═══ */
.fs-body {
  flex: 1;
  overflow-y: auto;
  display: flex; flex-direction: column;
  align-items: center;
  padding: 20px 40px;
  scroll-behavior: smooth;
  position: relative;
}
.fs-body::before { content: ''; flex: 0 0 30vh; }
.fs-body::after { content: ''; flex: 0 0 30vh; }

/* ═══ Info Panel (Collapsible Sidebar) ═══ */
.fs-info-panel {
  width: 320px;
  background: rgba(10,10,16,0.5);
  backdrop-filter: blur(30px) saturate(1.5);
  -webkit-backdrop-filter: blur(30px) saturate(1.5);
  border-left: 1px solid rgba(255,255,255,0.06);
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.35s var(--ease-out);
  overflow-y: auto;
}
.fs-info-panel.open { transform: translateX(0); }
.fs-info-header {
  padding: 20px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.fs-info-header h3 {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
}
.fs-info-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px;
  border-radius: var(--radius-sm);
  transition: all 0.2s;
}
.fs-info-close:hover { color: var(--text); background: rgba(255,255,255,0.06); }

.fs-info-content {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}
.fs-info-section {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--radius-lg);
  padding: 16px;
}
.fs-info-section h4 {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
  font-weight: 700;
}
.fs-info-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  font-size: 0.85rem;
}
.fs-info-item:last-child { border-bottom: none; }
.fs-info-label { color: var(--text-secondary); }
.fs-info-value { color: var(--text); font-weight: 500; }

.fs-related-song {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
}
.fs-related-song:hover { background: rgba(255,255,255,0.06); }
.fs-related-art {
  width: 44px; height: 44px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  background: var(--bg-card);
}
.fs-related-art img { width: 100%; height: 100%; object-fit: cover; }
.fs-related-info { flex: 1; min-width: 0; }
.fs-related-name {
  font-weight: 600;
  font-size: 0.85rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.fs-related-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* ═══ Lyrics Settings Panel ═══ */
.fs-settings-panel {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 280px;
  background: rgba(10,10,16,0.85);
  backdrop-filter: blur(30px) saturate(1.5);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-lg);
  padding: 20px;
  z-index: 50;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: all 0.25s var(--ease-out);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}
.fs-settings-panel.open {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}
.fs-settings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.fs-settings-header h4 {
  font-family: var(--font-display);
  font-size: 0.9rem;
  font-weight: 700;
}
.fs-settings-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
}
.fs-settings-close:hover { color: var(--text); }

.fs-setting-row {
  margin-bottom: 16px;
}
.fs-setting-row label {
  display: block;
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 500;
}
.fs-font-size-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}
.fs-font-btn {
  width: 32px; height: 32px;
  border-radius: var(--radius-sm);
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  transition: all 0.2s;
}
.fs-font-btn:hover { background: rgba(255,255,255,0.12); }
.fs-font-value {
  font-size: 0.85rem;
  font-weight: 600;
  min-width: 50px;
  text-align: center;
}

.fs-theme-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}
.fs-theme-option {
  aspect-ratio: 1;
  border-radius: var(--radius-md);
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  position: relative;
}
.fs-theme-option:hover { transform: scale(1.05); }
.fs-theme-option.active { border-color: var(--purple-400); }
.fs-theme-option.active::after {
  content: '✓';
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: 700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
.fs-theme-dark { background: linear-gradient(135deg, #0a0a10, #1a1a2e); }
.fs-theme-light { background: linear-gradient(135deg, #f5f5f7, #e8e8ed); }
.fs-theme-purple { background: linear-gradient(135deg, #2a1145, #5e2599); }
.fs-theme-pink { background: linear-gradient(135deg, #2a0a1a, #8b2d5c); }
.fs-theme-cyan { background: linear-gradient(135deg, #0a1a1a, #1a5e5e); }
.fs-theme-orange { background: linear-gradient(135deg, #1a120a, #8b5a2d); }
.fs-theme-red { background: linear-gradient(135deg, #1a0a0a, #8b2d2d); }
.fs-theme-green { background: linear-gradient(135deg, #0a1a0a, #2d8b2d); }

.fs-align-options {
  display: flex;
  gap: 8px;
}
.fs-align-btn {
  flex: 1;
  padding: 8px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.fs-align-btn:hover { color: var(--text); }
.fs-align-btn.active {
  background: rgba(155,93,229,0.2);
  border-color: rgba(155,93,229,0.4);
  color: var(--purple-200);
}

.fs-spacing-slider {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
}
.fs-spacing-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  background: var(--purple-400);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(155,93,229,0.4);
}

/* ═══ Accessibility Options ═══ */
.fs-accessibility-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.fs-toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
}
.fs-toggle-row span {
  font-size: 0.8rem;
  color: var(--text-secondary);
}
.fs-toggle {
  width: 44px;
  height: 24px;
  background: rgba(255,255,255,0.1);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: all 0.3s;
}
.fs-toggle.active {
  background: var(--purple-500);
}
.fs-toggle::after {
  content: '';
  position: absolute;
  width: 20px; height: 20px;
  background: #fff;
  border-radius: 50%;
  top: 2px; left: 2px;
  transition: transform 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.fs-toggle.active::after {
  transform: translateX(20px);
}

/* ═══ Offset Bar (Enhanced) ═══ */
.fs-offset-bar {
  position: relative; z-index: 10;
  display: none;
  align-items: center;
  gap: 12px;
  padding: 12px 24px;
  font-size: 0.75rem;
  color: var(--text-muted);
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.fs-offset-bar.show { display: flex; }
.fs-offset-bar label { 
  font-weight: 600; 
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
}
.fs-offset-slider-wrap {
  flex: 1;
  max-width: 300px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.fs-offset-bar input[type=range] {
  flex: 1;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  outline: none;
  -webkit-appearance: none;
}
.fs-offset-bar input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px; height: 14px;
  background: var(--purple-400);
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(155,93,229,0.4);
}
.fs-offset-val {
  font-family: var(--font-mono);
  min-width: 60px;
  text-align: center;
  background: rgba(155,93,229,0.15);
  padding: 4px 10px;
  border-radius: var(--radius-sm);
  color: var(--purple-200);
  font-weight: 600;
}
.fs-offset-actions {
  display: flex;
  gap: 8px;
}
.fs-offset-bar button {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-secondary);
  padding: 5px 12px;
  border-radius: var(--radius-full);
  font-size: 0.7rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.fs-offset-bar button:hover { 
  background: rgba(255,255,255,0.12); 
  color: var(--text);
}

/* ═══ Social Share Panel ═══ */
.fs-share-panel {
  position: absolute;
  bottom: 140px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(10,10,16,0.95);
  backdrop-filter: blur(30px);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-xl);
  padding: 24px;
  z-index: 60;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s var(--ease-out);
  min-width: 300px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.6);
}
.fs-share-panel.open {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(-50%) translateY(0);
}
.fs-share-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.fs-share-header h4 {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
}
.fs-share-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
}
.fs-share-close:hover { color: var(--text); }
.fs-share-preview {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 16px;
}
.fs-share-line {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text);
  line-height: 1.5;
  font-style: italic;
}
.fs-share-song {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 8px;
}
.fs-share-actions {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.fs-share-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 12px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: var(--radius-md);
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.75rem;
}
.fs-share-btn:hover {
  background: rgba(155,93,229,0.2);
  border-color: rgba(155,93,229,0.4);
  transform: translateY(-2px);
}
.fs-share-btn svg {
  width: 20px; height: 20px;
}

/* QR Code Modal */
.fs-qr-modal {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.8);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 70;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
.fs-qr-modal.open {
  opacity: 1;
  pointer-events: auto;
}
.fs-qr-content {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 32px;
  text-align: center;
  max-width: 320px;
}
.fs-qr-code {
  width: 200px; height: 200px;
  background: #fff;
  border-radius: var(--radius-md);
  margin: 0 auto 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  color: #000;
  position: relative;
  overflow: hidden;
}
.fs-qr-placeholder {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 4px;
  padding: 20px;
}
.fs-qr-dot {
  width: 24px; height: 24px;
  background: #000;
  border-radius: 2px;
}
.fs-qr-dot.empty { background: transparent; }

/* ═══ Player Bar (Enhanced) ═══ */
.fs-player-bar {
  position: relative; z-index: 10;
  padding: 16px 32px 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: linear-gradient(to top, rgba(5,5,8,0.95) 0%, rgba(5,5,8,0.7) 60%, transparent 100%);
  border-top: 1px solid rgba(255,255,255,0.05);
}

.fs-player-main {
  display: flex;
  align-items: center;
  gap: 32px;
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
}

/* Playback Speed Control */
.fs-speed-control {
  display: flex;
  align-items: center;
  gap: 8px;
}
.fs-speed-btn {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-secondary);
  padding: 6px 10px;
  border-radius: var(--radius-sm);
  font-size: 0.7rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.fs-speed-btn:hover { color: var(--text); background: rgba(255,255,255,0.1); }
.fs-speed-btn.active {
  background: rgba(155,93,229,0.3);
  border-color: rgba(155,93,229,0.5);
  color: var(--purple-200);
}

/* A-B Repeat */
.fs-ab-repeat {
  display: flex;
  align-items: center;
  gap: 6px;
}
.fs-ab-btn {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text-secondary);
  width: 28px; height: 28px;
  border-radius: var(--radius-sm);
  font-size: 0.65rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.fs-ab-btn:hover { color: var(--text); background: rgba(255,255,255,0.1); }
.fs-ab-btn.active {
  background: rgba(46,213,115,0.25);
  border-color: rgba(46,213,115,0.5);
  color: var(--green);
}
.fs-ab-btn.set {
  background: rgba(255,158,44,0.25);
  border-color: rgba(255,158,44,0.5);
  color: var(--orange);
}

/* Sleep Timer */
.fs-sleep-timer {
  display: flex;
  align-items: center;
  gap: 8px;
}
.fs-sleep-select {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  color: var(--text);
  padding: 6px 24px 6px 10px;
  border-radius: var(--radius-sm);
  font-size: 0.7rem;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%238b8ba0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 6px center;
}

.fs-player-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}
.fs-progress-row {
  width: 100%;
  max-width: 600px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.fs-time {
  font-size: 0.72rem;
  font-family: var(--font-mono);
  color: var(--text-muted);
  min-width: 40px;
  text-align: center;
}
.fs-progress {
  flex: 1; height: 5px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  transition: height 0.15s;
  overflow: hidden;
}
.fs-progress:hover { height: 7px; }
.fs-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--purple-400), var(--pink));
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s linear;
  position: relative;
}
.fs-progress-fill::after {
  content: '';
  position: absolute;
  right: 0; top: 0; bottom: 0;
  width: 20px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
}
.fs-transport {
  display: flex; align-items: center; gap: 20px;
}
.fs-tbtn {
  background: none; border: none;
  color: rgba(255,255,255,0.7);
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.25s var(--ease-out);
}
.fs-tbtn:hover { 
  color: #fff; 
  background: rgba(255,255,255,0.08);
  transform: scale(1.1);
}
.fs-tbtn svg { width: 22px; height: 22px; }
.fs-tbtn-play {
  width: 56px; height: 56px;
  background: linear-gradient(135deg, rgba(155,93,229,0.3), rgba(241,91,181,0.2));
  border: 1px solid rgba(255,255,255,0.15);
  color: #fff;
  border-radius: 50%;
  box-shadow: 0 4px 20px rgba(155,93,229,0.3);
}
.fs-tbtn-play:hover {
  background: linear-gradient(135deg, rgba(155,93,229,0.5), rgba(241,91,181,0.3));
  box-shadow: 0 6px 28px rgba(155,93,229,0.4);
  transform: scale(1.08);
}
.fs-tbtn-play svg { width: 26px; height: 26px; }

.fs-player-right {
  display: flex;
  align-items: center;
  gap: 16px;
  min-width: 200px;
  justify-content: flex-end;
}
.fs-volume-wrap {
  display: flex;
  align-items: center;
  gap: 10px;
}
.fs-volume-slider {
  width: 100px;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}
.fs-volume-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--purple-400), var(--pink));
  border-radius: 2px;
  width: 70%;
}

.fs-upnext {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-align: center;
  min-height: 16px;
}

/* ═══ Pin Notification ═══ */
.fs-pin-toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-20px);
  background: rgba(10,10,16,0.95);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(155,93,229,0.3);
  border-radius: var(--radius-lg);
  padding: 14px 24px;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s var(--ease-out);
}
.fs-pin-toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.fs-pin-toast svg {
  color: var(--purple-400);
}

/* ═══ Copy Feedback ═══ */
.fs-copy-feedback {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: rgba(10,10,16,0.95);
  backdrop-filter: blur(30px);
  border: 1px solid rgba(46,213,115,0.3);
  border-radius: var(--radius-xl);
  padding: 32px 48px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  z-index: 200;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s var(--ease-out);
}
.fs-copy-feedback.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
.fs-copy-feedback svg {
  color: var(--green);
  width: 40px; height: 40px;
}
.fs-copy-feedback span {
  font-weight: 600;
  color: var(--text);
}

/* ═══ Responsive ═══ */
@media (max-width: 1024px) {
  .fs-info-panel { width: 280px; }
  .fs-settings-panel { right: 10px; width: 260px; }
}
@media (max-width: 768px) {
  .fs-info-panel {
    position: absolute;
    inset: 0;
    width: 100%;
    z-index: 40;
    background: rgba(5,5,8,0.98);
  }
  .fs-body { padding: 20px; }
  .fs-player-main {
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
  }
  .fs-player-center { order: -1; width: 100%; }
  .fs-player-right { min-width: auto; }
  .fs-header-tools .fs-mode-selector { display: none; }
}

/* ═══ ADMIN DASHBOARD ═══ */
.admin-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}
.stat-card {
  padding: 22px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  position: relative;
  overflow: hidden;
}
.stat-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 3px;
  border-radius: 3px 3px 0 0;
}
.stat-card.purple::before { background: var(--purple-400); }
.stat-card.pink::before { background: var(--pink); }
.stat-card.cyan::before { background: var(--cyan); }
.stat-card.orange::before { background: var(--orange); }
.stat-card.green::before { background: var(--green); }

.stat-label {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 8px;
}
.stat-value {
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 800;
}
.stat-sub {
  font-size: 0.76rem;
  color: var(--text-muted);
  margin-top: 4px;
}

.admin-section {
  margin-bottom: 32px;
}
.admin-section h3 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
}
.admin-table th {
  text-align: left;
  padding: 10px 14px;
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}
.admin-table td {
  padding: 10px 14px;
  font-size: 0.88rem;
  border-bottom: 1px solid var(--border);
}
.admin-table tr:hover td { background: var(--glass); }

.admin-actions {
  display: flex; gap: 6px;
}
.admin-btn {
  padding: 5px 12px;
  font-size: 0.76rem;
  font-weight: 600;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.admin-btn:hover { background: var(--glass-hover); color: var(--text); }
.admin-btn.danger { border-color: rgba(255,71,87,0.2); color: var(--red); }
.admin-btn.danger:hover { background: rgba(255,71,87,0.1); }

.invite-gen {
  display: flex; gap: 10px; margin-bottom: 16px;
}
.invite-gen input {
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.88rem;
  width: 100px;
  outline: none;
}
.invite-gen input:focus { border-color: var(--purple-500); }
.invite-code {
  font-family: var(--font-mono);
  font-weight: 600;
  color: var(--purple-300);
  letter-spacing: 0.5px;
}

/* ═══ TOAST ═══ */
.toast-container {
  position: fixed; bottom: calc(var(--player-h) + 16px); right: 16px;
  z-index: 200;
  display: flex; flex-direction: column-reverse; gap: 8px;
}
.toast {
  padding: 12px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 0.86rem;
  animation: slideUp 0.3s var(--ease-out);
  box-shadow: var(--shadow-md);
  max-width: 360px;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--purple-400); }

/* ═══ LOADING ═══ */
.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 40px; color: var(--text-muted);
}
.spinner {
  width: 28px; height: 28px;
  border: 3px solid var(--border);
  border-top-color: var(--purple-400);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
.skeleton {
  background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%);
  background-size: 400% 100%;
  animation: shimmer 1.5s ease-in-out infinite;
  border-radius: var(--radius-sm);
}

/* ═══ EMPTY STATES ═══ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
}
.empty-state .es-icon {
  font-size: 3rem;
  margin-bottom: 16px;
  opacity: 0.5;
}
.empty-state h3 {
  font-family: var(--font-display);
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 8px;
}
.empty-state p {
  color: var(--text-muted);
  font-size: 0.88rem;
  max-width: 400px;
  margin: 0 auto;
}

/* ═══ RESPONSIVE ═══ */
@media (max-width: 900px) {
  .sidebar { width: 64px; }
  .sidebar .sb-text, .nav-item span, .nav-section-title, .su-info, .su-logout, .nav-badge { display: none; }
  .sidebar-brand { justify-content: center; padding: 16px 8px; }
  .nav-item { justify-content: center; padding: 12px; }
  .sidebar-user { justify-content: center; padding: 12px; }
  .song-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 14px; }
  .hero h2 { font-size: 1.6rem; }
  .hero-999 { font-size: 5rem; }
  .home-quick-access { grid-template-columns: repeat(2, 1fr); }
  .detail-header { flex-direction: column; align-items: center; text-align: center; }
  .detail-art { width: 200px; height: 200px; }
  .detail-name { font-size: 1.8rem; }
  .song-row { grid-template-columns: 30px 40px 1fr 70px; }
  .song-row-artist, .song-row-actions { display: none; }
  .queue-panel { width: 100%; }
  .fs-line { font-size: 1.4rem; }
  .fs-line.active { font-size: 1.4rem; }
  .fs-body { padding: 20px 16px; }
  .fs-player-bar { padding: 12px 16px 18px; }
  .fs-tbtn-play { width: 44px; height: 44px; }
  .vault-grid { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
  .page-content { padding: 16px; }
  .main-header { padding: 0 16px; }
  .player { grid-template-columns: 1fr 1fr; padding: 0 12px; }
  .player-center { display: none; }
  .hero { padding: 28px 20px; }
  .hero-stats { gap: 16px; }
  .hero-actions { flex-direction: column; gap: 8px; }
  .hero-btn { justify-content: center; padding: 10px 20px; font-size: 0.82rem; }
  .home-quick-access { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .quick-card { padding: 14px 16px; }
  .home-carousel .song-card { flex: 0 0 150px; }
}

/* ═══ HIDE/SHOW CLASSES ═══ */
.hidden { display: none !important; }
.page { display: none; }
.page.active { display: block; animation: fadeIn 0.35s var(--ease-out); }

/* ═══ VAULT & SESSIONS PAGES ═══ */
.vault-header {
  text-align: center;
  padding: 40px 20px 30px;
  position: relative;
}
.vault-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, rgba(155,93,229,0.08) 0%, transparent 70%);
  pointer-events: none;
}
.vault-icon {
  font-size: 3rem;
  margin-bottom: 12px;
  filter: grayscale(0.3);
}
.vault-header h2 {
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--purple-300), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}
.vault-header p {
  color: var(--text-muted);
  font-size: 0.85rem;
  max-width: 500px;
  margin: 0 auto;
  line-height: 1.5;
}
.vault-count {
  display: inline-block;
  margin-top: 12px;
  padding: 4px 14px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}
.vault-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  padding: 0 20px 20px;
}
.vault-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  transition: all 0.2s var(--ease-out);
  cursor: default;
}
.vault-card:hover {
  background: var(--bg-card-hover);
  border-color: var(--border-hover);
}
.vault-card .vc-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 6px;
  color: var(--text);
}
.vault-card .vc-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.4;
}
.vault-card .vc-era {
  display: inline-block;
  padding: 2px 8px;
  background: rgba(155,93,229,0.1);
  border-radius: var(--radius-full);
  font-size: 0.7rem;
  color: var(--purple-300);
  margin-top: 8px;
}
.vault-card .vc-lock {
  float: right;
  opacity: 0.3;
  font-size: 0.8rem;
}
.sessions-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  transition: all 0.2s var(--ease-out);
  cursor: pointer;
}
.sessions-card:hover {
  background: var(--bg-card-hover);
  border-color: var(--border-accent);
  transform: translateY(-2px);
}
.sessions-card .sc-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 4px;
}
.sessions-card .sc-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
}
.sessions-card .sc-play {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
  padding: 3px 10px;
  background: rgba(155,93,229,0.15);
  border-radius: var(--radius-full);
  font-size: 0.7rem;
  color: var(--purple-300);
}

/* Timed Lyrics - See V2 CSS below */
.lyrics-sync-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: var(--radius-full);
  font-size: 0.65rem;
  font-family: var(--font-mono);
  background: rgba(46,213,115,0.1);
  color: var(--green);
  border: 1px solid rgba(46,213,115,0.2);
}
.lyrics-sync-badge.unsynced {
  background: rgba(255,158,44,0.1);
  color: var(--orange);
  border-color: rgba(255,158,44,0.2);
}


/* ═══════════════════════════════════════════════════════
   LYRICS LINES V3 — Enhanced Typography & Animations
   ═══════════════════════════════════════════════════════ */

/* Base Line Styles */
.fs-line {
  font-family: var(--font-display);
  font-size: var(--lyrics-font-size, 2.2rem);
  font-weight: 700;
  line-height: var(--lyrics-line-height, 1.7);
  text-align: var(--lyrics-align, center);
  padding: 14px 20px;
  margin: var(--lyrics-spacing, 12px) 0;
  border-radius: 12px;
  opacity: 0.12;
  cursor: pointer;
  max-width: 900px;
  transition: 
    opacity 0.5s var(--ease-out),
    color 0.5s var(--ease-out),
    text-shadow 0.5s var(--ease-out),
    transform 0.4s var(--ease-out),
    background 0.3s;
  will-change: opacity, color, transform;
  min-height: 60px;
  display: flex;
  align-items: center;
  justify-content: var(--lyrics-justify, center);
  position: relative;
  user-select: text;
  -webkit-user-select: text;
}

/* Hover Effects */
.fs-line:hover { 
  opacity: 0.4;
  background: rgba(255,255,255,0.03);
}

/* Active Line - Premium Glow Effect */
.fs-line.active {
  opacity: 1;
  color: #fff;
  transform: scale(1.02);
  text-shadow: 
    0 0 40px rgba(155,93,229,0.6),
    0 0 80px rgba(155,93,229,0.3),
    0 0 120px rgba(155,93,229,0.15);
  animation: linePulse 3s ease-in-out infinite;
}
@keyframes linePulse {
  0%, 100% { 
    text-shadow: 
      0 0 40px rgba(155,93,229,0.6),
      0 0 80px rgba(155,93,229,0.3),
      0 0 120px rgba(155,93,229,0.15);
  }
  50% { 
    text-shadow: 
      0 0 50px rgba(155,93,229,0.8),
      0 0 100px rgba(155,93,229,0.4),
      0 0 150px rgba(155,93,229,0.2);
  }
}

/* Past Lines */
.fs-line.past { 
  opacity: 0.18;
  color: var(--text-secondary);
}

/* Upcoming Lines */
.fs-line.upcoming { 
  opacity: 0.35;
  color: var(--text);
}

/* Timed Lyrics Specific */
.fs-line.timed { cursor: pointer; }
.fs-line.timed:hover { 
  opacity: 0.5;
  background: rgba(155,93,229,0.08);
}
.fs-line.timed.active {
  color: #fff;
  opacity: 1;
  text-shadow: 
    0 0 50px rgba(155,93,229,0.7),
    0 0 100px rgba(155,93,229,0.35),
    0 0 150px rgba(155,93,229,0.2);
}
.fs-line.timed.past { opacity: 0.18; }
.fs-line.timed.upcoming { opacity: 0.4; }

/* Pinned Line */
.fs-line.pinned {
  background: rgba(155,93,229,0.12);
  border: 1px solid rgba(155,93,229,0.25);
}
.fs-line.pinned::before {
  content: '📌';
  position: absolute;
  left: -30px;
  font-size: 0.9rem;
  opacity: 0.7;
}

/* Karaoke Mode - Word by Word Highlight */
.fs-line.karaoke {
  background: linear-gradient(90deg, 
    #fff 0%, 
    #fff var(--karaoke-progress, 0%), 
    rgba(255,255,255,0.25) var(--karaoke-progress, 0%),
    rgba(255,255,255,0.25) 100%
  );
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Compact Mode */
.fs-lyrics.compact .fs-line {
  font-size: calc(var(--lyrics-font-size, 2.2rem) * 0.85);
  min-height: 45px;
  padding: 6px 16px;
}
.fs-lyrics.compact .fs-header {
  padding: 10px 16px;
}
.fs-lyrics.compact .fs-player-bar {
  padding: 12px 20px 16px;
}

/* Art Focus Mode */
.fs-lyrics.art-focus .fs-content {
  flex-direction: column;
}
.fs-lyrics.art-focus .fs-body {
  position: absolute;
  bottom: 120px;
  left: 0;
  right: 0;
  padding: 20px;
  background: linear-gradient(to top, rgba(5,5,8,0.9), transparent);
}
.fs-lyrics.art-focus .fs-line {
  font-size: 1.4rem;
  min-height: 40px;
}
.fs-lyrics.art-focus .fs-line:not(.active) {
  opacity: 0;
}
.fs-art-large {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -55%);
  width: min(50vh, 50vw);
  aspect-ratio: 1;
  border-radius: var(--radius-xl);
  overflow: hidden;
  box-shadow: 
    0 30px 100px rgba(0,0,0,0.5),
    0 0 0 1px rgba(255,255,255,0.1),
    0 0 100px rgba(155,93,229,0.2);
  animation: artFloat 6s ease-in-out infinite;
}
@keyframes artFloat {
  0%, 100% { transform: translate(-50%, -55%) rotateY(-5deg) rotateX(3deg); }
  50% { transform: translate(-50%, -53%) rotateY(5deg) rotateX(-3deg); }
}
.fs-art-large img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Raw Mode (Plain Text) */
.fs-lyrics.raw-mode .fs-line {
  opacity: 0.7;
  color: var(--text);
}
.fs-lyrics.raw-mode .fs-line:hover {
  opacity: 1;
  background: rgba(255,255,255,0.05);
}

/* High Contrast Mode */
.fs-lyrics.high-contrast .fs-line {
  opacity: 0.3;
  color: #fff;
}
.fs-lyrics.high-contrast .fs-line.active {
  opacity: 1;
  color: #fff;
  text-shadow: 0 0 20px #fff;
  background: rgba(255,255,255,0.1);
}

/* Large Text Mode */
.fs-lyrics.large-text {
  --lyrics-font-size: 3rem;
}
.fs-lyrics.large-text .fs-line {
  min-height: 80px;
}

/* Long Press Indicator */
.fs-line.pressing {
  background: rgba(155,93,229,0.15);
  transform: scale(0.98);
  transition: transform 0.3s, background 0.3s;
}

/* Selection Styles */
.fs-line::selection {
  background: rgba(155,93,229,0.5);
  color: #fff;
}

/* ═══ V2: VOLUME SLIDER REDESIGN ═══ */
.volume-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  position: relative;
}
.volume-bar {
  width: 100px;
  height: 4px;
  background: rgba(255,255,255,0.08);
  border-radius: 4px;
  cursor: pointer;
  position: relative;
  transition: height 0.15s;
}
.volume-bar:hover { height: 6px; }
.volume-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--purple-400), var(--pink));
  border-radius: 4px;
  width: 70%;
  position: relative;
  transition: background 0.2s;
}
.volume-fill::after {
  content: '';
  position: absolute;
  right: -6px;
  top: 50%;
  transform: translateY(-50%) scale(0);
  width: 14px;
  height: 14px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 12px rgba(155,93,229,0.3);
  transition: transform 0.15s var(--ease-out);
}
.volume-bar:hover .volume-fill::after { transform: translateY(-50%) scale(1); }
.volume-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 0.68rem;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.15s;
  white-space: nowrap;
}
.volume-wrap:hover .volume-tooltip { opacity: 1; }

/* ═══ V2: PLAYER BAR BUTTON IDENTIFIERS ═══ */
.p-btn-labeled {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 2px;
  position: relative;
}
.p-btn-labeled .btn-label {
  font-size: 0.55rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  opacity: 0;
  position: absolute;
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  transition: opacity 0.2s;
  color: var(--text-muted);
}
.p-btn-labeled:hover .btn-label { opacity: 1; }
.p-btn-labeled.active .btn-label { opacity: 0.7; color: var(--purple-300); }

.p-btn.active { color: var(--purple-300); }
.p-btn.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  background: var(--purple-400);
  border-radius: 50%;
}

/* Queue badge */
.queue-badge {
  position: absolute;
  top: -2px;
  right: -4px;
  background: var(--pink);
  color: #fff;
  font-size: 0.58rem;
  font-weight: 800;
  min-width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  padding: 0 4px;
}

/* ═══ V2: SEARCH LYRICS TOGGLE ═══ */
.search-toggle-wrap {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-left: 8px;
}
.search-toggle-btn {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 5px 10px;
  border-radius: var(--radius-full);
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text-muted);
  font-size: 0.72rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.search-toggle-btn:hover { background: var(--glass-hover); color: var(--text); }
.search-toggle-btn.active {
  background: rgba(155,93,229,0.15);
  border-color: rgba(155,93,229,0.3);
  color: var(--purple-300);
}

/* ═══ V2: INFINITE SCROLL ═══ */
.infinite-sentinel {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  min-height: 60px;
}
.load-more-spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--border);
  border-top-color: var(--purple-400);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* ═══ V2: ADVANCED FILTERS ═══ */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
  align-items: center;
}
.filter-select {
  padding: 7px 28px 7px 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b8ba0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  transition: all 0.2s;
}
.filter-select:hover { background-color: var(--bg-card-hover); }
.filter-select:focus { outline: none; border-color: var(--purple-500); }
.filter-active-chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.filter-active-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: rgba(155,93,229,0.12);
  border: 1px solid rgba(155,93,229,0.25);
  border-radius: var(--radius-full);
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--purple-200);
  cursor: default;
}
.filter-active-chip .chip-x {
  cursor: pointer;
  opacity: 0.6;
  font-size: 0.8rem;
  line-height: 1;
}
.filter-active-chip .chip-x:hover { opacity: 1; }

/* ═══ V2: LIKE BUTTONS ═══ */
.like-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 6px;
  border-radius: 50%;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  position: relative;
}
.like-btn:hover { color: var(--text); background: var(--glass-hover); }
.like-btn.liked { color: var(--pink); }
.like-btn.liked:hover { color: var(--pink); background: rgba(241,91,181,0.1); }
.like-btn.disliked { color: var(--text-faint); }
.like-btn.loading { opacity: 0.6; pointer-events: none; }
.like-btn:active { transform: scale(0.9); }

/* ═══ V3: ENHANCED LIKE SYSTEM ═══ */

/* Like count badge */
.like-count {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-left: 4px;
  font-weight: 500;
}
.like-count.has-likes { color: var(--pink); }

/* Heart burst animation */
@keyframes heartBurst {
  0% { transform: scale(1); }
  25% { transform: scale(1.3); }
  50% { transform: scale(0.9); }
  75% { transform: scale(1.1); }
  100% { transform: scale(1); }
}
@keyframes heartParticles {
  0% { opacity: 1; transform: translate(0, 0) scale(1); }
  100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
}
.like-btn.animating { animation: heartBurst 0.4s var(--ease-spring); }
.like-btn.animating::after {
  content: '❤️';
  position: absolute;
  font-size: 8px;
  pointer-events: none;
  animation: heartParticles 0.6s ease-out forwards;
  --tx: 0;
  --ty: -20px;
}
.like-btn.animating::before {
  content: '✨';
  position: absolute;
  font-size: 6px;
  pointer-events: none;
  animation: heartParticles 0.5s ease-out forwards;
  animation-delay: 0.1s;
  --tx: 15px;
  --ty: -15px;
}

/* Tooltip */
.like-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 6px 10px;
  font-size: 0.72rem;
  color: var(--text-secondary);
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  z-index: 10;
}
.like-btn:hover .like-tooltip { opacity: 1; }

/* Song card fade out animation for unlike */
.song-card.fading-out {
  animation: fadeOutScale 0.5s var(--ease-out) forwards;
}
@keyframes fadeOutScale {
  to { opacity: 0; transform: scale(0.95); height: 0; margin: 0; padding: 0; }
}

/* Bulk selection mode */
.song-card.bulk-select {
  position: relative;
}
.song-card.bulk-select::before {
  content: '';
  position: absolute;
  inset: 0;
  border: 2px solid var(--purple-500);
  border-radius: var(--radius-lg);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}
.song-card.bulk-select.selected::before { opacity: 1; }
.bulk-checkbox {
  position: absolute;
  top: 8px;
  left: 8px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  border: 2px solid rgba(255,255,255,0.5);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #fff;
  z-index: 5;
  transition: all 0.2s;
}
.bulk-checkbox:hover { border-color: var(--purple-400); }
.bulk-checkbox.checked {
  background: var(--purple-500);
  border-color: var(--purple-500);
}

/* Bulk actions bar */
.bulk-actions-bar {
  position: sticky;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  box-shadow: var(--shadow-lg);
  z-index: 50;
  animation: slideUp 0.3s var(--ease-out);
}
.bulk-actions-bar span {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text);
}
.bulk-btn {
  padding: 8px 16px;
  border-radius: var(--radius-full);
  border: none;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.bulk-btn-like {
  background: linear-gradient(135deg, var(--pink), var(--purple-500));
  color: #fff;
}
.bulk-btn-like:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(241,91,181,0.4); }
.bulk-btn-unlike {
  background: var(--glass);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.bulk-btn-unlike:hover { background: var(--glass-hover); }
.bulk-btn-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 4px;
}
.bulk-btn-close:hover { color: var(--text); }

/* Library filter/sort bar */
.library-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-bottom: 20px;
  padding: 12px 16px;
  background: var(--bg-card);
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
}
.library-controls select {
  padding: 8px 28px 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  color: var(--text);
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b8ba0' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
}
.library-actions {
  display: flex;
  gap: 8px;
  margin-left: auto;
}
.library-action-btn {
  padding: 8px 14px;
  border-radius: var(--radius-full);
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text-secondary);
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.library-action-btn:hover {
  background: var(--glass-hover);
  color: var(--text);
}

/* Like statistics cards */
.like-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.like-stat-card {
  padding: 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  text-align: center;
}
.like-stat-value {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--pink);
}
.like-stat-label {
  font-size: 0.72rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 4px;
}

/* Streak banner */
.streak-banner {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: linear-gradient(135deg, rgba(241,91,181,0.15), rgba(155,93,229,0.1));
  border: 1px solid rgba(241,91,181,0.25);
  border-radius: var(--radius-lg);
  margin-bottom: 20px;
}
.streak-banner .streak-icon {
  font-size: 1.8rem;
}
.streak-banner .streak-text {
  flex: 1;
}
.streak-banner .streak-title {
  font-weight: 700;
  font-size: 0.95rem;
  color: var(--pink);
}
.streak-banner .streak-subtitle {
  font-size: 0.78rem;
  color: var(--text-secondary);
}

/* Recently liked section */
.recently-liked-section {
  margin-bottom: 32px;
}
.recently-liked-list {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  padding-bottom: 8px;
  scrollbar-width: none;
}
.recently-liked-list::-webkit-scrollbar { display: none; }
.recently-liked-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px 8px 8px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}
.recently-liked-item:hover {
  background: var(--bg-card-hover);
  border-color: var(--border-hover);
}
.recently-liked-item img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
}
.recently-liked-item .rli-name {
  font-size: 0.82rem;
  font-weight: 600;
  white-space: nowrap;
}
.recently-liked-item .rli-time {
  font-size: 0.65rem;
  color: var(--text-muted);
}

/* Most liked songs section on home */
.most-liked-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
}

/* Friend likes indicator */
.friend-likes {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-top: 4px;
}
.friend-likes-avatars {
  display: flex;
}
.friend-likes-avatars span {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--purple-600);
  border: 2px solid var(--bg-card);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.55rem;
  font-weight: 700;
  margin-left: -6px;
}
.friend-likes-avatars span:first-child { margin-left: 0; }

/* Like sync indicator */
.like-sync-indicator {
  position: fixed;
  bottom: calc(var(--player-h) + 60px);
  right: 16px;
  padding: 10px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 0.8rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: var(--shadow-md);
  animation: slideUp 0.3s var(--ease-out);
  z-index: 100;
}
.like-sync-indicator.offline {
  border-color: var(--orange);
  color: var(--orange);
}
.like-sync-indicator.syncing {
  border-color: var(--purple-500);
  color: var(--purple-300);
}

/* Mini player like button */
.mini-player-like {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--text-muted);
  transition: all 0.2s;
  font-size: 12px;
}
.mini-player-like:hover { color: var(--pink); border-color: var(--pink); }
.mini-player-like.liked { color: var(--pink); background: rgba(241,91,181,0.15); }

/* Queue item like button */
.qi-like-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.15s;
  opacity: 0;
}
.queue-item:hover .qi-like-btn { opacity: 1; }
.qi-like-btn:hover { color: var(--pink); }
.qi-like-btn.liked { color: var(--pink); opacity: 1; }

/* Fullscreen lyrics like button */
.fs-like-btn {
  position: absolute;
  top: 20px;
  right: 80px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.08);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: all 0.2s;
}
.fs-like-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
.fs-like-btn.liked { color: var(--pink); }

/* Song detail like button */
.detail-like-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(241,91,181,0.1);
  border: 1px solid rgba(241,91,181,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--pink);
  transition: all 0.2s;
}
.detail-like-btn:hover {
  background: rgba(241,91,181,0.2);
  transform: scale(1.05);
}
.detail-like-btn.liked { background: rgba(241,91,181,0.25); }

/* Undo toast */
.undo-toast {
  display: flex;
  align-items: center;
  gap: 12px;
}
.undo-toast button {
  padding: 4px 12px;
  background: var(--purple-600);
  border: none;
  border-radius: var(--radius-sm);
  color: #fff;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.undo-toast button:hover { background: var(--purple-500); }

/* Like recommendations */
.like-recommendations {
  margin-top: 40px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}
.like-recommendations h4 {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
  margin-bottom: 16px;
  color: var(--text);
}
.like-rec-reason {
  font-size: 0.7rem;
  color: var(--purple-300);
  margin-top: 4px;
}

/* Swipe hint for mobile */
.swipe-hint {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 8px 16px;
  background: rgba(0,0,0,0.8);
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  color: #fff;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  z-index: 10;
}
.song-card.show-swipe-hint .swipe-hint { opacity: 1; }

/* Nav badge for liked songs */
.nav-item .nav-badge.liked-badge {
  background: var(--pink);
  color: #fff;
  animation: pulse 2s infinite;
}

/* Search results like button */
.search-result-like {
  margin-left: auto;
  padding: 6px;
}

/* Like all in playlist button */
.playlist-like-all {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 18px;
  background: rgba(241,91,181,0.1);
  border: 1px solid rgba(241,91,181,0.3);
  border-radius: var(--radius-full);
  color: var(--pink);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.playlist-like-all:hover {
  background: rgba(241,91,181,0.2);
  transform: translateY(-2px);
}

/* Recently played like button */
.recent-like-btn {
  opacity: 0;
  transition: opacity 0.2s;
}
.song-row:hover .recent-like-btn { opacity: 1; }
.recent-like-btn.liked { opacity: 1; }

/* ═══ V2: LIBRARY PAGE ═══ */
.playlist-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}
.playlist-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  cursor: pointer;
  transition: all 0.25s var(--ease-out);
}
.playlist-card:hover {
  transform: translateY(-3px);
  border-color: var(--border-hover);
  box-shadow: var(--shadow-md);
}
.playlist-card-art {
  aspect-ratio: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  background: linear-gradient(135deg, var(--purple-900), var(--bg-card));
  overflow: hidden;
}
.playlist-card-art img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.playlist-card-art .pca-empty {
  grid-column: 1/-1;
  grid-row: 1/-1;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5rem;
}
.playlist-card-info {
  padding: 14px;
}
.playlist-card-name {
  font-weight: 700;
  font-size: 0.88rem;
  margin-bottom: 4px;
}
.playlist-card-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
}
.create-playlist-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 260px;
  background: var(--glass);
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text-muted);
  gap: 8px;
}
.create-playlist-card:hover {
  border-color: var(--purple-500);
  color: var(--purple-300);
  background: rgba(155,93,229,0.05);
}
.create-playlist-card svg { width: 32px; height: 32px; }
.create-playlist-card span { font-weight: 600; font-size: 0.85rem; }

/* ═══ V2: SETTINGS PAGE ═══ */
.settings-section {
  margin-bottom: 32px;
}
.settings-section h3 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.eq-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 24px;
}
.eq-presets {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
}
.eq-preset-btn {
  padding: 8px 16px;
  border-radius: var(--radius-full);
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text-secondary);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.eq-preset-btn:hover { background: var(--glass-hover); color: var(--text); }
.eq-preset-btn.active {
  background: var(--purple-800);
  border-color: var(--purple-600);
  color: var(--purple-100);
}
.eq-sliders {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  gap: 8px;
  height: 200px;
  padding: 0 16px;
}
.eq-band {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  flex: 1;
}
.eq-band input[type=range] {
  writing-mode: vertical-lr;
  direction: rtl;
  height: 140px;
  width: 28px;
  accent-color: var(--purple-400);
  cursor: pointer;
}
.eq-band-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  font-family: var(--font-mono);
  text-align: center;
}
.eq-band-val {
  font-size: 0.65rem;
  color: var(--text-secondary);
  font-family: var(--font-mono);
  min-width: 28px;
  text-align: center;
}
.eq-curve {
  width: 100%;
  height: 80px;
  margin-top: 16px;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
  overflow: hidden;
}
.custom-preset-actions {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}
.custom-preset-actions button {
  padding: 8px 16px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text-secondary);
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.custom-preset-actions button:hover {
  background: var(--glass-hover);
  color: var(--text);
}

/* ═══ V2: ADD TO PLAYLIST MODAL ═══ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  z-index: 150;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal-box {
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 24px;
  max-width: 400px;
  width: 90%;
  animation: scaleIn 0.3s var(--ease-out);
}
.modal-box h3 {
  font-family: var(--font-display);
  font-weight: 700;
  margin-bottom: 16px;
}
.modal-playlist-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 16px;
}
.modal-playlist-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s;
}
.modal-playlist-item:hover { background: var(--glass-hover); }
.modal-playlist-item .mpi-icon {
  font-size: 1.2rem;
}
.modal-playlist-item .mpi-name {
  font-weight: 600;
  font-size: 0.88rem;
}
.modal-playlist-item .mpi-count {
  margin-left: auto;
  font-size: 0.75rem;
  color: var(--text-muted);
}
.modal-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}
.modal-btn {
  padding: 8px 18px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.modal-btn:hover { background: var(--glass-hover); }
.modal-btn-primary {
  background: var(--purple-700);
  border-color: var(--purple-500);
  color: #fff;
}
.modal-btn-primary:hover { background: var(--purple-600); }

/* ═══ V3: PLAYLIST QOL ENHANCEMENTS ═══ */

/* Drag and Drop */
.song-card.dragging {
  opacity: 0.5;
  transform: scale(0.98);
}
.song-card.drag-over {
  border-color: var(--purple-500);
  box-shadow: 0 0 0 2px var(--purple-500);
}
.playlist-song-row {
  display: grid;
  grid-template-columns: 40px 50px 1fr 140px 80px 100px;
  align-items: center;
  gap: 14px;
  padding: 8px 14px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s;
  background: var(--bg-card);
  margin-bottom: 2px;
}
.playlist-song-row:hover { background: var(--glass-hover); }
.playlist-song-row.dragging {
  opacity: 0.5;
}
.playlist-song-row.drag-over {
  background: rgba(155,93,229,0.2);
}
.playlist-song-row.selected {
  background: rgba(155,93,229,0.15);
  border-left: 3px solid var(--purple-500);
}
.drag-handle {
  cursor: grab;
  color: var(--text-muted);
  padding: 4px;
  opacity: 0.5;
  transition: opacity 0.15s;
}
.drag-handle:hover { opacity: 1; }
.drag-handle:active { cursor: grabbing; }
.song-checkbox {
  width: 18px;
  height: 18px;
  accent-color: var(--purple-500);
  cursor: pointer;
}

/* Playlist Folders */
.playlist-folder {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 16px;
  overflow: hidden;
}
.playlist-folder-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: var(--glass);
  cursor: pointer;
  transition: all 0.2s;
}
.playlist-folder-header:hover { background: var(--glass-hover); }
.playlist-folder-icon { font-size: 1.2rem; }
.playlist-folder-name {
  font-weight: 700;
  font-size: 0.95rem;
  flex: 1;
}
.playlist-folder-count {
  font-size: 0.75rem;
  color: var(--text-muted);
}
.playlist-folder-content {
  padding: 12px;
  display: none;
}
.playlist-folder.expanded .playlist-folder-content { display: block; }
.playlist-folder.expanded .playlist-folder-icon { transform: rotate(90deg); }

/* Pinned Playlists */
.playlist-card.pinned {
  border-color: var(--purple-500);
  box-shadow: 0 0 20px rgba(155,93,229,0.2);
}
.playlist-card.pinned::before {
  content: '📌';
  position: absolute;
  top: 8px;
  left: 8px;
  font-size: 0.9rem;
  background: rgba(155,93,229,0.9);
  padding: 2px 6px;
  border-radius: var(--radius-full);
  z-index: 2;
}
.playlist-card {
  position: relative;
}

/* Archived Playlists */
.playlist-card.archived {
  opacity: 0.5;
  filter: grayscale(0.5);
}

/* Playlist Stats */
.playlist-stats-bar {
  display: flex;
  gap: 24px;
  padding: 16px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.playlist-stat {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.playlist-stat-value {
  font-family: var(--font-display);
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--purple-300);
}
.playlist-stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.playlist-stat-categories {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.category-pill {
  font-size: 0.65rem;
  padding: 2px 8px;
  background: rgba(155,93,229,0.15);
  color: var(--purple-200);
  border-radius: var(--radius-full);
}

/* Smart Playlist Badge */
.smart-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  background: linear-gradient(135deg, var(--cyan), var(--purple-500));
  border-radius: var(--radius-full);
  font-size: 0.65rem;
  font-weight: 700;
  color: #fff;
}

/* Playlist Search */
.playlist-search-box {
  position: relative;
  flex: 1;
  max-width: 300px;
}
.playlist-search-box input {
  width: 100%;
  padding: 10px 14px 10px 38px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.85rem;
  color: var(--text);
  outline: none;
}
.playlist-search-box svg {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  color: var(--text-muted);
}

/* Sort Dropdown */
.sort-dropdown {
  padding: 8px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.85rem;
  color: var(--text);
  cursor: pointer;
  outline: none;
}
.sort-dropdown:focus { border-color: var(--purple-500); }

/* Bulk Actions Bar */
.bulk-actions-bar {
  display: none;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--purple-900);
  border: 1px solid var(--purple-700);
  border-radius: var(--radius-md);
  margin-bottom: 16px;
}
.bulk-actions-bar.visible { display: flex; }
.bulk-actions-bar span {
  font-size: 0.85rem;
  color: var(--purple-200);
  flex: 1;
}
.bulk-btn {
  padding: 6px 14px;
  background: var(--purple-700);
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
  transition: all 0.15s;
}
.bulk-btn:hover { background: var(--purple-600); }
.bulk-btn.danger { background: var(--red); }
.bulk-btn.danger:hover { background: #ff5f6d; }

/* Move Position Input */
.move-position-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
}
.move-position-input {
  width: 60px;
  padding: 6px 10px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  color: var(--text);
  text-align: center;
}

/* Playlist Description */
.playlist-description {
  font-size: 0.9rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 20px;
  max-width: 600px;
}
.playlist-description.collapsed {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.playlist-description-toggle {
  font-size: 0.75rem;
  color: var(--purple-300);
  cursor: pointer;
  margin-top: -16px;
  margin-bottom: 16px;
  display: inline-block;
}

/* Custom Cover Upload */
.cover-upload-area {
  width: 240px;
  height: 240px;
  border-radius: var(--radius-lg);
  background: var(--bg-card);
  border: 2px dashed var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  overflow: hidden;
}
.cover-upload-area:hover { border-color: var(--purple-500); }
.cover-upload-area.has-image { border-style: solid; }
.cover-upload-area img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.cover-upload-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  opacity: 0;
  transition: opacity 0.2s;
}
.cover-upload-area:hover .cover-upload-overlay { opacity: 1; }

/* Activity Log */
.activity-log {
  max-height: 200px;
  overflow-y: auto;
  padding: 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
}
.activity-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
}
.activity-item:last-child { border-bottom: none; }
.activity-time {
  font-size: 0.7rem;
  color: var(--text-muted);
  white-space: nowrap;
}
.activity-user {
  font-weight: 600;
  color: var(--purple-300);
}

/* Comments */
.comments-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}
.comment-input-wrap {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
}
.comment-input {
  flex: 1;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 0.9rem;
  color: var(--text);
  outline: none;
  resize: none;
  min-height: 60px;
}
.comment-input:focus { border-color: var(--purple-500); }
.comment-item {
  padding: 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 12px;
}
.comment-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}
.comment-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--purple-600), var(--pink));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
}
.comment-author {
  font-weight: 600;
  font-size: 0.85rem;
}
.comment-time {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-left: auto;
}
.comment-text {
  font-size: 0.88rem;
  color: var(--text-secondary);
  line-height: 1.5;
}

/* Share Modal */
.share-link-box {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}
.share-link-box input {
  flex: 1;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 0.9rem;
  color: var(--text);
  font-family: var(--font-mono);
}
.share-link-box button {
  padding: 12px 20px;
  background: var(--purple-700);
  border: none;
  border-radius: var(--radius-md);
  font-size: 0.85rem;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
}

/* Smart Playlist Rules */
.smart-rules-editor {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
}
.smart-rule-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.smart-rule-row select {
  padding: 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 0.85rem;
  color: var(--text);
}
.smart-rule-remove {
  padding: 6px;
  background: none;
  border: none;
  color: var(--red);
  cursor: pointer;
  font-size: 1rem;
}

/* Playlist Templates */
.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.template-card {
  padding: 16px;
  background: linear-gradient(135deg, var(--bg-card), var(--purple-900));
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.2s;
}
.template-card:hover {
  transform: translateY(-2px);
  border-color: var(--purple-500);
}
.template-card-icon { font-size: 1.5rem; margin-bottom: 8px; }
.template-card-name {
  font-weight: 700;
  font-size: 0.9rem;
  margin-bottom: 4px;
}
.template-card-desc {
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Background Collage */
.bg-collage {
  position: fixed;
  inset: 0;
  z-index: -1;
  opacity: 0.1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 4px;
  pointer-events: none;
}
.bg-collage img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: grayscale(0.3);
}

/* Import/Export */
.import-drop-zone {
  padding: 40px;
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  text-align: center;
  color: var(--text-muted);
  transition: all 0.2s;
  cursor: pointer;
}
.import-drop-zone:hover, .import-drop-zone.drag-over {
  border-color: var(--purple-500);
  background: rgba(155,93,229,0.05);
}

/* Mood/Genre Detection */
.mood-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 12px;
}
.mood-tag {
  padding: 4px 12px;
  background: linear-gradient(135deg, var(--pink), var(--purple-500));
  border-radius: var(--radius-full);
  font-size: 0.7rem;
  font-weight: 600;
  color: #fff;
}

/* Compare Playlists */
.compare-result {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 20px;
}
.compare-column {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
}
.compare-column h4 {
  font-size: 0.85rem;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}
.compare-song {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 0;
  font-size: 0.8rem;
}
.compare-song-duplicate { color: var(--orange); }
.compare-song-unique { color: var(--green); }

/* Recently Modified */
.recently-modified {
  margin-top: 24px;
}
.recent-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  font-size: 0.85rem;
}
.recent-item-time {
  font-size: 0.7rem;
  color: var(--text-muted);
  margin-left: auto;
}

/* Position Move Modal */
.position-modal-input {
  width: 100%;
  padding: 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 1.2rem;
  color: var(--text);
  text-align: center;
  margin: 20px 0;
}
.position-modal-input:focus {
  border-color: var(--purple-500);
  outline: none;
}

/* Continue Playing Banner */
.continue-banner {
  display: none;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: linear-gradient(135deg, var(--purple-900), var(--bg-card));
  border: 1px solid var(--purple-700);
  border-radius: var(--radius-md);
  margin-bottom: 16px;
}
.continue-banner.visible { display: flex; }
.continue-banner span {
  flex: 1;
  font-size: 0.85rem;
}
.continue-banner button {
  padding: 6px 14px;
  background: var(--purple-700);
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
}

/* Rich Text Editor */
.rich-editor {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
}
.rich-editor-toolbar {
  display: flex;
  gap: 4px;
  padding: 8px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
}
.rich-editor-btn {
  padding: 6px 10px;
  background: none;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 0.8rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.rich-editor-btn:hover {
  background: var(--glass-hover);
  color: var(--text);
}
.rich-editor-content {
  min-height: 120px;
  padding: 12px;
  font-size: 0.9rem;
  line-height: 1.6;
  outline: none;
}

/* Responsive for Playlist QOL */
@media (max-width: 900px) {
  .playlist-song-row {
    grid-template-columns: 30px 40px 1fr 70px;
  }
  .playlist-song-row .song-row-artist,
  .playlist-song-row .song-row-duration,
  .playlist-song-row .song-row-actions {
    display: none;
  }
  .playlist-stats-bar {
    flex-direction: column;
    gap: 12px;
  }
  .compare-result {
    grid-template-columns: 1fr;
  }
}

/* ═══ V2: SONG CARD LIKE OVERLAY ═══ */
.song-card-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.2s;
}
.song-card:hover .song-card-actions { opacity: 1; }
.sca-btn {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  transition: all 0.15s;
}
.sca-btn:hover { background: rgba(0,0,0,0.8); transform: scale(1.1); }
.sca-btn.liked { color: var(--pink); }

/* ===== 60 IMPROVEMENTS CSS ADDITIONS ===== */

/* 1. Toast stacking fix */
.toast-container:has(.toast:nth-child(4)) .toast:nth-child(n+4) { display: none; }

/* 2. Search clear button */
.search-box .search-clear {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  border-radius: 50%;
  display: none;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
}
.search-box .search-clear:hover { color: var(--text); background: var(--glass-hover); }

/* 3. Smooth progress transitions */
.progress-fill { transition: width 0.1s linear, background 0.2s; }

/* 4. Volume icon muted state */
.volume-icon-muted { opacity: 0.5; }

/* 5. Sidebar active indicator */
.nav-item { position: relative; }
.nav-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 20px;
  background: var(--purple-400);
  border-radius: 0 2px 2px 0;
}

/* 7-8. Enhanced shuffle/repeat indicators */
.p-btn.shuffle-active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 4px;
  height: 4px;
  background: var(--purple-400);
  border-radius: 50%;
}
.p-btn.repeat-one::after {
  content: '1';
  position: absolute;
  bottom: -4px;
  right: -4px;
  font-size: 0.5rem;
  font-weight: 800;
  background: var(--purple-400);
  color: #fff;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* 9-10. Image loading states */
.song-card-art img { opacity: 0; transition: opacity 0.3s; }
.song-card-art img.loaded { opacity: 1; }

/* 11. Mobile modal fix */
@media (max-width: 600px) {
  .modal-overlay { align-items: flex-end; padding: 0; }
  .modal-box { max-width: 100%; border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
}

/* 15. Mobile sidebar overlay */
.sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 19; }
.sidebar-overlay.open { display: block; }

/* 21. Skeleton loading */
.skeleton-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
.skeleton-art { aspect-ratio: 1; background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%); background-size: 400% 100%; animation: shimmer 1.5s ease-in-out infinite; }
.skeleton-text { height: 12px; background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%); background-size: 400% 100%; animation: shimmer 1.5s ease-in-out infinite; border-radius: 4px; margin: 8px 14px; }

/* 22. Page transitions */
.page { opacity: 0; transform: translateY(10px); transition: opacity 0.3s var(--ease-out), transform 0.3s var(--ease-out); display: none; }
.page.active { opacity: 1; transform: translateY(0); display: block; }

/* 23. Empty states with illustration */
.empty-state-illustration { width: 120px; height: 120px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--purple-900), var(--bg-card)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; animation: float 3s ease-in-out infinite; }

/* 24. Tooltips */
.tooltip { position: relative; }
.tooltip::after { content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%) scale(0.9); padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600; color: var(--text); white-space: nowrap; opacity: 0; pointer-events: none; transition: all 0.2s var(--ease-out); z-index: 1000; }
.tooltip:hover::after { opacity: 1; transform: translateX(-50%) scale(1); }

/* 25. Context menu */
.context-menu { position: fixed; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 6px 0; min-width: 180px; z-index: 1000; box-shadow: var(--shadow-lg); display: none; }
.context-menu.open { display: block; }
.context-menu-item { padding: 10px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem; transition: background 0.15s; }
.context-menu-item:hover { background: var(--glass-hover); }
.context-menu-divider { height: 1px; background: var(--border); margin: 6px 0; }

/* 26. Pull to refresh */
.ptr-indicator { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; }
.ptr-indicator.releasing { transform: translateX(-50%) rotate(360deg); }

/* 30. Focus indicators */
*:focus-visible { outline: 2px solid var(--purple-400); outline-offset: 2px; }

/* 32. Error boundary */
.error-boundary { text-align: center; padding: 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); margin: 20px; }
.error-boundary h3 { color: var(--red); margin-bottom: 12px; }
.error-boundary button { margin-top: 16px; padding: 10px 20px; background: var(--purple-700); border: none; border-radius: var(--radius-md); color: #fff; font-weight: 600; cursor: pointer; }

/* 33. Offline banner */
.offline-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--orange); color: #000; padding: 8px 16px; text-align: center; font-weight: 600; font-size: 0.85rem; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s var(--ease-out); }
.offline-banner.visible { transform: translateY(0); }

/* 34. Update banner */
.update-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--purple-600); color: #fff; padding: 12px 16px; text-align: center; font-weight: 600; font-size: 0.85rem; z-index: 1000; transform: translateY(-100%); transition: transform 0.3s var(--ease-out); display: flex; align-items: center; justify-content: center; gap: 16px; }
.update-banner.visible { transform: translateY(0); }
.update-banner button { padding: 6px 14px; background: #fff; color: var(--purple-600); border: none; border-radius: var(--radius-full); font-weight: 700; font-size: 0.75rem; cursor: pointer; }

/* 35. Shortcuts modal */
.shortcuts-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 150; display: none; align-items: center; justify-content: center; }
.shortcuts-modal.open { display: flex; }
.shortcuts-content { background: var(--bg-raised); border: 1px solid var(--border); border-radius: var(--radius-xl); padding: 32px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
.shortcuts-content h2 { font-family: var(--font-display); margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; }
.shortcuts-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; font-size: 1.2rem; }
.shortcuts-grid { display: grid; gap: 12px; }
.shortcut-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
.shortcut-row:last-child { border-bottom: none; }
.shortcut-keys { display: flex; gap: 6px; }
.shortcut-key { padding: 4px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 0.75rem; font-weight: 600; }

/* 38. Continue listening banner */
.continue-banner { background: linear-gradient(135deg, rgba(155,93,229,0.15), rgba(241,91,181,0.1)); border: 1px solid rgba(155,93,229,0.2); border-radius: var(--radius-lg); padding: 16px 20px; display: flex; align-items: center; gap: 16px; margin-bottom: 24px; cursor: pointer; transition: all 0.2s; }
.continue-banner:hover { background: linear-gradient(135deg, rgba(155,93,229,0.2), rgba(241,91,181,0.15)); }
.continue-banner-art { width: 60px; height: 60px; border-radius: var(--radius-sm); overflow: hidden; background: var(--bg-card); flex-shrink: 0; }
.continue-banner-info { flex: 1; }
.continue-banner-label { font-size: 0.7rem; color: var(--purple-300); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.continue-banner-song { font-weight: 700; margin-top: 4px; }
.continue-banner-artist { font-size: 0.8rem; color: var(--text-muted); }
.continue-banner-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--purple-500); border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; flex-shrink: 0; }
.continue-banner-btn:hover { transform: scale(1.05); }

/* Mobile responsive improvements */
@media (max-width: 900px) {
  .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 260px; z-index: 20; }
  .sidebar.open { transform: translateX(0); }
  .mobile-menu-btn { display: flex !important; }
}

/* Mobile menu button */
.mobile-menu-btn { display: none; background: none; border: none; color: var(--text); cursor: pointer; padding: 8px; border-radius: var(--radius-sm); }
.mobile-menu-btn:hover { background: var(--glass-hover); }

/* Sync pulse animation */
@keyframes syncPulse { 0%,100% { opacity:1;box-shadow:0 0 0 0 rgba(46,213,115,0.4); } 50% { opacity:0.8;box-shadow:0 0 0 8px rgba(46,213,115,0); } }
.sync-active { animation:syncPulse 1.5s infinite; }

/* ═══ PLAYLIST DETAIL PAGE V2 - Enhanced Design ═══ */

/* Back Button */
.playlist-back-btn {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  margin-bottom: 24px;
  font-size: 0.9rem;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: var(--radius-md);
  transition: all 0.2s;
}
.playlist-back-btn:hover {
  background: var(--glass-hover);
  color: var(--text);
}

/* Hero Section */
.playlist-hero {
  display: flex;
  gap: 32px;
  margin-bottom: 32px;
  flex-wrap: wrap;
}

.playlist-hero-cover {
  width: 280px;
  height: 280px;
  border-radius: var(--radius-lg);
  overflow: hidden;
  flex-shrink: 0;
  box-shadow: var(--shadow-lg), 0 0 60px rgba(155,93,229,0.2);
  position: relative;
}

.playlist-hero-cover img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.playlist-cover-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  height: 100%;
  gap: 2px;
  background: var(--border);
}

.playlist-cover-grid img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.playlist-cover-gradient {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(255,255,255,0.9);
}

.playlist-hero-info {
  flex: 1;
  min-width: 280px;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}

.playlist-hero-type {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.pinned-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 10px;
  background: rgba(255,193,7,0.15);
  border: 1px solid rgba(255,193,7,0.3);
  border-radius: var(--radius-full);
  font-size: 0.65rem;
  font-weight: 700;
  color: #ffc107;
}

.playlist-hero-title {
  font-family: var(--font-display);
  font-size: 3rem;
  font-weight: 800;
  letter-spacing: -1px;
  line-height: 1.1;
  margin-bottom: 16px;
  background: linear-gradient(135deg, var(--text) 0%, var(--purple-200) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.playlist-hero-description {
  font-size: 0.95rem;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 16px;
  max-width: 600px;
}

.playlist-hero-description.collapsible {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.desc-toggle {
  background: none;
  border: none;
  color: var(--purple-300);
  font-size: 0.8rem;
  cursor: pointer;
  padding: 0;
  margin-bottom: 16px;
}
.desc-toggle:hover { color: var(--purple-200); }

.playlist-hero-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.playlist-hero-meta .meta-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.playlist-hero-meta .meta-separator {
  color: var(--text-muted);
}

/* Collaborators Row */
.playlist-collaborators-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
}

.collab-label {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.collab-avatars {
  display: flex;
  align-items: center;
  gap: 8px;
}

.playlist-collaborator {
  position: relative;
}

.collab-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  color: #fff;
  border: 2px solid var(--bg-card);
}

.add-collab-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--glass-hover);
  border: 2px dashed var(--border-hover);
  color: var(--text-secondary);
  font-size: 1.2rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.add-collab-btn:hover {
  background: var(--purple-900);
  border-color: var(--purple-500);
  color: var(--purple-300);
}

.add-collab-btn-text {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}
.add-collab-btn-text:hover {
  background: var(--glass-hover);
  border-color: var(--purple-500);
  color: var(--purple-300);
}

/* Hero Actions */
.playlist-hero-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.hero-btn-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--glass);
  border: 1px solid var(--border);
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.hero-btn-icon:hover {
  background: var(--glass-hover);
  border-color: var(--border-hover);
  transform: scale(1.05);
}
.hero-btn-icon.liked {
  background: rgba(241,91,181,0.15);
  border-color: var(--pink);
  color: var(--pink);
}

.playlist-actions-dropdown {
  position: relative;
}

/* Stats Bar V2 */
.playlist-stats-bar-v2 {
  display: flex;
  align-items: center;
  gap: 32px;
  padding: 20px 24px;
  background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-surface) 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.playlist-stats-bar-v2 .stat-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.playlist-stats-bar-v2 .stat-value {
  font-family: var(--font-display);
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text);
}

.playlist-stats-bar-v2 .stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.playlist-stats-bar-v2 .stat-categories {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-left: auto;
}

.category-chip {
  padding: 6px 14px;
  background: rgba(155,93,229,0.1);
  border: 1px solid rgba(155,93,229,0.2);
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  color: var(--purple-300);
}

/* Toolbar V2 */
.playlist-toolbar {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.playlist-search-box-v2 {
  position: relative;
  flex: 1;
  max-width: 320px;
}

.playlist-search-box-v2 input {
  width: 100%;
  padding: 12px 16px 12px 42px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.9rem;
  color: var(--text);
  outline: none;
  transition: all 0.2s;
}
.playlist-search-box-v2 input:focus {
  border-color: var(--purple-500);
  background: var(--bg-surface);
}
.playlist-search-box-v2 svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  color: var(--text-muted);
}

.sort-dropdown-v2 {
  padding: 12px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.85rem;
  color: var(--text);
  cursor: pointer;
  outline: none;
  transition: all 0.2s;
}
.sort-dropdown-v2:focus {
  border-color: var(--purple-500);
}

.toolbar-btn {
  padding: 10px 18px;
  background: var(--glass);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}
.toolbar-btn:hover {
  background: var(--glass-hover);
  border-color: var(--border-hover);
  color: var(--text);
}

/* Bulk Actions Bar V2 */
.bulk-actions-bar {
  display: none;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: linear-gradient(135deg, var(--purple-900) 0%, rgba(155,93,229,0.2) 100%);
  border: 1px solid var(--purple-700);
  border-radius: var(--radius-md);
  margin-bottom: 20px;
}
.bulk-actions-bar.visible { display: flex; }
.bulk-actions-bar .bulk-count {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--purple-200);
  flex: 1;
}
.bulk-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.bulk-action-btn {
  padding: 8px 18px;
  background: var(--purple-700);
  border: none;
  border-radius: var(--radius-full);
  font-size: 0.8rem;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
  transition: all 0.2s;
}
.bulk-action-btn:hover {
  background: var(--purple-600);
  transform: translateY(-1px);
}
.bulk-action-btn.danger {
  background: var(--red);
}
.bulk-action-btn.danger:hover {
  background: #ff5f6d;
}
.bulk-action-btn.secondary {
  background: transparent;
  border: 1px solid var(--purple-500);
}
.bulk-action-btn.secondary:hover {
  background: rgba(155,93,229,0.1);
}

/* Song List Header */
.playlist-songs-header {
  display: grid;
  grid-template-columns: 50px 50px 1fr 140px 140px 100px 60px 80px;
  align-items: center;
  gap: 14px;
  padding: 12px 20px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}

/* Song List Container */
.playlist-songs-list {
  display: flex;
  flex-direction: column;
  margin-bottom: 40px;
}

/* Playlist Song Row V2 */
.playlist-song-row-v2 {
  display: grid;
  grid-template-columns: 50px 50px 1fr 140px 140px 100px 60px 80px;
  align-items: center;
  gap: 14px;
  padding: 10px 20px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 0.9rem;
  position: relative;
}
.playlist-song-row-v2:hover {
  background: var(--glass-hover);
}
.playlist-song-row-v2.active {
  background: rgba(155,93,229,0.1);
}
.playlist-song-row-v2.dragging {
  opacity: 0.5;
  background: var(--purple-900);
}
.playlist-song-row-v2.selected {
  background: rgba(155,93,229,0.15);
}

.psr-num {
  color: var(--text-muted);
  font-size: 0.85rem;
  text-align: center;
  font-variant-numeric: tabular-nums;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.psr-drag-handle {
  color: var(--text-muted);
  cursor: grab;
  opacity: 0;
  transition: opacity 0.15s;
  font-size: 1rem;
}
.playlist-song-row-v2:hover .psr-drag-handle {
  opacity: 1;
}
.psr-drag-handle:active {
  cursor: grabbing;
}

.psr-art {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-sm);
  overflow: hidden;
  background: var(--bg-card);
  flex-shrink: 0;
}
.psr-art img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.psr-art .art-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  background: linear-gradient(135deg, var(--purple-900), var(--bg-card));
}

.psr-title-section {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.psr-title {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--text);
}

.psr-explicit {
  display: inline-flex;
  align-items: center;
  padding: 1px 4px;
  background: var(--text-muted);
  border-radius: 3px;
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--bg-card);
  margin-left: 6px;
}

.psr-artist {
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.82rem;
}

.psr-album {
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.82rem;
}

.psr-date {
  color: var(--text-muted);
  font-size: 0.8rem;
}

.psr-duration {
  color: var(--text-muted);
  font-size: 0.82rem;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.psr-actions {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
}

.psr-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  opacity: 0;
}
.playlist-song-row-v2:hover .psr-btn {
  opacity: 1;
}
.psr-btn:hover {
  background: var(--glass-active);
  color: var(--text);
}
.psr-btn.liked {
  color: var(--pink);
  opacity: 1;
}
.psr-btn.liked:hover {
  color: var(--pink);
}
.psr-btn.remove:hover {
  color: var(--red);
}

/* Playing indicator in row */
.psr-playing-indicator {
  display: flex;
  align-items: flex-end;
  gap: 2px;
  height: 16px;
}
.psr-playing-indicator span {
  width: 3px;
  background: var(--purple-400);
  border-radius: 2px;
  animation: barPulse 1.2s ease-in-out infinite;
}
.psr-playing-indicator span:nth-child(1) { animation-delay: 0s; height: 8px; }
.psr-playing-indicator span:nth-child(2) { animation-delay: 0.2s; height: 14px; }
.psr-playing-indicator span:nth-child(3) { animation-delay: 0.4s; height: 6px; }
.psr-playing-indicator span:nth-child(4) { animation-delay: 0.1s; height: 12px; }

/* Empty State */
.playlist-empty-state {
  text-align: center;
  padding: 60px 20px;
  background: var(--bg-card);
  border: 1px dashed var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 40px;
}
.playlist-empty-state .empty-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}
.playlist-empty-state h3 {
  font-family: var(--font-display);
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--text);
}
.playlist-empty-state p {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

/* Comments Section V2 */
.playlist-comments-section {
  margin-top: 40px;
  padding: 24px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
}

.section-header-v2 {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}
.section-header-v2 h3 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
}
.comment-count {
  padding: 2px 10px;
  background: var(--glass);
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  color: var(--text-secondary);
}

.comment-input-wrap {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.comment-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--purple-500), var(--pink));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.9rem;
  color: #fff;
  flex-shrink: 0;
}

.comment-input-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.comment-input {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text);
  font-size: 0.9rem;
  resize: vertical;
  min-height: 80px;
  outline: none;
  font-family: inherit;
}
.comment-input:focus {
  border-color: var(--purple-500);
}

.comment-submit {
  align-self: flex-end;
  padding: 10px 24px;
  background: linear-gradient(135deg, var(--purple-500), var(--pink));
  border: none;
  border-radius: var(--radius-full);
  font-size: 0.85rem;
  font-weight: 700;
  color: #fff;
  cursor: pointer;
  transition: all 0.2s;
}
.comment-submit:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(155,93,229,0.4);
}

.playlist-comments-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Activity Section */
.playlist-activity-section {
  margin-top: 40px;
}
.activity-log-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Playlist Actions Menu */
.playlist-actions-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 8px;
  min-width: 180px;
  background: var(--bg-raised);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 8px 0;
  box-shadow: var(--shadow-lg);
  z-index: 100;
}
.playlist-actions-menu-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  font-size: 0.85rem;
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
}
.playlist-actions-menu-item:hover {
  background: var(--glass-hover);
}
.playlist-actions-menu-item.danger {
  color: var(--red);
}
.playlist-actions-menu-item.danger:hover {
  background: rgba(255,71,87,0.1);
}

/* Responsive */
@media (max-width: 1024px) {
  .playlist-hero-title { font-size: 2.2rem; }
  .playlist-hero-cover { width: 220px; height: 220px; }
  
  .playlist-songs-header {
    grid-template-columns: 40px 40px 1fr 100px 80px 60px;
  }
  .playlist-songs-header .col-album,
  .playlist-songs-header .col-date { display: none; }
  
  .playlist-song-row-v2 {
    grid-template-columns: 40px 40px 1fr 100px 80px 60px;
  }
  .psr-album,
  .psr-date { display: none; }
}

@media (max-width: 768px) {
  .playlist-hero { flex-direction: column; align-items: center; text-align: center; }
  .playlist-hero-cover { width: 200px; height: 200px; }
  .playlist-hero-info { align-items: center; }
  .playlist-hero-title { font-size: 1.8rem; }
  .playlist-hero-actions { justify-content: center; }
  .playlist-collaborators-row { justify-content: center; }
  
  .playlist-stats-bar-v2 { justify-content: center; }
  .playlist-stats-bar-v2 .stat-categories { width: 100%; justify-content: center; margin-top: 12px; margin-left: 0; }
  
  .playlist-songs-header {
    grid-template-columns: 36px 40px 1fr 60px;
  }
  .playlist-songs-header .col-artist,
  .playlist-songs-header .col-album,
  .playlist-songs-header .col-date,
  .playlist-songs-header .col-actions { display: none; }
  
  .playlist-song-row-v2 {
    grid-template-columns: 36px 40px 1fr 60px;
  }
  .psr-artist,
  .psr-album,
  .psr-date,
  .psr-actions { display: none; }
}

@media (max-width: 480px) {
  .playlist-hero-cover { width: 160px; height: 160px; }
  .playlist-hero-title { font-size: 1.5rem; }
  .hero-btn { padding: 10px 20px; font-size: 0.8rem; }
}
</style>
</head>
<body>
<!-- Offline Banner -->
<div id="offlineBanner" class="offline-banner">
  ?? You're offline. Some features may be unavailable.
</div>

<!-- Update Banner -->
<div id="updateBanner" class="update-banner">
  <span>? A new version is available!</span>
  <button onclick="location.reload()">Update Now</button>
</div>

<!-- Keyboard Shortcuts Modal -->
<div id="shortcutsModal" class="shortcuts-modal" onclick="if(event.target===this)toggleShortcutsModal()">
  <div class="shortcuts-content">
    <h2>
      ?? Keyboard Shortcuts
      <button class="shortcuts-close" onclick="toggleShortcutsModal()">?</button>
    </h2>
    <div class="shortcuts-grid">
      <div class="shortcut-row"><span>Play/Pause</span><span class="shortcut-keys"><span class="shortcut-key">Space</span></span></div>
      <div class="shortcut-row"><span>Next Track</span><span class="shortcut-keys"><span class="shortcut-key">Shift</span><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Previous Track</span><span class="shortcut-keys"><span class="shortcut-key">Shift</span><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Seek Forward</span><span class="shortcut-keys"><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Seek Backward</span><span class="shortcut-keys"><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Volume Up</span><span class="shortcut-keys"><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Volume Down</span><span class="shortcut-keys"><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Toggle Shuffle</span><span class="shortcut-keys"><span class="shortcut-key">S</span></span></div>
      <div class="shortcut-row"><span>Toggle Repeat</span><span class="shortcut-keys"><span class="shortcut-key">R</span></span></div>
      <div class="shortcut-row"><span>Toggle Radio</span><span class="shortcut-keys"><span class="shortcut-key">X</span></span></div>
      <div class="shortcut-row"><span>Toggle Lyrics</span><span class="shortcut-keys"><span class="shortcut-key">F</span></span></div>
      <div class="shortcut-row"><span>Toggle Queue</span><span class="shortcut-keys"><span class="shortcut-key">Q</span></span></div>
      <div class="shortcut-row"><span>Show Shortcuts</span><span class="shortcut-keys"><span class="shortcut-key">?</span></span></div>
      <div class="shortcut-row"><span>Close/Back</span><span class="shortcut-keys"><span class="shortcut-key">Esc</span></span></div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu">
  <div class="context-menu-item" onclick="contextMenuPlay()">
    <span>?</span> Play
  </div>
  <div class="context-menu-item" onclick="contextMenuQueue()">
    <span>+</span> Add to Queue
  </div>
  <div class="context-menu-item" onclick="contextMenuLike()">
    <span>??</span> Like
  </div>
  <div class="context-menu-divider"></div>
  <div class="context-menu-item" onclick="contextMenuPlaylist()">
    <span>??</span> Add to Playlist
  </div>
  <div class="context-menu-item" onclick="contextMenuShare()">
    <span>??</span> Share
  </div>
</div>

<!-- Pull to Refresh Indicator -->
<div id="ptrIndicator" class="ptr-indicator">?</div>

<!-- Sidebar Overlay for Mobile -->
<div id="sidebarOverlay" class="sidebar-overlay" onclick="closeMobileSidebar()"></div>


<!-- ═══════════════════════════════════════════════════════
     AUTH SCREEN
     ═══════════════════════════════════════════════════════ -->
<div id="authScreen" class="auth-screen">
  <div class="auth-bg">
    <!-- Netflix-style Scrolling Album Covers — dynamically populated -->
    <div class="album-scroll-container" id="albumScrollContainer">
      <!-- Rows populated by loadAuthCovers() from /api/cover-gallery -->
      <!-- Fallback: placeholder grid rendered inline -->
      <div class="album-row" id="albumRow0"></div>
      <div class="album-row" id="albumRow1"></div>
      <div class="album-row" id="albumRow2"></div>
      <div class="album-row" id="albumRow3"></div>
      <div class="album-row" id="albumRow4"></div>
      <div class="album-row" id="albumRow5"></div>
      <div class="album-row" id="albumRow6"></div>
    </div>
    <div class="auth-vignette"></div>
    <div class="auth-orb auth-orb-1"></div>
    <div class="auth-orb auth-orb-2"></div>
    <div class="auth-orb auth-orb-3"></div>
    <div class="auth-noise"></div>
  </div>
  <div class="auth-card">
    <div class="auth-brand">
      <span class="brand-icon"><img src="/assets/JuiceVaultLOGO.png" alt="JuiceVault"></span>
      <p class="brand-tag">The Vault · 999 Forever</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" data-tab="login">Sign In</button>
      <button class="auth-tab" data-tab="register">Sign Up</button>
    </div>
    <div id="authError" class="auth-error hidden"></div>

    <form id="loginForm">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com" required autocomplete="email">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPass" placeholder="Enter password" required autocomplete="current-password">
      </div>
      <button type="submit" class="btn btn-primary" id="loginBtn">Sign In</button>
    </form>

    <form id="registerForm" class="hidden">
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="regName" placeholder="Your name" required>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="regEmail" placeholder="you@example.com" required>
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="regPass" placeholder="Min 8 characters" required minlength="8">
      </div>
      <div class="form-group">
        <label>Invite Code</label>
        <input type="text" id="regInvite" placeholder="Enter invite code" required>
      </div>
      <button type="submit" class="btn btn-primary" id="regBtn">Create Account</button>
    </form>

    <div class="auth-footer">
      Dedicated to the legacy of Juice WRLD · 999
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════
     APP SHELL
     ═══════════════════════════════════════════════════════ -->
<div id="app" class="app">

  <div class="app-body">
    <!-- ═══ SIDEBAR ═══ -->
    <aside class="sidebar">
      <div class="sidebar-brand" onclick="navigateTo('home')">
        <span class="sb-icon"><img src="/assets/JuiceVaultIconLOGO.png" alt="JuiceVault"></span>
        <span class="sb-text"><span>JuiceVault</span></span>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Menu</div>
          <button class="nav-item active" data-page="home" onclick="navigateTo('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span>Home</span>
          </button>
          <button class="nav-item" data-page="catalog" onclick="navigateTo('catalog')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
            <span>Catalog</span>
          </button>
          <button class="nav-item" data-page="search" onclick="document.getElementById('searchInput').focus()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <span>Search</span>
          </button>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Collection</div>
          <button class="nav-item" data-page="library" onclick="navigateTo('library')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
            <span>Library</span>
            <span class="nav-badge liked-badge" id="libraryLikedBadge" style="display:none;">0</span>
          </button>
          <button class="nav-item" data-page="vault" onclick="navigateTo('vault')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            <span>Unsurfaced</span>
            <span class="nav-badge" id="vaultBadge"></span>
          </button>
          <button class="nav-item" data-page="sessions" onclick="navigateTo('sessions')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            <span>Sessions</span>
            <span class="nav-badge" id="sessionsBadge"></span>
          </button>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <button class="nav-item" data-page="settings" onclick="navigateTo('settings')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            <span>Settings</span>
          </button>
        </div>

        <div class="nav-section" id="adminNavSection" class="hidden">
          <div class="nav-section-title">Admin</div>
          <button class="nav-item" data-page="admin" onclick="navigateTo('admin')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            <span>Dashboard</span>
          </button>
        </div>
      </nav>

      <div class="sidebar-user">
        <div class="su-avatar" id="userAvatar">?</div>
        <div class="su-info">
          <div class="su-name" id="userName">User</div>
          <div class="su-role" id="userRole">user</div>
        </div>
        <button class="su-logout" onclick="logout()" title="Sign out">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </aside>

    <!-- ═══ MAIN CONTENT ═══ -->
    <main class="main" id="mainContent">
      <div class="main-header">
        <button class="mobile-menu-btn" onclick="openMobileSidebar()" aria-label="Open menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div class="search-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="searchInput" placeholder="Search songs, artists, producers..." autocomplete="off">
        </div>
        <div class="search-toggle-wrap">
          <button class="search-toggle-btn" id="searchLyricsToggle" onclick="toggleSearchLyrics()">🎤 Lyrics</button>
        </div>
        <div class="header-actions">
          <button class="header-btn" onclick="toggleQueue()" title="Queue (Q)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          </button>
        </div>
      </div>

      <!-- HOME PAGE -->
      <div id="page-home" class="page active">
        <div class="page-content home-page">
          <!-- HERO -->
          <div class="hero">
            <div class="hero-content">
              <div class="hero-label">🧃 THE VAULT</div>
              <h2>Every <span class="gradient-text">Juice WRLD</span> track,<br>one place</h2>
              <p>Stream unreleased leaks, fan-favorite tracks, and the complete catalog.</p>
              <div class="hero-actions">
                <button class="hero-btn hero-btn-primary" onclick="shufflePlayAll()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                  Shuffle Play
                </button>
                <button class="hero-btn hero-btn-secondary" onclick="navigateTo('catalog')">
                  Browse Catalog
                </button>
              </div>
              <div class="hero-stats" id="heroStats">
                <div class="hero-stat"><span class="hero-stat-val" id="statSongs">—</span><span class="hero-stat-label">Songs</span></div>
                <div class="hero-stat"><span class="hero-stat-val" id="statAvailable">—</span><span class="hero-stat-label">Streamable</span></div>
                <div class="hero-stat"><span class="hero-stat-val" id="statLyrics">—</span><span class="hero-stat-label">With Lyrics</span></div>
              </div>
            </div>
            <div class="hero-999">999</div>
          </div>

          <!-- QUICK ACCESS CARDS -->
          <div class="home-quick-access">
            <div class="quick-card qc-released" onclick="navigateTo('catalog'); setTimeout(()=>{const c=document.querySelector('[data-cat=released]'); if(c) filterCatalog(c,'released');},100)">
              <span class="qc-icon">💿</span>
              <span class="qc-label">Released</span>
            </div>
            <div class="quick-card qc-unreleased" onclick="navigateTo('catalog'); setTimeout(()=>{const c=document.querySelector('[data-cat=unreleased]'); if(c) filterCatalog(c,'unreleased');},100)">
              <span class="qc-icon">🔓</span>
              <span class="qc-label">Unreleased</span>
            </div>
            <div class="quick-card qc-vault" onclick="navigateTo('vault')">
              <span class="qc-icon">🔒</span>
              <span class="qc-label">Unsurfaced</span>
            </div>
            <div class="quick-card qc-sessions" onclick="navigateTo('sessions')">
              <span class="qc-icon">🎙️</span>
              <span class="qc-label">Sessions</span>
            </div>
          </div>

          <!-- MOST PLAYED -->
          <div class="section-header">
            <h2 class="section-title">Most Played</h2>
            <span class="section-action" onclick="navigateTo('catalog')">View All →</span>
          </div>
          <div class="home-carousel-wrap">
            <div id="mostPlayedSongs" class="home-carousel"></div>
          </div>

          <!-- RECENTLY PLAYED -->
          <div id="recentlyPlayedSection" style="display:none;">
            <div class="section-header">
              <h2 class="section-title">🕐 Recently Played</h2>
              <span class="section-action" onclick="clearRecentlyPlayed()">Clear</span>
            </div>
            <div id="recentlyPlayedList" class="song-list"></div>
          </div>

          <!-- RANDOM PICKS -->
          <div class="section-header">
            <h2 class="section-title">Random Picks</h2>
            <span class="section-action" onclick="loadRadioSuggestions()">Refresh ↻</span>
          </div>
          <div id="radioSongs" class="song-grid"></div>

          <!-- MOST LIKED SONGS -->
          <div class="section-header">
            <h2 class="section-title">🔥 Most Liked Songs</h2>
            <span class="section-action" onclick="navigateTo('catalog')">View All →</span>
          </div>
          <div class="home-carousel-wrap">
            <div id="mostLikedSongs" class="home-carousel"></div>
          </div>

          <!-- WITH LYRICS -->
          <div class="section-header">
            <h2 class="section-title">🎤 Songs With Lyrics</h2>
            <span class="section-action" onclick="navigateTo('catalog')">See All →</span>
          </div>
          <div class="home-carousel-wrap">
            <div id="lyricsSpotlight" class="home-carousel"></div>
          </div>

          <!-- RECENTLY ADDED -->
          <div class="section-header">
            <h2 class="section-title">Recently Added</h2>
            <span class="section-action" onclick="navigateTo('catalog')">View All →</span>
          </div>
          <div id="recentSongs" class="song-grid"></div>
        </div>
      </div>

      <!-- CATALOG PAGE -->
      <div id="page-catalog" class="page">
        <div class="page-content">
          <div class="section-header">
            <h2 class="section-title">Full Catalog</h2>
            <span class="section-subtitle" id="catalogCount"></span>
          </div>
          <div class="toolbar" id="catalogToolbar">
            <div class="filter-chip active" data-cat="" onclick="filterCatalog(this,'')">All</div>
            <div class="view-toggle">
              <button class="active" data-view="grid" onclick="setCatalogView('grid',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></button>
              <button data-view="list" onclick="setCatalogView('list',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></button>
            </div>
          </div>
          <div class="filter-bar" id="catalogFilterBar">
            <select class="filter-select" id="eraFilter" onchange="applyCatalogFilters()">
              <option value="">All Eras</option>
            </select>
            <select class="filter-select" id="sortFilter" onchange="applyCatalogFilters()">
              <option value="name-asc">Name A-Z</option>
              <option value="name-desc">Name Z-A</option>
              <option value="playCount-desc">Most Played</option>
              <option value="createdAt-desc">Recently Added</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;font-size:0.78rem;color:var(--text-secondary);cursor:pointer;">
              <input type="checkbox" id="lyricsOnlyFilter" onchange="applyCatalogFilters()" style="accent-color:var(--purple-400);">
              Has Lyrics
            </label>
            <div class="filter-active-chips" id="activeFilterChips"></div>
          </div>
          <div id="catalogContent"></div>
          <div id="catalogSentinel" class="infinite-sentinel" style="display:none;"><div class="load-more-spinner"></div></div>
        </div>
      </div>

      <!-- SEARCH RESULTS PAGE -->
      <div id="page-search" class="page">
        <div class="page-content">
          <div class="section-header">
            <h2 class="section-title">Search Results</h2>
            <span class="section-subtitle" id="searchCount"></span>
          </div>
          <div id="searchResults"></div>
          <div id="searchPagination" class="pagination"></div>
        </div>
      </div>

      <!-- SONG DETAIL PAGE -->
      <div id="page-detail" class="page">
        <div class="page-content" id="detailContent"></div>
      </div>

      <!-- UNSURFACED VAULT PAGE -->
      <div id="page-vault" class="page">
        <div class="page-content">
          <div class="vault-header">
            <div class="vault-icon">🔒</div>
            <h2>The Unsurfaced Vault</h2>
            <p>Songs known to exist but never leaked or released. No audio. No files. Just names, rumors, and hope. If they ever surface, they'll be here first.</p>
            <div class="vault-count" id="vaultCount">Loading...</div>
          </div>
          <div class="toolbar" id="vaultToolbar">
            <input type="text" class="search-input" id="vaultSearch" placeholder="Search unsurfaced songs..." oninput="searchVault(this.value)" style="max-width:300px;padding:8px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-full);color:var(--text);font-size:0.85rem;">
          </div>
          <div id="vaultContent" class="vault-grid"></div>
          <div id="vaultPagination" class="pagination"></div>
        </div>
      </div>

      <!-- RECORDING SESSIONS PAGE -->
      <div id="page-sessions" class="page">
        <div class="page-content">
          <div class="vault-header">
            <div class="vault-icon">🎙️</div>
            <h2>Recording Sessions</h2>
            <p>Raw studio recordings — multiple takes, engineer chatter, and works-in-progress. The unfiltered creative process.</p>
            <div class="vault-count" id="sessionsCount">Loading...</div>
          </div>
          <div id="sessionsContent" class="vault-grid"></div>
          <div id="sessionsPagination" class="pagination"></div>
        </div>
      </div>


      <!-- LIBRARY PAGE -->
      <div id="page-library" class="page">
        <div class="page-content">
          <div class="section-header">
            <h2 class="section-title">Your Library</h2>
          </div>
          
          <!-- Like Statistics -->
          <div id="likeStatsSection" class="like-stats-grid" style="display:none;"></div>
          
          <!-- Streak Banner -->
          <div id="streakBanner" class="streak-banner" style="display:none;"></div>
          
          <!-- Recently Liked Quick List -->
          <div id="recentlyLikedSection" class="recently-liked-section" style="display:none;">
            <h4 style="font-family:var(--font-display);font-size:0.9rem;font-weight:700;margin-bottom:12px;">Recently Liked</h4>
            <div id="recentlyLikedList" class="recently-liked-list"></div>
          </div>
          
          <!-- Liked Songs Controls -->
          <div class="section-header" style="margin-top:8px;">
            <h3 style="font-family:var(--font-display);font-weight:700;">Liked Songs</h3>
            <button class="section-action" onclick="toggleBulkSelectMode()" id="bulkSelectToggle">Select</button>
          </div>
          
          <div class="library-controls" id="libraryControls">
            <select id="likedSortSelect" onchange="changeLikedSort(this.value)">
              <option value="recently-liked">Recently Liked</option>
              <option value="name">Name A-Z</option>
              <option value="playCount">Most Played</option>
            </select>
            <select id="likedFilterSelect" onchange="changeLikedFilter(this.value)">
              <option value="">All Categories</option>
              <option value="released">Released</option>
              <option value="unreleased">Unreleased</option>
            </select>
            <div class="library-actions">
              <button class="library-action-btn" onclick="shareLikedSongs()">↗ Share</button>
              <button class="library-action-btn" onclick="exportLikedToPlaylist()">📤 Export to Playlist</button>
              <button class="library-action-btn" onclick="playLikedSongs()">▶ Play All</button>
            </div>
          </div>
          
          <div id="likedSongsGrid" class="song-grid" style="margin-bottom:32px;"></div>
          
          <!-- Like Recommendations -->
          <div id="likeRecommendations" class="like-recommendations" style="display:none;">
            <h4>🎯 Songs You Might Like</h4>
            <div id="recommendationsGrid" class="song-grid"></div>
          </div>
          
          <div class="section-header">
            <h3 style="font-family:var(--font-display);font-weight:700;">Playlists</h3>
          </div>
          <div id="playlistGrid" class="playlist-grid"></div>
        </div>
      </div>

      <!-- PLAYLIST DETAIL PAGE -->
      <div id="page-playlist" class="page">
        <div class="page-content" id="playlistDetailContent"></div>
      </div>

      <!-- SETTINGS PAGE -->
      <div id="page-settings" class="page">
        <div class="page-content">
          <div class="section-header">
            <h2 class="section-title">Settings</h2>
          </div>

          <div class="settings-section">
            <h3>🎛 Equalizer</h3>
            <div class="eq-container">
              <div class="eq-presets" id="eqPresets"></div>
              <div class="eq-sliders" id="eqSliders"></div>
              <canvas class="eq-curve" id="eqCurve" width="600" height="80"></canvas>
              <div class="custom-preset-actions">
                <button onclick="saveCustomEQPreset()">💾 Save Preset</button>
                <button onclick="resetEQ()">↩ Reset to Flat</button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>🎨 Appearance</h3>
            <div style="padding:16px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);">
              <p style="color:var(--text-muted);font-size:0.85rem;">More customization options coming soon.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN PAGE -->
      <div id="page-admin" class="page">
        <div class="page-content" id="adminContent">
          <div class="section-header">
            <h2 class="section-title">Admin Dashboard</h2>
          </div>
          <div id="adminStats" class="admin-stats"></div>
          <div id="adminSections"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- ═══ PLAYER BAR ═══ -->
  <div class="player" id="playerBar">
    <div class="player-left">
      <div class="player-art" onclick="currentSong && navigateToDetail(currentSong.id)" style="position:relative;">
        <div class="pa-ph"></div>
        <button class="mini-player-like" id="miniPlayerLikeBtn" onclick="event.stopPropagation();toggleCurrentSongLike(this)" title="Like current song (L)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
      </div>
      <div class="player-song-info">
        <div class="player-song-name" id="playerName" onclick="currentSong && navigateToDetail(currentSong.id)">Not Playing</div>
        <div class="player-song-artist" id="playerArtist"></div>
      </div>
    </div>

    <div class="player-center">
      <div class="player-controls">
        <button class="p-btn" id="btnShuffle" onclick="toggleShuffle()" title="Shuffle (S)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
        </button>
        <button class="p-btn" onclick="playPrev()" title="Previous">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="p-btn p-btn-play" id="btnPlayPause" onclick="togglePlay()">
          <svg viewBox="0 0 24 24" fill="currentColor" id="playIcon"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        </button>
        <button class="p-btn" onclick="playNext()" title="Next">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 18h2V6h-2zM6 18l8.5-6L6 6z"/></svg>
        </button>
        <button class="p-btn" id="btnRepeat" onclick="toggleRepeat()" title="Repeat (R)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>
        </button>
      </div>
      <div class="player-progress">
        <span class="player-time" id="playerCurTime">0:00</span>
        <div class="progress-bar" id="progressBar" onclick="seekAudio(event)">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="player-time" id="playerDuration">0:00</span>
      </div>
    </div>

    <div class="player-right">
      <button class="p-btn p-btn-labeled" id="btnRadio" onclick="toggleRadio()" title="Radio (X)">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.4"/><circle cx="12" cy="12" r="2" fill="currentColor"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.4"/><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"/></svg>
        <span class="btn-label">Radio</span>
      </button>
      <button class="p-btn p-btn-labeled" id="btnLyrics" onclick="toggleFullscreenLyrics()" title="Lyrics (F)">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
        <span class="btn-label">Lyrics</span>
      </button>
      <div class="volume-wrap">
        <div class="volume-tooltip" id="volumeTooltip">70%</div>
        <button class="p-btn" id="btnVolume" onclick="toggleMute()">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" id="volumeIcon"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
        </button>
        <div class="volume-bar" id="volumeBar" onclick="setVolume(event)">
          <div class="volume-fill" id="volumeFill"></div>
        </div>
      </div>
      
      <!-- Like Button -->
      <button class="p-btn player-like-btn" id="playerLikeBtn" onclick="toggleCurrentSongLike(this)" title="Like">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </button>
      
      <!-- Add to Playlist Button -->
      <button class="p-btn player-playlist-btn" id="playerPlaylistBtn" onclick="openPlaylistModalForCurrentSong()" title="Add to playlist">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      
      <button class="p-btn p-btn-labeled" id="btnQueue" onclick="toggleQueue()" title="Queue (Q)" style="position:relative">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        <span class="queue-badge" id="queueBadge" style="display:none">0</span>
        <span class="btn-label">Queue</span>
      </button>
    </div>
  </div>
</div>

<!-- ═══ QUEUE PANEL ═══ -->
<div id="queuePanel" class="queue-panel">
  <div class="queue-header">
    <h3>Queue</h3>
    <button class="queue-close" onclick="toggleQueue()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="queue-body" id="queueBody"></div>
</div>

<!-- ═══════════════════════════════════════════════════════
     FULLSCREEN LYRICS V3 — Cinematic Experience
     ═══════════════════════════════════════════════════════ -->
<div id="fsLyrics" class="fs-lyrics">
  <!-- Animated Background -->
  <div class="fs-bg">
    <div class="fs-bg-img" id="fsBgImg"></div>
    <div class="fs-bg-overlay"></div>
    <div class="fs-gradient-orb fs-orb-1"></div>
    <div class="fs-gradient-orb fs-orb-2"></div>
    <div class="fs-gradient-orb fs-orb-3"></div>
  </div>

  <!-- Glassmorphism Header -->
  <div class="fs-header">
    <button class="fs-close" onclick="toggleFullscreenLyrics()" title="Close (Esc)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
    </button>
    
    <div class="fs-song-info">
      <div class="fs-art-wrap">
        <div class="fs-art" id="fsArt"></div>
      </div>
      <div class="fs-song-meta">
        <div class="fs-song-name" id="fsSongName"></div>
        <div class="fs-song-artist" id="fsSongArtist"></div>
      </div>
    </div>

    <!-- Display Mode Selector -->
    <div class="fs-header-tools">
      <div class="fs-mode-selector">
        <button class="fs-mode-btn active" data-mode="synced" onclick="setLyricsMode('synced')" title="Synced">●</button>
        <button class="fs-mode-btn" data-mode="raw" onclick="setLyricsMode('raw')" title="Raw">☰</button>
      </div>
      
      <button class="fs-tool-btn" onclick="toggleInfoPanel()" title="Song Info">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
        <span class="tool-tooltip">Info</span>
      </button>
      
      <button class="fs-tool-btn" onclick="toggleSharePanel()" title="Share">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
        <span class="tool-tooltip">Share</span>
      </button>
      
      <button class="fs-tool-btn" onclick="toggleSettingsPanel()" title="Settings">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        <span class="tool-tooltip">Settings</span>
      </button>
      
      <button class="fs-tool-btn" id="fsOffsetToggle" onclick="document.getElementById('fsOffsetBar').classList.toggle('show')" title="Timing">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <span class="tool-tooltip">Timing</span>
      </button>
      
      <button class="fs-tool-btn" id="fsRegenBtn" onclick="regenLyricsTiming()" title="Regenerate" style="display:none;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
        <span class="tool-tooltip">Regenerate</span>
      </button>
    </div>
  </div>

  <!-- Enhanced Offset Bar -->
  <div class="fs-offset-bar" id="fsOffsetBar">
    <label>
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Timing Offset
    </label>
    <div class="fs-offset-slider-wrap">
      <button onclick="adjustOffset(-100)">-</button>
      <input type="range" id="fsOffsetSlider" min="-5000" max="5000" step="50" value="0" oninput="updateLyricsOffset(this.value)">
      <button onclick="adjustOffset(100)">+</button>
    </div>
    <span class="fs-offset-val" id="fsOffsetVal">0ms</span>
    <div class="fs-offset-actions">
      <button onclick="nudgeOffset(-50)">← 50ms</button>
      <button onclick="nudgeOffset(50)">50ms →</button>
      <button onclick="document.getElementById('fsOffsetSlider').value=0;updateLyricsOffset(0)">Reset</button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="fs-content">
    <!-- Lyrics Body -->
    <div class="fs-body" id="fsBody"></div>
    
    <!-- Large Art for Art Focus Mode -->
    <div class="fs-art-large" id="fsArtLarge" style="display:none;"></div>
    
    <!-- Info Panel (Sidebar) -->
    <div class="fs-info-panel" id="fsInfoPanel">
      <div class="fs-info-header">
        <h3>Song Details</h3>
        <button class="fs-info-close" onclick="toggleInfoPanel()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="fs-info-content" id="fsInfoContent">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- Settings Panel (Floating) -->
  <div class="fs-settings-panel" id="fsSettingsPanel">
    <div class="fs-settings-header">
      <h4>Lyrics Settings</h4>
      <button class="fs-settings-close" onclick="toggleSettingsPanel()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    
    <!-- Font Size -->
    <div class="fs-setting-row">
      <label>Font Size</label>
      <div class="fs-font-size-controls">
        <button class="fs-font-btn" onclick="adjustFontSize(-0.2)">A</button>
        <span class="fs-font-value" id="fsFontValue">100%</span>
        <button class="fs-font-btn" onclick="adjustFontSize(0.2)" style="font-size:1.1rem;">A</button>
      </div>
    </div>
    
    <!-- Theme Selection -->
    <div class="fs-setting-row">
      <label>Theme</label>
      <div class="fs-theme-grid">
        <div class="fs-theme-option fs-theme-dark active" onclick="setLyricsTheme('dark')" title="Dark"></div>
        <div class="fs-theme-option fs-theme-light" onclick="setLyricsTheme('light')" title="Light"></div>
        <div class="fs-theme-option fs-theme-purple" onclick="setLyricsTheme('purple')" title="Purple"></div>
        <div class="fs-theme-option fs-theme-pink" onclick="setLyricsTheme('pink')" title="Pink"></div>
        <div class="fs-theme-option fs-theme-cyan" onclick="setLyricsTheme('cyan')" title="Cyan"></div>
        <div class="fs-theme-option fs-theme-orange" onclick="setLyricsTheme('orange')" title="Orange"></div>
        <div class="fs-theme-option fs-theme-red" onclick="setLyricsTheme('red')" title="Red"></div>
        <div class="fs-theme-option fs-theme-green" onclick="setLyricsTheme('green')" title="Green"></div>
      </div>
    </div>
    
    <!-- Text Alignment -->
    <div class="fs-setting-row">
      <label>Alignment</label>
      <div class="fs-align-options">
        <button class="fs-align-btn" onclick="setLyricsAlign('left')" title="Left">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="18" y2="18"/></svg>
        </button>
        <button class="fs-align-btn active" onclick="setLyricsAlign('center')" title="Center">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <button class="fs-align-btn" onclick="setLyricsAlign('justify')" title="Justify">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
      </div>
    </div>
    
    <!-- Line Spacing -->
    <div class="fs-setting-row">
      <label>Line Spacing</label>
      <input type="range" class="fs-spacing-slider" id="fsSpacingSlider" min="0" max="30" value="4" oninput="setLineSpacing(this.value)">
    </div>
    
    <!-- Accessibility -->
    <div class="fs-setting-row">
      <label>Accessibility</label>
      <div class="fs-accessibility-options">
        <div class="fs-toggle-row">
          <span>High Contrast</span>
          <div class="fs-toggle" id="fsHighContrastToggle" onclick="toggleHighContrast()"></div>
        </div>
        <div class="fs-toggle-row">
          <span>Large Text</span>
          <div class="fs-toggle" id="fsLargeTextToggle" onclick="toggleLargeText()"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Panel -->
  <div class="fs-share-panel" id="fsSharePanel">
    <div class="fs-share-header">
      <h4>Share Lyrics</h4>
      <button class="fs-share-close" onclick="toggleSharePanel()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="fs-share-preview">
      <div class="fs-share-line" id="fsShareLine">"Click a lyric line to share it"</div>
      <div class="fs-share-song" id="fsShareSong"></div>
    </div>
    <div class="fs-share-actions">
      <button class="fs-share-btn" onclick="shareToTwitter()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        X/Twitter
      </button>
      <button class="fs-share-btn" onclick="copyLyrics()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        Copy
      </button>
      <button class="fs-share-btn" onclick="showQRCode()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        QR Code
      </button>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="fs-qr-modal" id="fsQRModal" onclick="if(event.target===this)hideQRCode()">
    <div class="fs-qr-content">
      <h3 style="margin-bottom:8px;font-family:var(--font-display);">Share Song</h3>
      <p style="color:var(--text-muted);font-size:0.8rem;margin-bottom:20px;">Scan to open on mobile</p>
      <div class="fs-qr-code">
        <div class="fs-qr-placeholder" id="fsQRPlaceholder"></div>
      </div>
      <button class="modal-btn modal-btn-primary" onclick="hideQRCode()" style="margin-top:20px;width:100%;">Close</button>
    </div>
  </div>

  <!-- Enhanced Player Bar -->
  <div class="fs-player-bar">
    <div class="fs-player-main">
      <!-- Left: Speed & A-B Repeat -->
      <div style="display:flex;gap:16px;align-items:center;">
        <div class="fs-speed-control">
          <span style="font-size:0.7rem;color:var(--text-muted);margin-right:4px;">Speed</span>
          <button class="fs-speed-btn" data-speed="0.5" onclick="setPlaybackSpeed(0.5)">0.5x</button>
          <button class="fs-speed-btn active" data-speed="1" onclick="setPlaybackSpeed(1)">1x</button>
          <button class="fs-speed-btn" data-speed="1.5" onclick="setPlaybackSpeed(1.5)">1.5x</button>
          <button class="fs-speed-btn" data-speed="2" onclick="setPlaybackSpeed(2)">2x</button>
        </div>
        
        <div class="fs-ab-repeat" title="A-B Loop">
          <span style="font-size:0.7rem;color:var(--text-muted);">AB</span>
          <button class="fs-ab-btn" id="fsABtn" onclick="setABPoint('A')">A</button>
          <button class="fs-ab-btn" id="fsBBtn" onclick="setABPoint('B')">B</button>
          <button class="fs-ab-btn" id="fsClearAB" onclick="clearABLoop()" style="width:auto;padding:0 8px;">✕</button>
        </div>
      </div>

      <!-- Center: Progress & Transport -->
      <div class="fs-player-center">
        <div class="fs-progress-row">
          <span class="fs-time" id="fsCurTime">0:00</span>
          <div class="fs-progress" onclick="seekAudio(event)">
            <div class="fs-progress-fill" id="fsProgressFill"></div>
          </div>
          <span class="fs-time" id="fsDuration">0:00</span>
        </div>
        <div class="fs-transport">
          <button class="fs-tbtn" onclick="toggleShuffle()" id="fsShuffleBtn" title="Shuffle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
          </button>
          <button class="fs-tbtn" onclick="playPrev()" title="Previous">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
          </button>
          <button class="fs-tbtn fs-tbtn-play" id="fsPlayBtn" onclick="togglePlay()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" id="fsPlayIcon"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          </button>
          <button class="fs-tbtn" onclick="playNext()" title="Next">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M16 18h2V6h-2zM6 18l8.5-6L6 6z"/></svg>
          </button>
          <button class="fs-tbtn" onclick="toggleRepeat()" id="fsRepeatBtn" title="Repeat">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 014-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 01-4 4H3"/></svg>
          </button>
        </div>
        <div class="fs-upnext" id="fsUpNext"></div>
      </div>

      <!-- Right: Volume & Sleep Timer -->
      <div class="fs-player-right">
        <div class="fs-sleep-timer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text-muted);"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <select class="fs-sleep-select" id="fsSleepSelect" onchange="setSleepTimer(this.value)">
            <option value="">Off</option>
            <option value="15">15 min</option>
            <option value="30">30 min</option>
            <option value="45">45 min</option>
            <option value="60">1 hour</option>
            <option value="end">End of song</option>
          </select>
        </div>
        
        <div class="fs-volume-wrap">
          <button class="fs-tbtn" onclick="toggleMute()" id="fsMuteBtn" style="padding:4px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="fsVolumeIcon"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>
          </button>
          <div class="fs-volume-slider" id="fsVolumeSlider" onclick="setLyricsVolume(event)">
            <div class="fs-volume-fill" id="fsVolumeFill"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pin Toast Notification -->
  <div class="fs-pin-toast" id="fsPinToast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
    <span>Line pinned! Click again to unpin</span>
  </div>

  <!-- Copy Feedback -->
  <div class="fs-copy-feedback" id="fsCopyFeedback">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    <span>Copied to clipboard!</span>
  </div>
</div>


<!-- ═══ ADD TO PLAYLIST MODAL ═══ -->
<div id="playlistModal" class="modal-overlay" onclick="if(event.target===this)closePlaylistModal()">
  <div class="modal-box">
    <h3>Add to Playlist</h3>
    <div class="modal-playlist-list" id="modalPlaylistList"></div>
    <div class="modal-actions">
      <button class="modal-btn" onclick="closePlaylistModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="createPlaylistFromModal()">+ New Playlist</button>
    </div>
  </div>
</div>

<!-- ═══ CREATE/EDIT PLAYLIST MODAL ═══ -->
<div id="playlistEditModal" class="modal-overlay" onclick="if(event.target===this)closePlaylistEditModal()">
  <div class="modal-box" style="max-width: 500px;">
    <h3 id="playlistEditTitle">Create Playlist</h3>
    <div style="display: flex; gap: 20px; margin-bottom: 16px;">
      <div class="cover-upload-area" id="coverUploadArea" onclick="document.getElementById('coverFileInput').click()">
        <span style="font-size: 2rem;">🖼️</span>
        <span style="font-size: 0.8rem; color: var(--text-muted);">Click to upload cover</span>
        <div class="cover-upload-overlay">
          <span style="font-size: 1.5rem;">📷</span>
          <span style="font-size: 0.75rem;">Change</span>
        </div>
      </div>
      <input type="file" id="coverFileInput" accept="image/*" style="display: none;" onchange="handleCoverUpload(event)">
      <div style="flex: 1;">
        <div class="form-group">
          <label>Playlist Name</label>
          <input type="text" id="playlistNameInput" placeholder="My Awesome Playlist">
        </div>
        <div class="form-group">
          <label>Description</label>
          <div class="rich-editor">
            <div class="rich-editor-toolbar">
              <button class="rich-editor-btn" onclick="formatDesc('bold')" title="Bold"><b>B</b></button>
              <button class="rich-editor-btn" onclick="formatDesc('italic')" title="Italic"><i>I</i></button>
              <button class="rich-editor-btn" onclick="formatDesc('underline')" title="Underline"><u>U</u></button>
            </div>
            <div class="rich-editor-content" id="playlistDescInput" contenteditable="true" placeholder="Add a description..."></div>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-bottom: 16px;">
      <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
        <input type="checkbox" id="playlistSmartToggle" onchange="toggleSmartRules()">
        <span>🤖 Smart Playlist (auto-populate by rules)</span>
      </label>
      <div id="smartRulesSection" class="smart-rules-editor" style="display: none; margin-top: 12px;">
        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">Songs matching ANY rule will be included:</p>
        <div id="smartRulesContainer"></div>
        <button class="modal-btn" onclick="addSmartRule()" style="margin-top: 10px;">+ Add Rule</button>
      </div>
    </div>
    <div style="margin-bottom: 16px;">
      <label style="display: flex; align-items: center; gap: 8px; font-size: 0.85rem; cursor: pointer;">
        <input type="checkbox" id="playlistPublicToggle">
        <span>🌐 Make this playlist public (shareable)</span>
      </label>
    </div>
    <div class="modal-actions">
      <button class="modal-btn" onclick="closePlaylistEditModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="savePlaylistEdit()">Save Playlist</button>
    </div>
  </div>
</div>

<!-- ═══ SHARE PLAYLIST MODAL ═══ -->
<div id="sharePlaylistModal" class="modal-overlay" onclick="if(event.target===this)closeShareModal()">
  <div class="modal-box">
    <h3>🔗 Share Playlist</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Anyone with this link can view your playlist:</p>
    <div class="share-link-box">
      <input type="text" id="shareLinkInput" readonly>
      <button onclick="copyShareLink()">Copy</button>
    </div>
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
      <h4 style="font-size: 0.85rem; margin-bottom: 12px;">Export Playlist</h4>
      <div style="display: flex; gap: 8px;">
        <button class="modal-btn" onclick="exportPlaylist('json')">📄 JSON</button>
        <button class="modal-btn" onclick="exportPlaylist('csv')">📊 CSV</button>
        <button class="modal-btn" onclick="exportPlaylist('spotify')">🎵 Spotify URI List</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top: 20px;">
      <button class="modal-btn" onclick="closeShareModal()">Close</button>
    </div>
  </div>
</div>

<!-- ═══ IMPORT PLAYLIST MODAL ═══ -->
<div id="importPlaylistModal" class="modal-overlay" onclick="if(event.target===this)closeImportModal()">
  <div class="modal-box" style="max-width: 450px;">
    <h3>📥 Import Playlist</h3>
    <div class="import-drop-zone" id="importDropZone" onclick="document.getElementById('importFileInput').click()">
      <div style="font-size: 2.5rem; margin-bottom: 12px;">📁</div>
      <p style="font-weight: 600; margin-bottom: 4px;">Click or drop files here</p>
      <p style="font-size: 0.75rem;">Supports: JSON, CSV, Spotify links</p>
    </div>
    <input type="file" id="importFileInput" accept=".json,.csv,.txt" style="display: none;" onchange="handleImportFile(event)">
    <div style="margin-top: 16px;">
      <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Or paste Spotify/Apple Music playlist URL:</p>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="importUrlInput" placeholder="https://open.spotify.com/playlist/..." style="flex: 1; padding: 10px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text);">
        <button class="modal-btn modal-btn-primary" onclick="importFromUrl()">Import</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top: 20px;">
      <button class="modal-btn" onclick="closeImportModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ═══ MERGE PLAYLISTS MODAL ═══ -->
<div id="mergePlaylistModal" class="modal-overlay" onclick="if(event.target===this)closeMergeModal()">
  <div class="modal-box">
    <h3>🔀 Merge Playlists</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Select a playlist to merge with the current one:</p>
    <div class="modal-playlist-list" id="mergePlaylistList"></div>
    <label style="display: flex; align-items: center; gap: 8px; font-size: 0.8rem; margin-bottom: 16px; cursor: pointer;">
      <input type="checkbox" id="mergeRemoveDuplicates" checked>
      <span>Remove duplicate songs</span>
    </label>
    <div class="modal-actions">
      <button class="modal-btn" onclick="closeMergeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- ═══ COMPARE PLAYLISTS MODAL ═══ -->
<div id="comparePlaylistModal" class="modal-overlay" onclick="if(event.target===this)closeCompareModal()">
  <div class="modal-box" style="max-width: 600px;">
    <h3>⚖️ Compare Playlists</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Select a playlist to compare:</p>
    <div class="modal-playlist-list" id="comparePlaylistList"></div>
    <div id="compareResults" style="display: none;"></div>
    <div class="modal-actions">
      <button class="modal-btn" onclick="closeCompareModal()">Close</button>
    </div>
  </div>
</div>

<!-- ═══ MOVE SONG POSITION MODAL ═══ -->
<div id="movePositionModal" class="modal-overlay" onclick="if(event.target===this)closeMovePositionModal()">
  <div class="modal-box" style="max-width: 300px;">
    <h3>📍 Move to Position</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Enter the new position number:</p>
    <input type="number" id="movePositionInput" class="position-modal-input" min="1" placeholder="1">
    <div class="modal-actions">
      <button class="modal-btn" onclick="closeMovePositionModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="confirmMovePosition()">Move</button>
    </div>
  </div>
</div>

<!-- ═══ PLAYLIST RADIO MODAL ═══ -->
<div id="playlistRadioModal" class="modal-overlay" onclick="if(event.target===this)closePlaylistRadioModal()">
  <div class="modal-box" style="max-width: 500px;">
    <h3>📻 Playlist Radio</h3>
    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">Songs similar to your playlist that aren't in it yet:</p>
    <div id="playlistRadioResults" style="max-height: 400px; overflow-y: auto;">
      <div class="loading"><div class="spinner"></div></div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn modal-btn-primary" onclick="addRadioToPlaylist()">Add All to Playlist</button>
      <button class="modal-btn" onclick="closePlaylistRadioModal()">Close</button>
    </div>
  </div>
</div>

<!-- ═══ TOAST CONTAINER ═══ -->
<div class="toast-container" id="toastContainer"></div>

<script>
/* ═══════════════════════════════════════════════════════
   JUICEVAULT V1 — Complete Application Logic
   ═══════════════════════════════════════════════════════ */

// ─── State ──────────────────────────────────────────────
let user = null;
let token = localStorage.getItem('jv_token');
let currentSong = null;
let currentPage = 'home';
let catalogPage = 1;
let catalogCategory = '';
let catalogView = 'grid';
let searchPage = 1;
let searchQuery = '';
let queue = [];
let history_stack = [];
let shuffleOn = false;
let repeatMode = 0; // 0=off, 1=all, 2=one
let radioMode = false;
let isPlaying = false;
let volume = 0.7;
let previousVolume = 0.7;
let fsLyricsOpen = false;
let fsLines = [];
let categories = [];
let timedLyricsData = null;  // Array of {start_ms, end_ms, text} from AssemblyAI
let lyricsOffset = 0;        // Manual offset in ms (positive = lyrics earlier)
let userScrolling = false;   // Tracks if user is manually scrolling lyrics
let userScrollTimer = null;  // Timer to resume auto-scroll

const audio = new Audio();
audio.volume = volume;
audio.crossOrigin = 'anonymous';

// ─── V2: New State ─────────────────────────────────────
let searchByLyrics = false;
let catalogEra = '';
let catalogSort = 'name-asc';
let catalogHasLyrics = false;
let catalogLoading = false;
let catalogHasMore = true;
let catalogAllSongs = [];
let userLikes = {};       // { songId: true/false }
let userPlaylists = [];
let playlistModalSongId = null;

// ─── V3: Enhanced Like System State ────────────────────
let likeCounts = {};           // { songId: totalLikes }
let recentlyLiked = [];        // Array of { song, timestamp }
let likeHistory = [];          // All like actions with timestamps
let likeStreak = { count: 0, weekStart: null };
let likedSongsSort = 'recently-liked'; // 'recently-liked', 'name', 'playCount'
let likedSongsFilter = '';     // 'released', 'unreleased', ''
let selectedSongs = new Set(); // For bulk operations
let bulkSelectMode = false;
let offlineLikeQueue = [];     // Queue likes when offline
let isOnline = navigator.onLine;
let friendLikes = {};          // { songId: [friendNames] }
let likeRecommendations = [];  // Songs similar to likes
let undoTimeout = null;
let lastUnlikeSong = null;
let miniPlayerCollapsed = false;

// ─── V2: Web Audio EQ ──────────────────────────────────
let audioCtx = null;
let eqFilters = [];
let eqSourceNode = null;
let eqConnected = false;
const EQ_BANDS = [
  { freq: 60, label: '60' },
  { freq: 170, label: '170' },
  { freq: 310, label: '310' },
  { freq: 600, label: '600' },
  { freq: 1000, label: '1K' },
  { freq: 3000, label: '3K' },
  { freq: 6000, label: '6K' },
  { freq: 14000, label: '14K' },
];
const EQ_PRESETS = {
  flat: { name: '🎵 Flat', gains: [0,0,0,0,0,0,0,0] },
  bass: { name: '🔊 Bass Boost', gains: [8,6,4,1,0,-1,-1,0] },
  vocal: { name: '🎤 Vocal Boost', gains: [-1,0,2,4,4,2,0,-1] },
  treble: { name: '✨ Treble Boost', gains: [-2,-1,0,0,1,3,5,6] },
  deep: { name: '🌊 Deep Bass', gains: [10,8,4,0,-2,-3,-2,0] },
  radio: { name: '📻 Radio', gains: [0,-1,0,2,4,3,1,0] },
  acoustic: { name: '🎹 Acoustic', gains: [2,1,0,1,2,2,3,2] },
};
let currentEQPreset = 'flat';
let customEQGains = [0,0,0,0,0,0,0,0];

// ─── API Helper ─────────────────────────────────────────
async function api(path, opts = {}) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(`/api${path}`, { ...opts, headers, credentials: 'include' });
  if (res.status === 401) { logout(); throw new Error('Unauthorized'); }
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

// ─── Auth ───────────────────────────────────────────────
document.querySelectorAll('.auth-tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.auth-tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
    document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
    document.getElementById('authError').classList.add('hidden');
  });
});

document.getElementById('loginForm').addEventListener('submit', async e => {
  e.preventDefault();
  const btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Signing in...';
  try {
    const data = await api('/auth/login', {
      method: 'POST',
      body: JSON.stringify({
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPass').value
      })
    });
    token = data.token;
    localStorage.setItem('jv_token', token);
    user = data.user;
    enterApp();
  } catch (err) {
    showAuthError(err.message);
  } finally { btn.disabled = false; btn.textContent = 'Sign In'; }
});

document.getElementById('registerForm').addEventListener('submit', async e => {
  e.preventDefault();
  const btn = document.getElementById('regBtn');
  btn.disabled = true; btn.textContent = 'Creating...';
  try {
    const data = await api('/auth/register', {
      method: 'POST',
      body: JSON.stringify({
        displayName: document.getElementById('regName').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPass').value,
        inviteCode: document.getElementById('regInvite').value
      })
    });
    token = data.token;
    localStorage.setItem('jv_token', token);
    user = data.user;
    enterApp();
  } catch (err) {
    showAuthError(err.message);
  } finally { btn.disabled = false; btn.textContent = 'Create Account'; }
});

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg; el.classList.remove('hidden');
}

function logout() {
  token = null; user = null;
  localStorage.removeItem('jv_token');
  audio.pause(); audio.src = '';
  document.getElementById('authScreen').style.display = '';
  document.getElementById('app').classList.remove('visible');
  fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
}

async function checkAuth() {
  if (!token) return;
  try {
    const data = await api('/auth/me');
    user = data.user;
    enterApp();
  } catch { token = null; localStorage.removeItem('jv_token'); }
}

function enterApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  document.getElementById('userName').textContent = user.displayName;
  document.getElementById('userRole').textContent = user.role;
  document.getElementById('userAvatar').textContent = user.displayName.charAt(0).toUpperCase();

  const adminSection = document.getElementById('adminNavSection');
  if (user.role === 'admin') {
    adminSection.classList.remove('hidden');
  } else {
    adminSection.classList.add('hidden');
  }

  loadHome();
  loadCategories();
  loadEras();
  loadUserLikes();
  loadUserPlaylists();
}

// ─── Navigation ─────────────────────────────────────────
function navigateTo(page) {
  currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  document.querySelector('.main').scrollTo(0, 0);

  if (page === 'catalog' && !document.getElementById('catalogContent').children.length) loadCatalog();
  if (page === 'library') loadLibrary();
  if (page === 'settings') renderEQPage();
  if (page === 'vault') loadVault();
  if (page === 'sessions') loadSessions();
  if (page === 'admin') loadAdmin();
}

function navigateToDetail(songId) {
  navigateTo('detail');
  loadSongDetail(songId);
}

// ─── Home ───────────────────────────────────────────────
async function loadHome() {
  try {
    const [recent, mostPlayed, withLyrics, mostLiked, analytics] = await Promise.all([
      api('/songs?page=1&pageSize=8&excludeCategories=unsurfaced,recording_session').catch(() => ({ songs: [] })),
      api('/songs?page=1&pageSize=15&sortBy=playCount&sortOrder=desc&excludeCategories=unsurfaced,recording_session').catch(() => ({ songs: [] })),
      api('/songs?page=1&pageSize=15&hasLyrics=true&excludeCategories=unsurfaced,recording_session').catch(() => ({ songs: [] })),
      api('/songs?page=1&pageSize=15&sortBy=likeCount&sortOrder=desc&excludeCategories=unsurfaced,recording_session').catch(() => ({ songs: [] })),
      api('/admin/analytics').catch(() => null)
    ]);

    if (analytics) {
      document.getElementById('statSongs').textContent = analytics.songs?.total || '—';
      document.getElementById('statAvailable').textContent = analytics.songs?.available || '—';
      document.getElementById('statLyrics').textContent = analytics.songs?.withRawLyrics || '—';
    }

    renderSongGrid('recentSongs', recent.songs || []);
    renderCarousel('mostPlayedSongs', mostPlayed.songs || []);
    renderCarousel('mostLikedSongs', mostLiked.songs || []);
    renderCarousel('lyricsSpotlight', withLyrics.songs || []);
    loadRadioSuggestions();
    renderRecentlyPlayed();
    
    // Load friend likes for collaborative feature
    loadFriendLikes();
  } catch (err) {
    console.error('Home load error:', err);
  }
}

function renderCarousel(containerId, songs) {
  const container = document.getElementById(containerId);
  if (!container) return;
  if (!songs.length) {
    container.innerHTML = '<div class="empty-state" style="padding:20px"><p>No songs yet</p></div>';
    return;
  }
  container.innerHTML = '';
  songs.forEach((s, i) => {
    const card = document.createElement('div');
    card.className = 'song-card';
    card.style.animationDelay = `${i * 0.04}s`;
    card.style.animation = 'fadeIn 0.4s var(--ease-out) both';
    const imgHtml = artTag(s, '🎵');
    const hasFilePath = s.hasFilePath !== false;
    card.innerHTML = `
      <div class="song-card-art">
        ${imgHtml}
        ${hasFilePath ? `
        <button class="song-card-play" onclick="event.stopPropagation(); playSongById('${s.id}')">
          <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        </button>
        ` : `
        <div style="position:absolute;bottom:10px;right:10px;padding:8px 12px;background:rgba(0,0,0,0.6);border-radius:var(--radius-full);font-size:0.7rem;color:var(--text-muted);">
          🔇 Unavailable
        </div>
        `}
      </div>
      <div class="song-card-info">
        <div class="song-card-name">${esc(s.name)}</div>
        <div class="song-card-meta">${esc(s.creditedArtists || 'Juice WRLD')}</div>
      </div>
    `;
    card.addEventListener('click', () => { if (s.id) navigateToDetail(s.id); });
    container.appendChild(card);
  });
}

async function shufflePlayAll() {
  try {
    toast('Loading shuffle...', 'info');
    const data = await api('/songs?page=1&pageSize=50&excludeCategories=unsurfaced,recording_session');
    const playable = (data.songs || []).filter(s => s.hasFilePath);
    if (!playable.length) { toast('No playable songs found', 'error'); return; }
    // Shuffle
    for (let i = playable.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [playable[i], playable[j]] = [playable[j], playable[i]];
    }
    queue = playable.slice(1, 21);
    playSong(playable[0]);
    shuffleOn = true;
    document.getElementById('btnShuffle')?.classList.add('active');
    toast('Shuffle started!', 'success');
  } catch (err) {
    toast('Failed to start shuffle: ' + err.message, 'error');
  }
}

async function loadRadioSuggestions() {
  const container = document.getElementById('radioSongs');
  if (!container) return;
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const songs = [];
    const seen = new Set();
    for (let i = 0; i < 10 && songs.length < 6; i++) {
      try {
        const data = await api('/radio/random');
        // Use the local DB UUID if available, otherwise look up by external ID
        let songObj = null;
        if (data.localSong?.id) {
          if (seen.has(data.localSong.id)) continue;
          seen.add(data.localSong.id);
          try {
            songObj = await api(`/songs/${data.localSong.id}`);
          } catch {}
        } else if (data.metadata?.externalId) {
          try {
            songObj = await api(`/songs/by-external/${data.metadata.externalId}`);
          } catch {}
        }
        if (songObj && songObj.id) {
          songs.push(songObj);
        }
      } catch {}
    }
    if (songs.length) {
      renderSongGrid('radioSongs', songs);
    } else {
      container.innerHTML = '<div class="empty-state"><p>Could not load suggestions. Try refreshing.</p></div>';
    }
  } catch {
    container.innerHTML = '<div class="empty-state"><p>Could not load suggestions</p></div>';
  }
}

// ─── Categories ─────────────────────────────────────────
async function loadCategories() {
  try {
    const data = await api('/songs/categories');
    categories = data.categories || [];
    const toolbar = document.getElementById('catalogToolbar');
    const existing = toolbar.querySelectorAll('.filter-chip:not(:first-child)');
    existing.forEach(e => e.remove());
    // Pretty labels for category enum values
    const labels = { released: 'Released', unreleased: 'Unreleased', unsurfaced: 'Unsurfaced', recording_session: 'Sessions' };
    categories.forEach(cat => {
      // Skip unsurfaced/recording_session — they have dedicated pages
      if (cat === 'unsurfaced' || cat === 'recording_session') return;
      const chip = document.createElement('div');
      chip.className = 'filter-chip';
      chip.dataset.cat = cat;
      chip.textContent = labels[cat] || cat.replace(/_/g, ' ');
      if (data.counts && data.counts[cat]) {
        chip.textContent += ` (${data.counts[cat]})`;
      }
      chip.onclick = () => filterCatalog(chip, cat);
      toolbar.querySelector('.view-toggle').before(chip);
    });
  } catch (err) {
    console.warn('Failed to load categories, using fallback:', err);
    // Fallback: use lowercase enum values that Prisma actually expects
    categories = ['released', 'unreleased'];
    const toolbar = document.getElementById('catalogToolbar');
    categories.forEach(cat => {
      const chip = document.createElement('div');
      chip.className = 'filter-chip';
      chip.dataset.cat = cat;
      chip.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      chip.onclick = () => filterCatalog(chip, cat);
      toolbar.querySelector('.view-toggle').before(chip);
    });
  }
}

function filterCatalog(el, cat) {
  document.querySelectorAll('#catalogToolbar .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  catalogCategory = cat;
  catalogPage = 1;
  catalogHasMore = true;
  catalogAllSongs = [];
  document.getElementById('catalogContent').innerHTML = '';
  loadCatalogPage(false).then(() => setupInfiniteScroll());
  updateActiveFilterChips();
}

// ─── Catalog ────────────────────────────────────────────
async function loadCatalog() {
  catalogPage = 1;
  catalogHasMore = true;
  catalogAllSongs = [];
  document.getElementById('catalogContent').innerHTML = '';
  await loadCatalogPage(false);
  setupInfiniteScroll();
}

function setCatalogView(view, btn) {
  catalogView = view;
  document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadCatalog();
}

// ─── Search ─────────────────────────────────────────────
let searchTimer;
document.getElementById('searchInput').addEventListener('input', e => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    searchQuery = e.target.value.trim();
    if (searchQuery.length >= 2) {
      searchPage = 1;
      navigateTo('search');
      doSearch();
    }
  }, 350);
});

document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    searchQuery = e.target.value.trim();
    if (searchQuery) {
      searchPage = 1;
      navigateTo('search');
      doSearch();
    }
  }
});

async function doSearch() {
  const container = document.getElementById('searchResults');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await api(`/search?q=${encodeURIComponent(searchQuery)}&mode=local&page=${searchPage}&pageSize=30${searchByLyrics ? '&searchLyrics=true' : ''}`);
    document.getElementById('searchCount').textContent = `${data.pagination?.total || data.results?.length || 0} results for "${searchQuery}"`;
    renderSongGrid('searchResults', data.results || []);
    if (data.pagination) renderPagination('searchPagination', data.pagination, p => { searchPage = p; doSearch(); });
  } catch {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">🔍</div><h3>No Results</h3><p>Try different keywords</p></div>';
  }
}

// ─── Song Detail ────────────────────────────────────────
async function loadSongDetail(songId) {
  const container = document.getElementById('detailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const song = await api(`/songs/${songId}`);
    const imgHtml = artTag(song, '🎵');

    const rawLyrics = song.rawLyrics || '';
    const lyricsHtml = rawLyrics
      ? rawLyrics.split('\n').map((line, i) =>
        `<div class="lyric-line" data-idx="${i}" onclick="seekToLyricLine(${i})">${esc(line) || '&nbsp;'}</div>`
      ).join('')
      : '';

    container.innerHTML = `
      <button style="background:none;border:none;color:var(--text-secondary);cursor:pointer;margin-bottom:20px;font-size:0.88rem;display:flex;align-items:center;gap:6px" onclick="navigateTo('${currentPage === 'detail' ? 'home' : currentPage}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> Back
      </button>
      <div class="detail-header">
        <div class="detail-art">${imgHtml}</div>
        <div class="detail-info">
          <div class="detail-type">${esc(song.category || 'Song')}</div>
          <h1 class="detail-name">${esc(song.name)}</h1>
          <div class="detail-artist">${esc(song.creditedArtists || 'Juice WRLD')}</div>
          <div class="detail-meta">
            ${song.era ? `<span>🕐 ${esc(song.era.name)}</span>` : ''}
            ${song.length ? `<span>⏱ ${esc(song.length)}</span>` : ''}
            ${song.producers ? `<span>🎛 ${esc(song.producers)}</span>` : ''}
            <span>▶ ${song.playCount || 0} plays</span>
          </div>
          <div class="detail-actions">
            ${song.hasFilePath !== false ? `
            <button class="detail-btn detail-btn-play" onclick="playSongById('${song.id}')">
              <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg> Play
            </button>
            ` : `
            <button class="detail-btn" disabled style="opacity:0.5;cursor:not-allowed;background:var(--bg-surface);color:var(--text-muted);">
              🔇 Not Available
            </button>
            `}
            <button class="detail-btn detail-btn-queue" onclick="addToQueueById('${song.id}')">+ Queue</button>
            <button class="detail-like-btn ${userLikes[song.id] ? 'liked' : ''}" onclick="toggleLike('${song.id}', this);updateAllLikeButtons('${song.id}')" title="Like">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="${userLikes[song.id] ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </button>
            ${user?.role === 'admin' && song.hasFilePath && song.rawLyrics ? `
              <button class="detail-btn" id="syncLyricsBtn" onclick="syncSingleLyrics('${song.id}')" style="background:rgba(155,93,229,0.15);color:var(--purple-300);border:1px solid rgba(155,93,229,0.2);">
                ${song.canonicalLyrics ? '🔄 Re-sync' : '⚡ Sync'} Lyrics
              </button>
            ` : ''}
            <button class="detail-btn" onclick="flagSongAsBroken('${song.id}','${esc(song.name).replace(/'/g,"\\'")}','Manual flag from detail page')" style="background:rgba(255,71,87,0.1);color:var(--red);border:1px solid rgba(255,71,87,0.2);font-size:0.78rem;">
              Flag Broken
            </button>
          </div>
        </div>
      </div>
      ${rawLyrics ? `
        <div class="detail-lyrics">
          <h3>Lyrics ${song.canonicalLyrics ? '<span style="font-size:0.7rem;padding:3px 8px;background:rgba(155,93,229,0.15);color:var(--purple-300);border-radius:var(--radius-full);margin-left:8px;font-weight:500;">⚡ Timed</span>' : '<span style="font-size:0.7rem;padding:3px 8px;background:rgba(255,255,255,0.06);color:var(--text-muted);border-radius:var(--radius-full);margin-left:8px;font-weight:500;">Static</span>'}</h3>
          <div class="lyrics-body" id="detailLyricsBody">${lyricsHtml}</div>
        </div>
      ` : '<div class="no-lyrics">No lyrics available for this track</div>'}
      <div class="detail-extra">
        ${song.recordingLocation ? `<div class="detail-extra-card"><div class="dec-label">Recorded</div><div class="dec-val">${esc(song.recordingLocation)}</div></div>` : ''}
        ${song.engineers ? `<div class="detail-extra-card"><div class="dec-label">Engineers</div><div class="dec-val">${esc(song.engineers)}</div></div>` : ''}
        ${song.leakType ? `<div class="detail-extra-card"><div class="dec-label">Leak Type</div><div class="dec-val">${esc(song.leakType)}</div></div>` : ''}
        ${song.additionalInfo ? `<div class="detail-extra-card"><div class="dec-label">Notes</div><div class="dec-val">${esc(song.additionalInfo)}</div></div>` : ''}
        ${song.aliases?.length ? `<div class="detail-extra-card"><div class="dec-label">Also Known As</div><div class="dec-val">${song.aliases.map(a => esc(a.alias)).join(', ')}</div></div>` : ''}
      </div>
    `;
  } catch (err) {
    container.innerHTML = `<div class="empty-state"><div class="es-icon">😕</div><h3>Song Not Found</h3><p>${esc(err.message)}</p></div>`;
  }
}

// ─── Render Helpers ─────────────────────────────────────
function renderSongGrid(containerId, songs, isRadio = false) {
  const container = document.getElementById(containerId);
  if (!songs.length) {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">🎵</div><h3>No Songs Yet</h3><p>Run SYNC_SONGS.bat to populate the catalog</p></div>';
    return;
  }
  container.innerHTML = '';
  container.className = 'song-grid';
  songs.forEach((s, i) => {
    const card = createSongCard(s, i);
    container.appendChild(card);
  });
}

function renderSongList(containerId, songs) {
  const container = document.getElementById(containerId);
  if (!songs.length) {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">🎵</div><h3>No Songs</h3></div>';
    return;
  }
  container.innerHTML = '';
  container.className = 'song-list';
  songs.forEach((s, i) => {
    const row = document.createElement('div');
    row.className = 'song-row' + (currentSong?.id === s.id ? ' active' : '');
    const imgHtml = artTag(s, '🎵');
    row.innerHTML = `
      <div class="song-row-num">${currentSong?.id === s.id ? '<div class="playing-bars"><span></span><span></span><span></span><span></span></div>' : (i + 1)}</div>
      <div class="song-row-art">${imgHtml}</div>
      <div><div class="song-row-title">${esc(s.name)}</div></div>
      <div class="song-row-artist">${esc(s.creditedArtists || 'Juice WRLD')}</div>
      <div class="song-row-duration">${s.length || '—'}</div>
      <div class="song-row-actions">
        <button class="song-row-btn" onclick="event.stopPropagation(); addToQueueById('${s.id}')" title="Add to queue">+</button>
      </div>
    `;
    row.addEventListener('click', () => playSongById(s.id));
    container.appendChild(row);
  });
}

function renderPagination(containerId, pag, cb) {
  const container = document.getElementById(containerId);
  if (!pag || pag.totalPages <= 1) { container.innerHTML = ''; return; }
  let html = `<button class="page-btn" ${pag.page <= 1 ? 'disabled' : ''} onclick="return false">← Prev</button>`;
  const start = Math.max(1, pag.page - 2);
  const end = Math.min(pag.totalPages, pag.page + 2);
  for (let i = start; i <= end; i++) {
    html += `<button class="page-btn ${i === pag.page ? 'active' : ''}">${i}</button>`;
  }
  html += `<span class="page-info">${pag.page} / ${pag.totalPages}</span>`;
  html += `<button class="page-btn" ${pag.page >= pag.totalPages ? 'disabled' : ''}>Next →</button>`;
  container.innerHTML = html;
  container.querySelectorAll('.page-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const txt = btn.textContent.trim();
      if (txt === '← Prev' && pag.page > 1) cb(pag.page - 1);
      else if (txt === 'Next →' && pag.page < pag.totalPages) cb(pag.page + 1);
      else if (!isNaN(parseInt(txt))) cb(parseInt(txt));
    });
  });
}

// ─── Playback ───────────────────────────────────────────

// Optional: Pre-flight stream check (disabled by default for speed)
// Set window.PREFLIGHT_CHECK = true to enable
async function testStreamAvailability(songId) {
  try {
    const result = await api(`/songs/${songId}/test-stream`);
    return { available: true, ...result };
  } catch (err) {
    return { available: false, error: err.message };
  }
}

async function playSongById(id) {
  if (!id) return;
  try {
    const song = await api(`/songs/${id}`);
    
    // If pre-flight check is enabled, verify stream is available first
    if (window.PREFLIGHT_CHECK && song.hasFilePath !== false) {
      const check = await testStreamAvailability(id);
      if (!check.available) {
        toast(`"${song.name}" is temporarily unavailable`, 'error');
        // Flag the song as potentially broken
        flagSongAsBroken(id, song.name, 'Pre-flight check failed: ' + check.error);
        return;
      }
    }
    
    playSong(song);
  } catch (err) {
    toast('Cannot play: ' + err.message, 'error');
  }
}

async function playSong(song) {
  if (!song || !song.id) {
    toast('Invalid song data', 'error');
    return;
  }

  // Check if song has a playable file path
  if (song.hasFilePath === false) {
    toast(`"${song.name}" is not available for streaming`, 'error');
    // Try to find alternative or suggest radio
    setTimeout(() => {
      toast('Try Radio mode for available tracks', 'info');
    }, 1500);
    return;
  }

  if (currentSong) {
    history_stack.push(currentSong);
    if (history_stack.length > 50) history_stack = history_stack.slice(-30);
  }
  currentSong = song;

  // Clear any previous error handlers
  audio.onerror = null;

  // Set up error handling before setting src
  let retryCount = 0;
  const maxRetries = 2;
  
  const handleAudioError = async (e) => {
    const error = audio.error;
    let errorMsg = 'Playback failed';
    
    if (error) {
      switch (error.code) {
        case MediaError.MEDIA_ERR_NETWORK:
          errorMsg = 'Network error - check connection';
          break;
        case MediaError.MEDIA_ERR_DECODE:
          errorMsg = 'Audio format not supported';
          break;
        case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
          errorMsg = 'Audio source not available';
          break;
        default:
          errorMsg = 'Playback failed - source unavailable';
      }
    }
    
    console.error(`Audio error for "${song.name}":`, error);
    
    // Retry logic for network errors
    if (retryCount < maxRetries && error?.code !== MediaError.MEDIA_ERR_DECODE) {
      retryCount++;
      toast(`Retrying... (${retryCount}/${maxRetries})`, 'info');
      
      // Wait a moment and retry
      setTimeout(() => {
        audio.load();
        audio.play().catch(() => {});
      }, 1000 * retryCount);
      return;
    }
    
    toast(`${errorMsg}: "${song.name}"`, 'error');
    isPlaying = false;
    updatePlayButton();
    
    // Auto-flag the broken song (but don't flag songs that already have no file path)
    if (song.id && song.hasFilePath !== false) {
      flagSongAsBroken(song.id, song.name, 'Auto-detected: ' + (errorMsg || 'playback failed'));
    }
    
    // Auto-skip to next song after a short delay
    if (queue.length > 0) {
      setTimeout(() => {
        toast('Skipping to next track...', 'info');
        playNext();
      }, 2000);
    }
  };
  
  audio.onerror = handleAudioError;

  // Set the audio source
  audio.src = `/api/songs/${song.id}/stream`;
  
  try {
    await audio.play();
    isPlaying = true;
    updatePlayButton();
  } catch (err) {
    console.error('Playback error:', err);
    toast('Playback failed — track may be unavailable', 'error');
    
    // Auto-flag the broken song
    if (song.id && song.hasFilePath !== false) {
      flagSongAsBroken(song.id, song.name, 'Auto-detected: ' + (err.message || 'playback failed'));
    }
  }

  // Update player UI
  const imgHtml = artTag(song, '🎵');
  document.querySelector('.player-art').innerHTML = imgHtml;
  document.getElementById('playerName').textContent = song.name;
  document.getElementById('playerArtist').textContent = song.creditedArtists || 'Juice WRLD';
  document.title = `▶ ${song.name} — JuiceVault`;

  // Update player bar like button
  updateAllLikeButtons(song.id);

  // Update fullscreen lyrics
  loadFsLyrics(song);

  // Media Session
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: song.name,
      artist: song.creditedArtists || 'Juice WRLD',
      album: 'JuiceVault',
      artwork: [{ src: artSrc(song) || '/favicon.ico', sizes: '512x512' }]
    });
  }

  // Prefetch radio if enabled
  if (radioMode) prefetchRadio();
  
  // Track in recently played
  addToRecentlyPlayed(song);

  // Remove from queue if it was next
  if (queue.length && queue[0].id === song.id) queue.shift();
  renderQueue();
  
  // Update like buttons for current song
  updateAllLikeButtons(song.id);
}

async function addToQueueById(id) {
  try {
    const song = await api(`/songs/${id}`);
    queue.push(song);
    renderQueue();
    toast(`Added "${song.name}" to queue`, 'success');
  } catch (err) {
    toast('Failed to add to queue', 'error');
  }
}

function playNext() {
  if (repeatMode === 2 && currentSong) { audio.currentTime = 0; audio.play(); return; }
  if (queue.length) {
    const next = shuffleOn ? queue.splice(Math.floor(Math.random() * queue.length), 1)[0] : queue.shift();
    playSong(next);
  } else if (repeatMode === 1 && history_stack.length) {
    queue = [...history_stack].reverse();
    history_stack = [];
    playNext();
  } else if (radioMode) {
    playRadioSong();
  }
}

function playPrev() {
  if (audio.currentTime > 3) { audio.currentTime = 0; return; }
  if (history_stack.length) {
    if (currentSong) queue.unshift(currentSong);
    const prev = history_stack.pop();
    currentSong = null;
    playSong(prev);
  }
}

async function playRadioSong() {
  try {
    const data = await api('/radio/random');
    let song = null;
    if (data.localSong?.id) {
      try { song = await api(`/songs/${data.localSong.id}`); } catch {}
    }
    if (!song && data.metadata?.externalId) {
      try { song = await api(`/songs/by-external/${data.metadata.externalId}`); } catch {}
    }
    if (song && song.id && song.hasFilePath !== false) {
      playSong(song);
    } else {
      toast('Radio: No playable song found, trying again...', 'info');
      // Retry once
      try {
        const d2 = await api('/radio/random');
        if (d2.localSong?.id) { song = await api(`/songs/${d2.localSong.id}`); }
        else if (d2.metadata?.externalId) { song = await api(`/songs/by-external/${d2.metadata.externalId}`); }
        if (song?.id) playSong(song);
      } catch {}
    }
  } catch {
    toast('Radio unavailable', 'error');
  }
}

async function prefetchRadio() {
  if (!radioMode || queue.length >= 3) return;
  for (let i = queue.length; i < 3; i++) {
    try {
      const data = await api('/radio/random');
      let song = null;
      if (data.localSong?.id) {
        try { song = await api(`/songs/${data.localSong.id}`); } catch {}
      } else if (data.metadata?.externalId) {
        try { song = await api(`/songs/by-external/${data.metadata.externalId}`); } catch {}
      }
      if (song?.id && song.hasFilePath !== false) queue.push(song);
    } catch {}
  }
  renderQueue();
}

function togglePlay() {
  if (!audio.src) return;
  if (audio.paused) { audio.play(); isPlaying = true; }
  else { audio.pause(); isPlaying = false; }
  updatePlayButton();
}

function updatePlayButton() {
  const icon = document.getElementById('playIcon');
  const fsIcon = document.getElementById('fsPlayIcon');
  const playSvg = '<polygon points="5 3 19 12 5 21 5 3"/>';
  const pauseSvg = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
  icon.innerHTML = isPlaying ? pauseSvg : playSvg;
  if (fsIcon) fsIcon.innerHTML = isPlaying ? pauseSvg : playSvg;
  updateFsUpNext();
}

function updateFsUpNext() {
  const el = document.getElementById('fsUpNext');
  if (!el) return;
  if (queue.length > 0) {
    el.textContent = 'Up Next: ' + (queue[0].name || 'Unknown');
  } else if (radioMode) {
    el.textContent = 'Radio Mode · Auto-playing next';
  } else {
    el.textContent = '';
  }
}

function toggleRadio() {
  radioMode = !radioMode;
  document.getElementById('btnRadio').classList.toggle('active', radioMode);
  toast(radioMode ? 'Radio mode on' : 'Radio mode off', 'info');
  if (radioMode) prefetchRadio();
}

function seekAudio(e) {
  if (!audio.duration) return;
  const bar = e.currentTarget;
  const rect = bar.getBoundingClientRect();
  const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  audio.currentTime = pct * audio.duration;
}

function seekToLyricLine(idx) {
  if (!audio.duration || !currentSong) return;
  const lines = (currentSong.rawLyrics || '').split('\n').filter(l => l.trim());
  if (!lines.length) return;
  const pct = idx / lines.length;
  audio.currentTime = pct * audio.duration;
}

// ─── Audio Events ───────────────────────────────────────
audio.addEventListener('timeupdate', () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  document.getElementById('progressFill').style.width = `${pct}%`;
  document.getElementById('playerCurTime').textContent = fmtTime(audio.currentTime);
  document.getElementById('playerDuration').textContent = fmtTime(audio.duration);

  if (fsLyricsOpen) {
    document.getElementById('fsProgressFill').style.width = `${pct}%`;
    document.getElementById('fsCurTime').textContent = fmtTime(audio.currentTime);
    document.getElementById('fsDuration').textContent = fmtTime(audio.duration);
    updateFsLyrics();
  }

  updateDetailLyrics();
});

audio.addEventListener('ended', () => {
  isPlaying = false;
  updatePlayButton();
  playNext();
});

audio.addEventListener('play', () => { isPlaying = true; updatePlayButton(); });
audio.addEventListener('pause', () => { isPlaying = false; updatePlayButton(); });

// Global audio error handler - catches errors not handled by playSong
audio.addEventListener('error', (e) => {
  // Only handle if playSong hasn't already handled this error
  // The playSong function sets audio.onerror, so if that's set, let it handle
  if (audio.onerror) return;
  
  const error = audio.error;
  if (!error) return;
  
  console.error('Global audio error:', error);
  
  let errorMsg = 'Audio playback error';
  switch (error.code) {
    case MediaError.MEDIA_ERR_NETWORK:
      errorMsg = 'Network error - check connection';
      break;
    case MediaError.MEDIA_ERR_DECODE:
      errorMsg = 'Audio format error';
      break;
    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
      errorMsg = 'Audio not available';
      break;
  }
  
  toast(errorMsg, 'error');
  isPlaying = false;
  updatePlayButton();
});

// Handle stalled playback - retry once
audio.addEventListener('stalled', () => {
  console.warn('Audio stalled, attempting to resume...');
  setTimeout(() => {
    if (audio.paused && audio.src && currentSong) {
      audio.play().catch(() => {});
    }
  }, 2000);
});

// ─── Fullscreen Lyrics ──────────────────────────────────
async function loadFsLyrics(song) {
  fsLines = [];
  timedLyricsData = null;
  lyricsOffset = 0;
  userScrolling = false;
  const body = document.getElementById('fsBody');
  const slider = document.getElementById('fsOffsetSlider');
  const valEl = document.getElementById('fsOffsetVal');
  if (slider) { slider.value = 0; }
  if (valEl) { valEl.textContent = '0ms'; }

  const fsCoverUrl = artSrc(song);
  if (fsCoverUrl) {
    document.getElementById('fsBgImg').style.backgroundImage = `url(${fsCoverUrl})`;
    document.getElementById('fsArt').innerHTML = `<img src="${fsCoverUrl}">`;
  } else {
    document.getElementById('fsBgImg').style.backgroundImage = '';
    document.getElementById('fsArt').innerHTML = '';
  }
  document.getElementById('fsSongName').textContent = song.name;
  document.getElementById('fsSongArtist').textContent = song.creditedArtists || 'Juice WRLD';
  document.getElementById('fsShareSong').textContent = `${song.name} — ${song.creditedArtists || 'Juice WRLD'}`;
  
  // Reset pinned lines and share selection
  pinnedLines.clear();
  selectedShareLine = null;
  selectedShareText = '';

  // Try to load timed lyrics from canonical version
  let timed = null;
  if (song.canonicalLyrics && song.canonicalLyrics.id) {
    try {
      const lv = await api(`/songs/${song.id}/lyrics/${song.canonicalLyrics.id}`);
      if (lv && lv.lyricsData && Array.isArray(lv.lyricsData) && lv.lyricsData.length > 0) {
        timed = lv.lyricsData;
      }
    } catch (err) {
      console.warn('Failed to load timed lyrics:', err);
    }
  }

  // Fallback: if song detail didn't include canonicalLyrics, fetch full song
  if (!timed && song.id && !song.canonicalLyrics) {
    try {
      const fullSong = await api(`/songs/${song.id}`);
      if (fullSong.canonicalLyrics && fullSong.canonicalLyrics.lyricsData) {
        timed = fullSong.canonicalLyrics.lyricsData;
        // Update current song reference
        song.canonicalLyrics = fullSong.canonicalLyrics;
      }
    } catch {}
  }

  body.innerHTML = '';

  if (timed && timed.length > 0) {
    // ─── TIMED LYRICS MODE ───
    timedLyricsData = timed;
    timed.forEach((line, i) => {
      const div = createLyricLine(line.text || ' ', i, true, timed);
      body.appendChild(div);
      fsLines.push(div);
    });
    console.log(`Loaded ${timed.length} timed lyric lines`);
  } else {
    // ─── RAW LYRICS FALLBACK (percentage-based) ───
    timedLyricsData = null;
    const rawLyrics = song.rawLyrics || '';
    if (!rawLyrics.trim()) {
      body.innerHTML = '<div class="fs-line active" style="opacity:0.3">No lyrics available</div>';
      return;
    }
    const lines = rawLyrics.split('\n');
    lines.forEach((line, i) => {
      const div = createLyricLine(line || ' ', i, false, lines);
      body.appendChild(div);
      fsLines.push(div);
    });
  }

  // Set up scroll tracking to prevent auto-scroll from fighting user
  body.addEventListener('wheel', onUserScroll, { passive: true });
  body.addEventListener('touchstart', onUserScroll, { passive: true });
}

// Create a lyric line with enhanced interactions
function createLyricLine(text, idx, isTimed, data) {
  const div = document.createElement('div');
  div.className = isTimed ? 'fs-line timed' : 'fs-line';
  div.textContent = text;
  div.dataset.idx = idx;
  
  // Click to jump + select for sharing
  div.addEventListener('click', (e) => {
    e.stopPropagation();
    handleLineClick(e, idx, text);
  });
  
  // Right-click to pin
  div.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    handleLinePin(idx);
  });
  
  // Long press for copy
  let pressTimer;
  div.addEventListener('mousedown', () => {
    div.classList.add('pressing');
    pressTimer = setTimeout(() => {
      handleLineLongPress(idx, text);
      div.classList.remove('pressing');
    }, 800);
  });
  div.addEventListener('mouseup', () => {
    clearTimeout(pressTimer);
    div.classList.remove('pressing');
  });
  div.addEventListener('mouseleave', () => {
    clearTimeout(pressTimer);
    div.classList.remove('pressing');
  });
  
  // Touch events for mobile long press
  div.addEventListener('touchstart', (e) => {
    div.classList.add('pressing');
    pressTimer = setTimeout(() => {
      e.preventDefault();
      handleLineLongPress(idx, text);
      div.classList.remove('pressing');
    }, 800);
  }, { passive: true });
  div.addEventListener('touchend', () => {
    clearTimeout(pressTimer);
    div.classList.remove('pressing');
  });
  
  return div;
}

function onUserScroll() {
  userScrolling = true;
  clearTimeout(userScrollTimer);
  userScrollTimer = setTimeout(() => { userScrolling = false; }, 4000);
}

function updateFsLyrics() {
  if (!fsLines.length || !audio.duration) return;
  const currentMs = audio.currentTime * 1000;

  if (timedLyricsData) {
    // ─── TIMED MODE: use start_ms / end_ms ───
    const adjusted = currentMs - lyricsOffset;
    let activeIdx = -1;
    for (let i = timedLyricsData.length - 1; i >= 0; i--) {
      if (adjusted >= timedLyricsData[i].start_ms) {
        activeIdx = i;
        break;
      }
    }

    fsLines.forEach((el, i) => {
      el.classList.remove('active', 'past', 'upcoming');
      if (i === activeIdx) el.classList.add('active');
      else if (i < activeIdx) el.classList.add('past');
      else if (i <= activeIdx + 3) el.classList.add('upcoming');
    });

    if (activeIdx >= 0 && fsLines[activeIdx] && !userScrolling) {
      fsLines[activeIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  } else {
    // ─── FALLBACK: percentage-based ───
    const pct = audio.currentTime / audio.duration;
    const activeIdx = Math.min(Math.floor(pct * fsLines.length), fsLines.length - 1);

    fsLines.forEach((el, i) => {
      el.classList.remove('active', 'past');
      if (i === activeIdx) el.classList.add('active');
      else if (i < activeIdx) el.classList.add('past');
    });

    if (fsLines[activeIdx] && !userScrolling) {
      fsLines[activeIdx].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

function updateLyricsOffset(val) {
  lyricsOffset = parseInt(val, 10) || 0;
  const label = lyricsOffset >= 0 ? `+${lyricsOffset}ms` : `${lyricsOffset}ms`;
  document.getElementById('fsOffsetVal').textContent = label;
}

async function regenLyricsTiming() {
  if (!currentSong) return;
  
  // Check permissions first
  if (user?.role !== 'admin' && user?.role !== 'trusted_contributor') {
    toast('Regenerate timing requires admin or trusted contributor permissions', 'error');
    return;
  }
  
  const btn = document.getElementById('fsRegenBtn');
  const origHTML = btn.innerHTML;
  btn.style.opacity = '0.4';
  btn.style.pointerEvents = 'none';
  btn.style.animation = 'spin 1s linear infinite';
  try {
    const result = await api(`/songs/${currentSong.id}/regen-lyrics`, { method: 'POST' });
    if (result && result.success) {
      toast('Lyrics timing regenerated! Reloading...', 'success');
      const freshSong = await api(`/songs/${currentSong.id}`);
      Object.assign(currentSong, freshSong);
      await loadFsLyrics(currentSong);
    } else {
      toast(result?.error || 'Failed to regenerate lyrics', 'error');
    }
  } catch (err) {
    toast('Regen failed: ' + (err.message || 'Unknown error'), 'error');
  } finally {
    btn.innerHTML = origHTML;
    btn.style.opacity = '';
    btn.style.pointerEvents = '';
    btn.style.animation = '';
  }
}

function updateDetailLyrics() {
  const body = document.getElementById('detailLyricsBody');
  if (!body || !audio.duration || !currentSong) return;
  const lines = body.querySelectorAll('.lyric-line');
  if (!lines.length) return;
  const currentMs = audio.currentTime * 1000;

  // Check if detail view has timed data attached
  if (body.dataset.timed === 'true' && timedLyricsData) {
    const adjusted = currentMs - lyricsOffset;
    let activeIdx = -1;
    for (let i = timedLyricsData.length - 1; i >= 0; i--) {
      if (adjusted >= timedLyricsData[i].start_ms) {
        activeIdx = i;
        break;
      }
    }
    lines.forEach((el, i) => {
      el.classList.remove('active', 'past');
      if (i === activeIdx) el.classList.add('active');
      else if (i < activeIdx) el.classList.add('past');
    });
  } else {
    const pct = audio.currentTime / audio.duration;
    const activeIdx = Math.min(Math.floor(pct * lines.length), lines.length - 1);
    lines.forEach((el, i) => {
      el.classList.remove('active', 'past');
      if (i === activeIdx) el.classList.add('active');
      else if (i < activeIdx) el.classList.add('past');
    });
  }
}

function toggleFullscreenLyrics() {
  fsLyricsOpen = !fsLyricsOpen;
  document.getElementById('fsLyrics').classList.toggle('open', fsLyricsOpen);
  if (fsLyricsOpen && currentSong) {
    loadFsLyrics(currentSong);
    // Show/hide regen button based on permissions
    const canRegen = user?.role === 'admin' || user?.role === 'trusted_contributor';
    document.getElementById('fsRegenBtn').style.display = canRegen ? 'flex' : 'none';
    // Load info panel content
    loadInfoPanelContent();
    // Apply saved settings
    applyLyricsSettings();
  }
}

// ═══════════════════════════════════════════════════════
// LYRICS V3 — ENHANCED FEATURES
// ═══════════════════════════════════════════════════════

// ─── Display Modes ──────────────────────────────────────
let lyricsMode = 'synced'; // synced, raw, karaoke, compact, art
let lyricsSettings = {
  fontSize: 2.2,
  theme: 'dark',
  align: 'center',
  spacing: 12,
  highContrast: false,
  largeText: false
};
let pinnedLines = new Set();

function setLyricsMode(mode) {
  lyricsMode = mode;
  const fsLyrics = document.getElementById('fsLyrics');
  
  // Update mode buttons
  document.querySelectorAll('.fs-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
  
  // Apply mode classes
  fsLyrics.classList.remove('raw-mode', 'compact', 'art-focus', 'karaoke-mode');

  if (mode === 'raw') {
    fsLyrics.classList.add('raw-mode');
  }
  
  // Reload lyrics with new mode
  if (currentSong) {
    loadFsLyrics(currentSong);
  }
  
  toast(`Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`, 'info');
}

// ─── Settings Panel ─────────────────────────────────────
function toggleSettingsPanel() {
  document.getElementById('fsSettingsPanel').classList.toggle('open');
}

function adjustFontSize(delta) {
  lyricsSettings.fontSize = Math.max(1, Math.min(4, lyricsSettings.fontSize + delta));
  document.documentElement.style.setProperty('--lyrics-font-size', lyricsSettings.fontSize + 'rem');
  document.getElementById('fsFontValue').textContent = Math.round((lyricsSettings.fontSize / 2.2) * 100) + '%';
  saveLyricsSettings();
}

function setLyricsTheme(theme) {
  lyricsSettings.theme = theme;
  document.querySelectorAll('.fs-theme-option').forEach(el => el.classList.remove('active'));
  document.querySelector(`.fs-theme-${theme}`)?.classList.add('active');
  
  // Apply theme
  const root = document.documentElement;
  const themes = {
    dark: { bg: '#050508', accent: '#9b5de5' },
    light: { bg: '#f5f5f7', accent: '#9b5de5' },
    purple: { bg: '#1a0a2e', accent: '#b07fff' },
    pink: { bg: '#1a0a14', accent: '#f15bb5' },
    cyan: { bg: '#0a1a1a', accent: '#00f5d4' },
    orange: { bg: '#1a120a', accent: '#ff9e2c' },
    red: { bg: '#1a0a0a', accent: '#ff4757' },
    green: { bg: '#0a1a0a', accent: '#2ed573' }
  };
  
  // Theme is applied via CSS variables
  saveLyricsSettings();
  toast(`Theme: ${theme.charAt(0).toUpperCase() + theme.slice(1)}`, 'success');
}

function setLyricsAlign(align) {
  lyricsSettings.align = align;
  document.documentElement.style.setProperty('--lyrics-align', align);
  
  document.querySelectorAll('.fs-align-btn').forEach(btn => btn.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  saveLyricsSettings();
}

function setLineSpacing(value) {
  lyricsSettings.spacing = value;
  document.documentElement.style.setProperty('--lyrics-spacing', value + 'px');
  saveLyricsSettings();
}

function toggleHighContrast() {
  lyricsSettings.highContrast = !lyricsSettings.highContrast;
  document.getElementById('fsHighContrastToggle').classList.toggle('active', lyricsSettings.highContrast);
  document.getElementById('fsLyrics').classList.toggle('high-contrast', lyricsSettings.highContrast);
  saveLyricsSettings();
}

function toggleLargeText() {
  lyricsSettings.largeText = !lyricsSettings.largeText;
  document.getElementById('fsLargeTextToggle').classList.toggle('active', lyricsSettings.largeText);
  document.getElementById('fsLyrics').classList.toggle('large-text', lyricsSettings.largeText);
  saveLyricsSettings();
}

function saveLyricsSettings() {
  localStorage.setItem('jv_lyrics_settings', JSON.stringify(lyricsSettings));
}

function applyLyricsSettings() {
  const saved = localStorage.getItem('jv_lyrics_settings');
  if (saved) {
    try {
      lyricsSettings = JSON.parse(saved);
      document.documentElement.style.setProperty('--lyrics-font-size', lyricsSettings.fontSize + 'rem');
      document.documentElement.style.setProperty('--lyrics-align', lyricsSettings.align);
      document.documentElement.style.setProperty('--lyrics-spacing', lyricsSettings.spacing + 'px');
      document.getElementById('fsLyrics').classList.toggle('high-contrast', lyricsSettings.highContrast);
      document.getElementById('fsLyrics').classList.toggle('large-text', lyricsSettings.largeText);
      
      // Update UI
      document.getElementById('fsFontValue').textContent = Math.round((lyricsSettings.fontSize / 2.2) * 100) + '%';
      document.getElementById('fsHighContrastToggle').classList.toggle('active', lyricsSettings.highContrast);
      document.getElementById('fsLargeTextToggle').classList.toggle('active', lyricsSettings.largeText);
      document.querySelector('.fs-theme-' + lyricsSettings.theme)?.classList.add('active');
    } catch {}
  }
}

// ─── Info Panel ─────────────────────────────────────────
function toggleInfoPanel() {
  document.getElementById('fsInfoPanel').classList.toggle('open');
}

function loadInfoPanelContent() {
  if (!currentSong) return;
  
  const content = document.getElementById('fsInfoContent');
  content.innerHTML = `
    <div class="fs-info-section">
      <h4>🎵 Credits</h4>
      <div class="fs-info-item">
        <span class="fs-info-label">Artist</span>
        <span class="fs-info-value">${esc(currentSong.creditedArtists || 'Juice WRLD')}</span>
      </div>
      ${currentSong.producers ? `
      <div class="fs-info-item">
        <span class="fs-info-label">Producers</span>
        <span class="fs-info-value">${esc(currentSong.producers)}</span>
      </div>` : ''}
      ${currentSong.writers ? `
      <div class="fs-info-item">
        <span class="fs-info-label">Writers</span>
        <span class="fs-info-value">${esc(currentSong.writers)}</span>
      </div>` : ''}
      ${currentSong.engineers ? `
      <div class="fs-info-item">
        <span class="fs-info-label">Engineers</span>
        <span class="fs-info-value">${esc(currentSong.engineers)}</span>
      </div>` : ''}
    </div>
    
    <div class="fs-info-section">
      <h4>📋 Metadata</h4>
      <div class="fs-info-item">
        <span class="fs-info-label">Album</span>
        <span class="fs-info-value">${esc(currentSong.album || 'Single')}</span>
      </div>
      ${currentSong.era ? `
      <div class="fs-info-item">
        <span class="fs-info-label">Era</span>
        <span class="fs-info-value">${esc(currentSong.era.name)}</span>
      </div>` : ''}
      ${currentSong.length ? `
      <div class="fs-info-item">
        <span class="fs-info-label">Length</span>
        <span class="fs-info-value">${esc(currentSong.length)}</span>
      </div>` : ''}
      <div class="fs-info-item">
        <span class="fs-info-label">Category</span>
        <span class="fs-info-value">${esc((currentSong.category || 'Unknown').replace(/_/g, ' '))}</span>
      </div>
      <div class="fs-info-item">
        <span class="fs-info-label">Plays</span>
        <span class="fs-info-value">${currentSong.playCount || 0}</span>
      </div>
    </div>
    
    ${currentSong.additionalInfo ? `
    <div class="fs-info-section">
      <h4>📝 Song Story</h4>
      <p style="font-size:0.85rem;line-height:1.6;color:var(--text-secondary);">${esc(currentSong.additionalInfo)}</p>
    </div>` : ''}
  `;
}

// ─── Share Panel ────────────────────────────────────────
let selectedShareLine = null;
let selectedShareText = '';

function toggleSharePanel() {
  document.getElementById('fsSharePanel').classList.toggle('open');
  if (currentSong) {
    document.getElementById('fsShareSong').textContent = `${esc(currentSong.name)} — ${esc(currentSong.creditedArtists || 'Juice WRLD')}`;
  }
}

function shareToTwitter() {
  if (!selectedShareText) {
    toast('Click a lyric line first to share it', 'error');
    return;
  }
  const text = encodeURIComponent(`"${selectedShareText}" — ${currentSong?.name || ''} #JuiceVault`);
  window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
  toggleSharePanel();
}

function copyLyrics() {
  if (!selectedShareText) {
    toast('Click a lyric line first to copy', 'error');
    return;
  }
  const fullText = `"${selectedShareText}"\n— ${currentSong?.name || ''}\n${currentSong?.creditedArtists || 'Juice WRLD'}`;
  navigator.clipboard.writeText(fullText).then(() => {
    showCopyFeedback();
    toggleSharePanel();
  });
}

function showCopyFeedback() {
  const feedback = document.getElementById('fsCopyFeedback');
  feedback.classList.add('show');
  setTimeout(() => feedback.classList.remove('show'), 1500);
}

function showQRCode() {
  toggleSharePanel();
  const modal = document.getElementById('fsQRModal');
  const placeholder = document.getElementById('fsQRPlaceholder');
  
  // Generate simple visual representation of QR code
  let qrHtml = '';
  for (let i = 0; i < 25; i++) {
    qrHtml += `<div class="fs-qr-dot ${Math.random() > 0.5 ? '' : 'empty'}"></div>`;
  }
  placeholder.innerHTML = qrHtml;
  
  modal.classList.add('open');
}

function hideQRCode() {
  document.getElementById('fsQRModal').classList.remove('open');
}

// ─── Offset Controls ────────────────────────────────────
function adjustOffset(delta) {
  const slider = document.getElementById('fsOffsetSlider');
  let newVal = parseInt(slider.value) + delta;
  newVal = Math.max(-5000, Math.min(5000, newVal));
  slider.value = newVal;
  updateLyricsOffset(newVal);
}

function nudgeOffset(delta) {
  adjustOffset(delta);
}

// ─── Playback Speed ─────────────────────────────────────
let currentPlaybackSpeed = 1;

function setPlaybackSpeed(speed) {
  currentPlaybackSpeed = speed;
  audio.playbackRate = speed;
  
  document.querySelectorAll('.fs-speed-btn').forEach(btn => {
    btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
  });
}

// ─── A-B Repeat ─────────────────────────────────────────
let abLoop = { A: null, B: null, active: false };

function setABPoint(point) {
  if (!audio.currentTime) return;
  
  abLoop[point] = audio.currentTime;
  document.getElementById(`fs${point}Btn`).classList.add('set');
  
  if (abLoop.A !== null && abLoop.B !== null) {
    abLoop.active = true;
    document.getElementById('fsABtn').classList.add('active');
    document.getElementById('fsBBtn').classList.add('active');
    toast(`A-B Loop: ${fmtTime(abLoop.A)} - ${fmtTime(abLoop.B)}`, 'success');
  }
}

function clearABLoop() {
  abLoop = { A: null, B: null, active: false };
  document.getElementById('fsABtn').classList.remove('set', 'active');
  document.getElementById('fsBBtn').classList.remove('set', 'active');
}

// Check A-B loop during playback
setInterval(() => {
  if (abLoop.active && abLoop.B && audio.currentTime >= abLoop.B) {
    audio.currentTime = abLoop.A || 0;
  }
}, 100);

// ─── Sleep Timer ────────────────────────────────────────
let sleepTimerId = null;

function setSleepTimer(minutes) {
  if (sleepTimerId) {
    clearTimeout(sleepTimerId);
    sleepTimerId = null;
  }
  
  if (!minutes) {
    toast('Sleep timer off', 'info');
    return;
  }
  
  if (minutes === 'end') {
    audio.addEventListener('ended', pauseAfterSong, { once: true });
    toast('Will pause after this song', 'success');
  } else {
    const ms = parseInt(minutes) * 60 * 1000;
    sleepTimerId = setTimeout(() => {
      audio.pause();
      isPlaying = false;
      updatePlayButton();
      toast('Sleep timer ended', 'info');
    }, ms);
    toast(`Sleep timer set: ${minutes} minutes`, 'success');
  }
}

function pauseAfterSong() {
  audio.pause();
  isPlaying = false;
  updatePlayButton();
  toast('Paused after song (sleep timer)', 'info');
}

// ─── Volume Control ─────────────────────────────────────
function setLyricsVolume(e) {
  const slider = document.getElementById('fsVolumeSlider');
  const rect = slider.getBoundingClientRect();
  const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  audio.volume = pct;
  volume = pct;
  updateLyricsVolumeUI();
  localStorage.setItem('jv_volume', pct);
}

function updateLyricsVolumeUI() {
  const fill = document.getElementById('fsVolumeFill');
  if (fill) fill.style.width = (audio.volume * 100) + '%';
}

function toggleMute() {
  if (audio.volume > 0) {
    previousVolume = audio.volume;
    audio.volume = 0;
  } else {
    audio.volume = previousVolume;
  }
  volume = audio.volume;
  updateVolumeUI();
  updateLyricsVolumeUI();
}

// ─── Enhanced Lyric Line Interactions ───────────────────
let longPressTimer = null;

function handleLineClick(e, idx, lineText) {
  if (!audio.duration) return;
  
  // Handle pinned lines
  const line = fsLines[idx];
  if (pinnedLines.has(idx)) {
    pinnedLines.delete(idx);
    line.classList.remove('pinned');
    return;
  }
  
  // Jump to timestamp
  if (timedLyricsData && timedLyricsData[idx]) {
    audio.currentTime = (timedLyricsData[idx].start_ms + lyricsOffset) / 1000;
  } else {
    const pct = idx / fsLines.length;
    audio.currentTime = pct * audio.duration;
  }
  userScrolling = false;
  
  // Set for sharing
  selectedShareText = lineText;
  selectedShareLine = idx;
  document.getElementById('fsShareLine').textContent = `"${lineText}"`;
}

function handleLineLongPress(idx, lineText) {
  // Copy line text
  navigator.clipboard.writeText(lineText).then(() => {
    showCopyFeedback();
  });
}

function handleLinePin(idx) {
  if (pinnedLines.has(idx)) {
    pinnedLines.delete(idx);
    fsLines[idx].classList.remove('pinned');
  } else {
    pinnedLines.add(idx);
    fsLines[idx].classList.add('pinned');
    showPinToast();
  }
}

function showPinToast() {
  const toast = document.getElementById('fsPinToast');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ─── Queue ──────────────────────────────────────────────
function renderQueue() {
  const body = document.getElementById('queueBody');
  let html = '';

  if (currentSong) {
    html += `<div class="queue-section-title">Now Playing</div>`;
    html += renderQueueItem(currentSong, -1, true);
  }

  if (queue.length) {
    html += `<div class="queue-section-title">Up Next · ${queue.length} song${queue.length > 1 ? 's' : ''}</div>`;
    queue.forEach((s, i) => { html += renderQueueItem(s, i, false); });
  } else if (!currentSong) {
    html = '<div class="queue-empty">Queue is empty. Play a song or enable radio mode.</div>';
  }

  body.innerHTML = html;
  updateQueueBadge();
}

function renderQueueItem(s, idx, isNowPlaying) {
  const img = artTag(s, '🎵');
  const isLiked = userLikes[s.id] === true;
  return `
    <div class="queue-item ${isNowPlaying ? 'now-playing' : ''}">
      <div class="qi-art">${img}</div>
      <div class="qi-info">
        <div class="qi-name">${esc(s.name)}</div>
        <div class="qi-artist">${esc(s.creditedArtists || 'Juice WRLD')}</div>
      </div>
      <button class="qi-like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${s.id}', this);this.classList.toggle('liked')" title="${isLiked ? 'Unlike' : 'Like'}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </button>
      ${!isNowPlaying ? `<button class="qi-remove" onclick="removeFromQueue(${idx})">✕</button>` : ''}
    </div>`;
}

function removeFromQueue(idx) {
  queue.splice(idx, 1);
  renderQueue();
}

function toggleQueue() {
  document.getElementById('queuePanel').classList.toggle('open');
  renderQueue();
}

// ─── Vault (Unsurfaced) ─────────────────────────────────
let vaultPage = 1;
let vaultSearchQuery = '';

async function loadVault() {
  const container = document.getElementById('vaultContent');
  const countEl = document.getElementById('vaultCount');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    let url = `/songs?page=${vaultPage}&pageSize=30&category=unsurfaced`;
    if (vaultSearchQuery) url += `&search=${encodeURIComponent(vaultSearchQuery)}`;
    const data = await api(url);
    countEl.textContent = `${data.pagination.total} unsurfaced songs`;
    document.getElementById('vaultBadge').textContent = data.pagination.total || '';
    container.innerHTML = '';
    if (!data.songs.length) {
      container.innerHTML = '<div class="empty-state"><div class="es-icon">🔒</div><h3>No Unsurfaced Songs Found</h3><p>Try a different search or check back later.</p></div>';
      return;
    }
    data.songs.forEach(s => {
      const card = document.createElement('div');
      card.className = 'vault-card';
      card.innerHTML = `
        <span class="vc-lock">🔒</span>
        <div class="vc-name">${esc(s.name)}</div>
        <div class="vc-meta">${esc(s.creditedArtists || 'Juice WRLD')}${s.length ? ' · ' + esc(s.length) : ''}</div>
        ${s.era ? `<span class="vc-era">${esc(s.era.name)}</span>` : ''}
      `;
      container.appendChild(card);
    });
    renderPagination('vaultPagination', data.pagination, p => { vaultPage = p; loadVault(); });
  } catch (err) {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">😕</div><h3>Failed to Load</h3><p>' + esc(err.message) + '</p></div>';
  }
}

function searchVault(query) {
  vaultSearchQuery = query;
  vaultPage = 1;
  clearTimeout(window._vaultSearchTimer);
  window._vaultSearchTimer = setTimeout(() => loadVault(), 300);
}

// ─── Sessions (Recording Sessions) ──────────────────────
let sessionsPage = 1;

async function loadSessions() {
  const container = document.getElementById('sessionsContent');
  const countEl = document.getElementById('sessionsCount');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const data = await api(`/songs?page=${sessionsPage}&pageSize=30&category=recording_session`);
    countEl.textContent = `${data.pagination.total} recording sessions`;
    document.getElementById('sessionsBadge').textContent = data.pagination.total || '';
    container.innerHTML = '';
    if (!data.songs.length) {
      container.innerHTML = '<div class="empty-state"><div class="es-icon">🎙️</div><h3>No Recording Sessions Found</h3></div>';
      return;
    }
    data.songs.forEach(s => {
      const card = document.createElement('div');
      card.className = 'sessions-card';
      const hasAudio = s.hasFilePath;
      card.innerHTML = `
        <div class="sc-name">${esc(s.name)}</div>
        <div class="sc-meta">${esc(s.creditedArtists || 'Juice WRLD')}${s.length ? ' · ' + esc(s.length) : ''}</div>
        ${hasAudio ? '<span class="sc-play">▶ Play Session</span>' : '<span class="sc-play" style="opacity:0.4">No Audio</span>'}
      `;
      if (hasAudio) {
        card.addEventListener('click', () => playSongById(s.id));
      }
      container.appendChild(card);
    });
    renderPagination('sessionsPagination', data.pagination, p => { sessionsPage = p; loadSessions(); });
  } catch (err) {
    container.innerHTML = '<div class="empty-state"><div class="es-icon">😕</div><h3>Failed to Load</h3><p>' + esc(err.message) + '</p></div>';
  }
}

// ─── Admin ──────────────────────────────────────────────
async function loadAdmin() {
  if (user?.role !== 'admin') return;
  try {
    const analytics = await api('/admin/analytics');
    const s = analytics.songs || {};
    const u = analytics.users || {};
    const l = analytics.lyrics || {};

    document.getElementById('adminStats').innerHTML = `
      <div class="stat-card purple"><div class="stat-label">Total Songs</div><div class="stat-value">${s.total || 0}</div><div class="stat-sub">${s.available || 0} streamable</div></div>
      <div class="stat-card pink"><div class="stat-label">Users</div><div class="stat-value">${u.total || 0}</div></div>
      <div class="stat-card cyan"><div class="stat-label">Total Plays</div><div class="stat-value">${analytics.playback?.totalPlays || 0}</div></div>
      <div class="stat-card orange"><div class="stat-label">Lyrics</div><div class="stat-value">${s.withRawLyrics || 0}</div><div class="stat-sub">${s.withTimedLyrics || 0} timed</div></div>
      <div class="stat-card green"><div class="stat-label">Pending Reviews</div><div class="stat-value">${l.pendingReviews || 0}</div></div>
    `;

    // Load users and invites
    const [users, invites] = await Promise.all([
      api('/admin/users?pageSize=20'),
      api('/admin/invites')
    ]);

    let sectionsHtml = `
      <div class="admin-section">
        <h3>👥 Users</h3>
        <table class="admin-table">
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Rep</th><th>Actions</th></tr></thead>
          <tbody>
            ${(users.users || []).map(u => `
              <tr>
                <td>${esc(u.displayName)}</td>
                <td style="color:var(--text-muted)">${esc(u.email)}</td>
                <td><span class="song-badge badge-category">${u.role}</span></td>
                <td>${u.reputationScore}</td>
                <td class="admin-actions">
                  <button class="admin-btn" onclick="setUserRole('${u.id}','${u.role === 'admin' ? 'user' : 'admin'}')">
                    ${u.role === 'admin' ? 'Remove Admin' : 'Make Admin'}
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>

      <div class="admin-section">
        <h3>🎫 Invite Codes</h3>
        <div class="invite-gen">
          <input type="number" id="inviteCount" value="1" min="1" max="20" placeholder="Count">
          <button class="admin-btn" onclick="generateInvites()">Generate Invites</button>
        </div>
        <table class="admin-table">
          <thead><tr><th>Code</th><th>Status</th><th>Used By</th><th>Expires</th></tr></thead>
          <tbody>
            ${(invites.invites || []).map(inv => `
              <tr>
                <td class="invite-code">${inv.code}</td>
                <td>${inv.isUsed ? '<span style="color:var(--text-muted)">Used</span>' : inv.isExpired ? '<span style="color:var(--red)">Expired</span>' : '<span style="color:var(--green)">Available</span>'}</td>
                <td>${inv.usedBy ? esc(inv.usedBy.name) : '—'}</td>
                <td style="color:var(--text-muted)">${new Date(inv.expiresAt).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;

    // Top played
    if (analytics.playback?.topPlayed?.length) {
      sectionsHtml += `
        <div class="admin-section">
          <h3>🏆 Top Played</h3>
          <table class="admin-table">
            <thead><tr><th>#</th><th>Song</th><th>Plays</th></tr></thead>
            <tbody>
              ${analytics.playback.topPlayed.slice(0, 10).map((s, i) => `
                <tr><td>${i + 1}</td><td>${esc(s.name)}</td><td>${s.playCount}</td></tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Lyrics Sync Section - MODERN UI
    try {
      const syncStatus = await api('/admin/lyrics/sync-status');
      const autoStatus = await api('/admin/lyrics/auto-sync/status').catch(() => ({ running: false, progress: { percent: 0 } }));
      const pct = syncStatus.withRawLyrics > 0
        ? Math.round((syncStatus.withTimedLyrics / syncStatus.withRawLyrics) * 100)
        : 0;

      sectionsHtml += `
        <div class="admin-section" style="background:linear-gradient(135deg,var(--bg-card) 0%,var(--bg-raised) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
            <div style="width:48px;height:48px;border-radius:var(--radius-md);background:linear-gradient(135deg,var(--purple-600),var(--pink));display:flex;align-items:center;justify-content:center;font-size:24px;">🎤</div>
            <div>
              <h3 style="margin:0;font-size:1.2rem;font-weight:700;">Lyrics Sync Center</h3>
              <p style="margin:4px 0 0;font-size:0.8rem;color:var(--text-muted);">Auto-fetch from Genius + AssemblyAI timing</p>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;">
              <span style="padding:6px 12px;border-radius:var(--radius-full);font-size:0.75rem;font-weight:600;background:${syncStatus.hasGeniusKey ? 'rgba(46,213,115,0.15)' : 'rgba(255,71,87,0.15)'};color:${syncStatus.hasGeniusKey ? 'var(--green)' : 'var(--red)'};border:1px solid ${syncStatus.hasGeniusKey ? 'rgba(46,213,115,0.3)' : 'rgba(255,71,87,0.3)'}">
                ${syncStatus.hasGeniusKey ? '● Genius Ready' : '○ Genius Offline'}
              </span>
              <span style="padding:6px 12px;border-radius:var(--radius-full);font-size:0.75rem;font-weight:600;background:${syncStatus.hasAssemblyAiKey ? 'rgba(46,213,115,0.15)' : 'rgba(255,71,87,0.15)'};color:${syncStatus.hasAssemblyAiKey ? 'var(--green)' : 'var(--red)'};border:1px solid ${syncStatus.hasAssemblyAiKey ? 'rgba(46,213,115,0.3)' : 'rgba(255,71,87,0.3)'}">
                ${syncStatus.hasAssemblyAiKey ? '● AssemblyAI Ready' : '○ AssemblyAI Offline'}
              </span>
            </div>
          </div>

          <!-- Stats Grid -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
            <div style="background:var(--bg-deep);padding:14px;border-radius:var(--radius-md);text-align:center;border:1px solid var(--border);">
              <div style="font-size:1.6rem;font-weight:800;color:var(--purple-300);">${syncStatus.withTimedLyrics.toLocaleString()}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;">Timed</div>
            </div>
            <div style="background:var(--bg-deep);padding:14px;border-radius:var(--radius-md);text-align:center;border:1px solid var(--border);">
              <div style="font-size:1.6rem;font-weight:800;color:var(--cyan);">${syncStatus.withRawLyrics.toLocaleString()}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;">Have Lyrics</div>
            </div>
            <div style="background:var(--bg-deep);padding:14px;border-radius:var(--radius-md);text-align:center;border:1px solid var(--border);">
              <div style="font-size:1.6rem;font-weight:800;color:${syncStatus.eligible > 0 ? 'var(--orange)' : 'var(--green)'};">${syncStatus.eligible.toLocaleString()}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;">Need Timing</div>
            </div>
            <div style="background:var(--bg-deep);padding:14px;border-radius:var(--radius-md);text-align:center;border:1px solid var(--border);">
              <div style="font-size:1.6rem;font-weight:800;color:${autoStatus.running ? 'var(--green)' : 'var(--text-muted)'};">${autoStatus.running ? '⚡' : '⏸'}</div>
              <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;">${autoStatus.running ? 'RUNNING' : 'IDLE'}</div>
            </div>
          </div>

          <!-- Progress -->
          <div style="margin-bottom:20px;padding:16px;background:var(--bg-deep);border-radius:var(--radius-md);border:1px solid var(--border);">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span style="font-size:0.85rem;font-weight:600;">Coverage</span>
              <span style="font-size:1rem;font-weight:800;color:var(--purple-300);">${pct}%</span>
            </div>
            <div style="height:10px;background:var(--bg-card);border-radius:5px;overflow:hidden;">
              <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--purple-500),var(--cyan));border-radius:5px;transition:width 0.5s;"></div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px;">
            <button class="admin-btn" onclick="triggerAutoLyricsSync('full')" ${autoStatus.running ? 'disabled' : ''} style="padding:14px;background:linear-gradient(135deg,var(--purple-600),var(--purple-700));border:none;border-radius:var(--radius-md);color:#fff;font-weight:700;${autoStatus.running ? 'opacity:0.5;' : ''}">
              🚀 Full Sync
            </button>
            <button class="admin-btn" onclick="triggerAutoLyricsSync('genius-only')" ${autoStatus.running ? 'disabled' : ''} style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text);font-weight:700;${autoStatus.running ? 'opacity:0.5;' : ''}">
              📝 Genius Scan
            </button>
            <button class="admin-btn" onclick="triggerAutoLyricsSync('timing-only')" ${autoStatus.running ? 'disabled' : ''} style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text);font-weight:700;${autoStatus.running ? 'opacity:0.5;' : ''}">
              ⏱ Sync Timing
            </button>
            <button class="admin-btn" onclick="triggerAutoLyricsSync('timing-force')" ${autoStatus.running ? 'disabled' : ''} style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--orange);font-weight:700;${autoStatus.running ? 'opacity:0.5;' : ''}">
              🔄 Force Re-sync
            </button>
          </div>

          <!-- Live Status Panel -->
          <div id="autoSyncStatusPanel" style="margin-bottom:20px;padding:16px;background:rgba(155,93,229,0.1);border-radius:var(--radius-md);border:1px solid var(--border);${autoStatus.running ? '' : 'display:none;'}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <span style="font-size:0.9rem;font-weight:700;color:var(--purple-300);">${autoStatus.mode || 'Syncing'}</span>
              <span style="font-size:0.7rem;color:var(--text-muted);padding:4px 8px;background:var(--bg-card);border-radius:var(--radius-full);">${autoStatus.stage || 'idle'}</span>
            </div>
            <div style="height:8px;background:var(--bg-card);border-radius:4px;overflow:hidden;margin-bottom:12px;">
              <div id="syncProgressBar" style="height:100%;width:${autoStatus.progress?.percent || 0}%;background:var(--green);border-radius:4px;transition:width 0.5s;"></div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;font-size:0.75rem;">
              <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                <div style="font-size:1.1rem;font-weight:700;color:var(--purple-300);" id="syncGeniusFilled">${autoStatus.stats?.geniusFilled || 0}</div>
                <div style="color:var(--text-muted);">Genius</div>
              </div>
              <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                <div style="font-size:1.1rem;font-weight:700;color:var(--cyan);" id="syncTimingSynced">${autoStatus.stats?.timingSynced || 0}</div>
                <div style="color:var(--text-muted);">Timed</div>
              </div>
              <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                <div style="font-size:1.1rem;font-weight:700;color:var(--red);" id="syncErrors">${autoStatus.stats?.errors || 0}</div>
                <div style="color:var(--text-muted);">Errors</div>
              </div>
            </div>
          </div>

          <!-- Logs -->
          <div style="border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg-deep);border-bottom:1px solid var(--border);">
              <span style="font-weight:600;font-size:0.85rem;">📜 Live Logs</span>
              <div style="display:flex;gap:8px;">
                <button class="admin-btn" onclick="refreshLyricsSyncLogs()" style="padding:6px 12px;font-size:0.7rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);">Refresh</button>
                <button class="admin-btn" onclick="toggleLyricsSyncLogs()" style="padding:6px 12px;font-size:0.7rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);">Hide</button>
              </div>
            </div>
            <div id="lyricsSyncLogs" style="display:block;max-height:200px;overflow-y:auto;padding:12px;background:var(--bg-deep);font-family:var(--font-mono);font-size:0.7rem;">
              <div id="lyricsSyncLogsContent" style="color:var(--text-muted);">Click Refresh to load logs...</div>
            </div>
          </div>

          <div style="padding:12px;background:${syncStatus.eligible > 0 ? 'rgba(255,158,44,0.1)' : 'rgba(46,213,115,0.1)'};border-radius:var(--radius-md);border:1px solid ${syncStatus.eligible > 0 ? 'rgba(255,158,44,0.3)' : 'rgba(46,213,115,0.3)'};text-align:center;">
            <span style="font-size:0.85rem;color:${syncStatus.eligible > 0 ? 'var(--orange)' : 'var(--green)'};">
              ${syncStatus.eligible > 0 ? `⚠️ ${syncStatus.eligible.toLocaleString()} songs ready for timing (~${syncStatus.estimatedHours}h)` : '✅ All caught up!'}
            </span>
          </div>
        </div>
      `;
      
      if (autoStatus.running) {
        setTimeout(() => pollLyricsSyncStatus(), 2000);
      }
    } catch {}

    // ─── Catalog Rescan Section ───────────────────────────
    try {
      const rescanStatus = await api('/admin/rescan-catalog/status').catch(() => ({ running: false, phase: 'idle' }));
      const pctRescan = rescanStatus.totalSongs > 0 ? Math.round((rescanStatus.processedSongs / rescanStatus.totalSongs) * 100) : 0;

      sectionsHtml += `
        <div class="admin-section" style="background:linear-gradient(135deg,var(--bg-card) 0%,var(--bg-raised) 100%);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <div style="width:48px;height:48px;border-radius:var(--radius-md);background:linear-gradient(135deg,var(--cyan),var(--purple-500));display:flex;align-items:center;justify-content:center;font-size:24px;">📀</div>
            <div>
              <h3 style="margin:0;font-size:1.2rem;font-weight:700;">Catalog Rescan</h3>
              <p style="margin:4px 0 0;font-size:0.8rem;color:var(--text-muted);">Full metadata + cover art download from JuiceWRLD API</p>
            </div>
            <div style="margin-left:auto;">
              <span style="padding:6px 12px;border-radius:var(--radius-full);font-size:0.75rem;font-weight:600;background:${rescanStatus.running ? 'rgba(46,213,115,0.15)' : 'rgba(255,255,255,0.05)'};color:${rescanStatus.running ? 'var(--green)' : 'var(--text-muted)'};border:1px solid ${rescanStatus.running ? 'rgba(46,213,115,0.3)' : 'var(--border)'}">
                ${rescanStatus.running ? '⚡ RUNNING' : rescanStatus.phase === 'done' ? '✅ COMPLETE' : '⏸ IDLE'}
              </span>
            </div>
          </div>

          ${rescanStatus.running || rescanStatus.phase === 'done' ? `
            <div style="margin-bottom:16px;padding:14px;background:var(--bg-deep);border-radius:var(--radius-md);border:1px solid var(--border);">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                <span style="font-size:0.85rem;font-weight:600;">${esc(rescanStatus.message || rescanStatus.phase)}</span>
                <span style="font-size:1rem;font-weight:800;color:var(--cyan);">${pctRescan}%</span>
              </div>
              <div style="height:8px;background:var(--bg-card);border-radius:4px;overflow:hidden;">
                <div style="height:100%;width:${pctRescan}%;background:linear-gradient(90deg,var(--cyan),var(--purple-400));border-radius:4px;transition:width 0.5s;"></div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px;font-size:0.75rem;">
                <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                  <div style="font-size:1.1rem;font-weight:700;color:var(--green);">${rescanStatus.successCount || 0}</div>
                  <div style="color:var(--text-muted);">Synced</div>
                </div>
                <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                  <div style="font-size:1.1rem;font-weight:700;color:var(--cyan);">${rescanStatus.coversDownloaded || 0}</div>
                  <div style="color:var(--text-muted);">Covers</div>
                </div>
                <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                  <div style="font-size:1.1rem;font-weight:700;color:var(--red);">${rescanStatus.errorCount || 0}</div>
                  <div style="color:var(--text-muted);">Errors</div>
                </div>
                <div style="text-align:center;padding:8px;background:var(--bg-card);border-radius:var(--radius-sm);">
                  <div style="font-size:1.1rem;font-weight:700;color:var(--text);">${rescanStatus.totalSongs || 0}</div>
                  <div style="color:var(--text-muted);">Total</div>
                </div>
              </div>
            </div>
          ` : ''}

          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
            <button class="admin-btn" onclick="triggerCatalogRescan(true)" ${rescanStatus.running ? 'disabled' : ''} style="padding:14px;background:linear-gradient(135deg,var(--cyan),rgba(0,245,212,0.7));border:none;border-radius:var(--radius-md);color:var(--bg-deep);font-weight:700;${rescanStatus.running ? 'opacity:0.5;' : ''}">
              📀 Full Rescan + Covers
            </button>
            <button class="admin-btn" onclick="triggerCatalogRescan(false)" ${rescanStatus.running ? 'disabled' : ''} style="padding:14px;background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text);font-weight:700;${rescanStatus.running ? 'opacity:0.5;' : ''}">
              📝 Metadata Only
            </button>
          </div>

          ${rescanStatus.errors?.length ? `
            <div style="margin-top:16px;max-height:150px;overflow-y:auto;padding:12px;background:var(--bg-deep);border:1px solid var(--border);border-radius:var(--radius-md);font-family:var(--font-mono);font-size:0.7rem;color:var(--red);">
              ${rescanStatus.errors.map(e => '<div style="margin-bottom:4px;">[#' + e.songId + '] ' + esc(e.error) + '</div>').join('')}
            </div>
          ` : ''}
        </div>
      `;
    } catch {}

    // ─── Flagged / Broken Songs Section ──────────────────
    try {
      const flagged = await api('/admin/flagged-songs?status=all');
      const openCount = flagged.statusCounts?.open || 0;
      const resolvedCount = flagged.statusCounts?.resolved || 0;
      const dismissedCount = flagged.statusCounts?.dismissed || 0;

      sectionsHtml += `
        <div class="admin-section" style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-bottom:24px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <div style="width:48px;height:48px;border-radius:var(--radius-md);background:linear-gradient(135deg,var(--red),var(--orange));display:flex;align-items:center;justify-content:center;font-size:24px;">🚩</div>
            <div>
              <h3 style="margin:0;font-size:1.2rem;font-weight:700;">Flagged Songs</h3>
              <p style="margin:4px 0 0;font-size:0.8rem;color:var(--text-muted);">Songs reported as broken — investigate, retry, or remove</p>
            </div>
            <div style="margin-left:auto;display:flex;gap:8px;">
              <span style="padding:4px 10px;border-radius:var(--radius-full);font-size:0.7rem;background:rgba(255,71,87,0.15);color:var(--red);border:1px solid rgba(255,71,87,0.3);">${openCount} open</span>
              <span style="padding:4px 10px;border-radius:var(--radius-full);font-size:0.7rem;background:rgba(46,213,115,0.15);color:var(--green);border:1px solid rgba(46,213,115,0.3);">${resolvedCount} resolved</span>
            </div>
          </div>

          ${flagged.reports?.length ? `
            <div style="max-height:400px;overflow-y:auto;">
              <table class="admin-table" style="font-size:0.8rem;">
                <thead><tr><th>Song</th><th>Reason</th><th>Reporter</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody>
                  ${flagged.reports.map(r => `
                    <tr>
                      <td style="max-width:200px;">
                        <div style="font-weight:600;">${esc(r.song?.name || 'Unknown')}</div>
                        <div style="font-size:0.65rem;color:var(--text-muted);">${esc(r.song?.category || '')}</div>
                      </td>
                      <td style="max-width:200px;word-break:break-word;">
                        <div>${esc(r.reason)}</div>
                        ${r.proxyError ? '<div style="font-size:0.65rem;color:var(--red);margin-top:4px;font-family:var(--font-mono);">' + esc(r.proxyError.slice(0, 100)) + '</div>' : ''}
                      </td>
                      <td>${esc(r.reporter?.displayName || '')}</td>
                      <td>
                        <span style="padding:3px 8px;border-radius:var(--radius-full);font-size:0.65rem;font-weight:600;
                          background:${r.status === 'open' ? 'rgba(255,71,87,0.15)' : r.status === 'resolved' ? 'rgba(46,213,115,0.15)' : 'rgba(255,255,255,0.05)'};
                          color:${r.status === 'open' ? 'var(--red)' : r.status === 'resolved' ? 'var(--green)' : 'var(--text-muted)'};">
                          ${r.status}
                        </span>
                      </td>
                      <td class="admin-actions" style="white-space:nowrap;">
                        ${r.status === 'open' ? `
                          <button class="admin-btn" onclick="retryFlaggedSong('${r.id}')" style="padding:4px 8px;font-size:0.7rem;">Retry</button>
                          <button class="admin-btn" onclick="resolveFlaggedSong('${r.id}','resolved')" style="padding:4px 8px;font-size:0.7rem;color:var(--green);">Resolve</button>
                          <button class="admin-btn" onclick="resolveFlaggedSong('${r.id}','dismissed')" style="padding:4px 8px;font-size:0.7rem;color:var(--text-muted);">Dismiss</button>
                        ` : ''}
                        ${r.apiUrl ? '<a href="' + esc(r.apiUrl) + '" target="_blank" style="font-size:0.65rem;color:var(--purple-300);">API Link</a>' : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : '<div style="text-align:center;padding:20px;color:var(--text-muted);">No flagged songs</div>'}
        </div>
      `;
    } catch {}

    document.getElementById('adminSections').innerHTML = sectionsHtml;

    // Start polling if rescan is running
    const rescanCheck = await api('/admin/rescan-catalog/status').catch(() => ({ running: false }));
    if (rescanCheck.running) pollRescanStatus();
  } catch (err) {
    document.getElementById('adminStats').innerHTML = `<div class="empty-state"><p>Failed to load admin data: ${esc(err.message)}</p></div>`;
  }
}

async function setUserRole(userId, role) {
  try {
    await api(`/admin/users/${userId}/role`, { method: 'PUT', body: JSON.stringify({ role }) });
    toast(`Role updated to ${role}`, 'success');
    loadAdmin();
  } catch (err) { toast(err.message, 'error'); }
}

async function generateInvites() {
  const count = parseInt(document.getElementById('inviteCount').value) || 1;
  try {
    const data = await api('/admin/invites', {
      method: 'POST',
      body: JSON.stringify({ count, expiresInDays: 30 })
    });
    toast(`Generated ${data.invites.length} invite(s)`, 'success');
    loadAdmin();
  } catch (err) { toast(err.message, 'error'); }
}

// ─── Auto Lyrics Sync Controls ──────────────────────────
let lyricsSyncPollInterval = null;

async function triggerAutoLyricsSync(mode) {
  try {
    const result = await api('/admin/lyrics/auto-sync', {
      method: 'POST',
      body: JSON.stringify({ mode })
    });
    toast(`🚀 Auto-sync started: ${mode}`, 'success');
    // Start polling
    pollLyricsSyncStatus();
    // Reload admin after a brief delay to show updated UI
    setTimeout(() => loadAdmin(), 500);
  } catch (err) {
    if (err.message?.includes('already running')) {
      toast('⚠️ Auto-sync is already running', 'warning');
      pollLyricsSyncStatus();
    } else {
      toast(err.message, 'error');
    }
  }
}

async function pollLyricsSyncStatus() {
  try {
    const status = await api('/admin/lyrics/auto-sync/status');
    
    // Update status panel
    const panel = document.getElementById('autoSyncStatusPanel');
    if (panel) {
      if (status.running) {
        panel.style.display = 'block';
      }
      
      // Update progress bar
      const progressBar = document.getElementById('syncProgressBar');
      if (progressBar && status.progress) {
        progressBar.style.width = `${status.progress.percent}%`;
      }
      
      // Update stats
      const geniusEl = document.getElementById('syncGeniusFilled');
      const timingEl = document.getElementById('syncTimingSynced');
      const errorsEl = document.getElementById('syncErrors');
      
      if (geniusEl) geniusEl.textContent = status.stats?.geniusFilled || 0;
      if (timingEl) timingEl.textContent = status.stats?.timingSynced || 0;
      if (errorsEl) errorsEl.textContent = status.stats?.errors || 0;
    }
    
    // Continue polling if still running
    if (status.running) {
      clearTimeout(lyricsSyncPollInterval);
      lyricsSyncPollInterval = setTimeout(() => pollLyricsSyncStatus(), 2000);
    } else {
      // Refresh logs when done
      refreshLyricsSyncLogs();
      // Reload admin UI to update buttons
      loadAdmin();
      toast('✅ Sync complete!', 'success');
    }
  } catch (err) {
    console.error('Poll status error:', err);
  }
}

function toggleLyricsSyncLogs() {
  const logsPanel = document.getElementById('lyricsSyncLogs');
  if (logsPanel) {
    const isVisible = logsPanel.style.display !== 'none';
    logsPanel.style.display = isVisible ? 'none' : 'block';
    if (!isVisible) {
      refreshLyricsSyncLogs();
    }
  }
}

async function refreshLyricsSyncLogs() {
  const content = document.getElementById('lyricsSyncLogsContent');
  if (!content) return;
  
  try {
    const data = await api('/admin/lyrics/auto-sync/logs?limit=50');
    if (data.logs && data.logs.length > 0) {
      content.innerHTML = data.logs.map(line => {
        const color = line.includes('❌') || line.includes('error') ? 'var(--red)' :
                      line.includes('✅') || line.includes('success') ? 'var(--green)' :
                      line.includes('⚠️') || line.includes('warning') ? 'var(--orange)' :
                      'var(--text-muted)';
        return `<div style="color:${color};padding:2px 0;border-bottom:1px solid var(--border);">${esc(line)}</div>`;
      }).join('');
      // Auto-scroll to bottom
      content.parentElement.scrollTop = content.parentElement.scrollHeight;
    } else {
      content.innerHTML = '<div style="color:var(--text-muted)">No logs yet...</div>';
    }
  } catch (err) {
    content.innerHTML = `<div style="color:var(--red)">Failed to load logs: ${esc(err.message)}</div>`;
  }
}

// ─── Catalog Rescan Controls ────────────────────────────
let rescanPollInterval = null;

async function triggerCatalogRescan(downloadCovers) {
  try {
    const result = await api('/admin/rescan-catalog', {
      method: 'POST',
      body: JSON.stringify({ downloadCovers })
    });
    toast('📀 Catalog rescan started' + (downloadCovers ? ' with cover download' : ''), 'success');
    pollRescanStatus();
    setTimeout(() => loadAdmin(), 500);
  } catch (err) {
    if (err.message?.includes('already running')) {
      toast('Rescan is already running', 'warning');
      pollRescanStatus();
    } else {
      toast(err.message, 'error');
    }
  }
}

async function pollRescanStatus() {
  try {
    const status = await api('/admin/rescan-catalog/status');
    if (status.running) {
      clearTimeout(rescanPollInterval);
      rescanPollInterval = setTimeout(() => pollRescanStatus(), 3000);
    } else if (status.phase === 'done') {
      toast('📀 Catalog rescan complete: ' + (status.successCount || 0) + ' songs, ' + (status.coversDownloaded || 0) + ' covers', 'success');
      loadAdmin(); // Refresh the full admin UI
    }
  } catch (err) {
    console.error('Rescan poll error:', err);
  }
}

// ─── Flagged Songs Controls ─────────────────────────────
async function retryFlaggedSong(reportId) {
  try {
    const result = await api('/admin/flagged-songs/' + reportId, {
      method: 'PUT',
      body: JSON.stringify({ action: 'retry' })
    });
    if (result.success) {
      toast('Stream works — song re-enabled!', 'success');
    } else {
      toast('Still broken: ' + (result.message || 'unknown'), 'error');
    }
    loadAdmin();
  } catch (err) {
    toast(err.message, 'error');
  }
}

async function resolveFlaggedSong(reportId, status) {
  try {
    await api('/admin/flagged-songs/' + reportId, {
      method: 'PUT',
      body: JSON.stringify({ status })
    });
    toast('Report ' + status, 'success');
    loadAdmin();
  } catch (err) {
    toast(err.message, 'error');
  }
}

// ─── Single Song Lyrics Sync ────────────────────────────
async function syncSingleLyrics(songId) {
  const btn = document.getElementById('syncLyricsBtn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner" style="width:14px;height:14px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px;"></div> Syncing...';
  }
  try {
    const result = await api('/admin/lyrics/sync-single', {
      method: 'POST',
      body: JSON.stringify({ songId }),
    });
    toast(`✅ Lyrics synced for "${result.songName}" — ${result.lineCount} timed lines`, 'success');
    // Reload the detail page to show timed lyrics
    loadSongDetail(songId);
  } catch (err) {
    toast(`❌ Lyrics sync failed: ${err.message}`, 'error');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '⚡ Retry Sync';
    }
  }
}

// ─── Keyboard Shortcuts ─────────────────────────────────
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  switch (e.key) {
    case ' ':
      e.preventDefault();
      togglePlay();
      break;
    case 'f': case 'F':
      toggleFullscreenLyrics();
      break;
    case 'q': case 'Q':
      toggleQueue();
      break;
    case 's': case 'S':
      toggleShuffle();
      break;
    case 'r': case 'R':
      toggleRepeat();
      break;
    case 'x': case 'X':
      toggleRadio();
      break;
    case 'l': case 'L':
      e.preventDefault();
      if (currentSong) {
        toggleLike(currentSong.id);
        updateAllLikeButtons(currentSong.id);
      }
      break;
    case 'ArrowRight':
      if (e.shiftKey) playNext();
      else if (audio.duration) audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
      break;
    case 'ArrowLeft':
      if (e.shiftKey) playPrev();
      else if (audio.duration) audio.currentTime = Math.max(0, audio.currentTime - 10);
      break;
    case 'ArrowUp':
      e.preventDefault();
      audio.volume = Math.min(1, audio.volume + 0.1);
      volume = audio.volume;
      updateVolumeUI();
      break;
    case 'ArrowDown':
      e.preventDefault();
      audio.volume = Math.max(0, audio.volume - 0.1);
      volume = audio.volume;
      updateVolumeUI();
      break;
    case 'Escape':
      if (fsLyricsOpen) toggleFullscreenLyrics();
      if (bulkSelectMode) toggleBulkSelectMode();
      break;
  }
});

// Media Session
if ('mediaSession' in navigator) {
  navigator.mediaSession.setActionHandler('play', () => { audio.play(); });
  navigator.mediaSession.setActionHandler('pause', () => { audio.pause(); });
  navigator.mediaSession.setActionHandler('previoustrack', playPrev);
  navigator.mediaSession.setActionHandler('nexttrack', playNext);
}

// ─── Utilities ──────────────────────────────────────────

// Cover art: prefer local stored cover > imageUrl (fast) > embedded cover-art (slow) > placeholder
function artSrc(s) {
  if (s.localCoverPath) return s.localCoverPath;   // Local stored cover (from rescan)
  if (s.imageUrl) return s.imageUrl;                // External URL
  if (s.hasFilePath) return `/api/songs/${s.id}/cover-art`; // Embedded from audio
  return '';
}
function artTag(s, fallback) {
  const placeholderSrc = '/assets/JuiceVaultAlbumCoverPlaceHolder.png';
  const src = artSrc(s);
  if (!src) return `<img src="${placeholderSrc}" loading="lazy" onload="this.classList.add('loaded')">`;
  return `<img src="${src}" onerror="this.src='${placeholderSrc}'" loading="lazy" onload="this.classList.add('loaded')">`;
}

function fmtTime(s) {
  if (!s || isNaN(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function toast(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  container.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; setTimeout(() => t.remove(), 300); }, 3000);
}


// ─── V2: Search By Lyrics Toggle ────────────────────────
function toggleSearchLyrics() {
  searchByLyrics = !searchByLyrics;
  document.getElementById('searchLyricsToggle').classList.toggle('active', searchByLyrics);
  if (searchQuery.length >= 2) doSearch();
}

// ─── V2: Catalog Infinite Scroll + Filters ──────────────
let catalogObserver = null;

function setupInfiniteScroll() {
  const sentinel = document.getElementById('catalogSentinel');
  if (!sentinel) return;
  if (catalogObserver) catalogObserver.disconnect();
  catalogObserver = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting && !catalogLoading && catalogHasMore) {
      catalogPage++;
      loadCatalogPage(true);
    }
  }, { threshold: 0.1 });
  catalogObserver.observe(sentinel);
}

function applyCatalogFilters() {
  catalogEra = document.getElementById('eraFilter')?.value || '';
  const sortVal = document.getElementById('sortFilter')?.value || 'name-asc';
  catalogSort = sortVal;
  catalogHasLyrics = document.getElementById('lyricsOnlyFilter')?.checked || false;
  catalogPage = 1;
  catalogHasMore = true;
  catalogAllSongs = [];
  document.getElementById('catalogContent').innerHTML = '';
  loadCatalogPage(false);
  updateActiveFilterChips();
}

function updateActiveFilterChips() {
  const cont = document.getElementById('activeFilterChips');
  if (!cont) return;
  let html = '';
  if (catalogCategory) html += '<div class="filter-active-chip">' + catalogCategory + ' <span class="chip-x" onclick="filterCatalog(document.querySelector(\'[data-cat=\"\"]\')||document.querySelector(\'.filter-chip\'),\'\')">✕</span></div>';
  if (catalogEra) html += '<div class="filter-active-chip">Era: ' + catalogEra + ' <span class="chip-x" onclick="document.getElementById(\'eraFilter\').value=\'\';applyCatalogFilters()">✕</span></div>';
  if (catalogHasLyrics) html += '<div class="filter-active-chip">Has Lyrics <span class="chip-x" onclick="document.getElementById(\'lyricsOnlyFilter\').checked=false;applyCatalogFilters()">✕</span></div>';
  cont.innerHTML = html;
}

async function loadCatalogPage(append) {
  if (catalogLoading) return;
  catalogLoading = true;
  const sentinel = document.getElementById('catalogSentinel');
  const container = document.getElementById('catalogContent');

  if (!append) {
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  }
  if (sentinel) sentinel.style.display = 'flex';

  try {
    let url = '/songs?page=' + catalogPage + '&pageSize=30';
    if (catalogCategory) url += '&category=' + catalogCategory;
    else url += '&excludeCategories=unsurfaced,recording_session';
    if (catalogEra) url += '&era=' + encodeURIComponent(catalogEra);
    if (catalogHasLyrics) url += '&hasLyrics=true';

    const parts = catalogSort.split('-');
    if (parts.length === 2) {
      url += '&sortBy=' + parts[0] + '&sortOrder=' + parts[1];
    }

    const data = await api(url);
    document.getElementById('catalogCount').textContent = data.pagination.total + ' songs';

    if (!append) {
      container.innerHTML = '';
      container.className = catalogView === 'list' ? 'song-list' : 'song-grid';
    }

    if (!data.songs.length) {
      catalogHasMore = false;
      if (!append) container.innerHTML = '<div class="empty-state"><div class="es-icon">🎵</div><h3>No Songs Found</h3></div>';
    } else {
      catalogAllSongs = catalogAllSongs.concat(data.songs);
      if (catalogView === 'list') {
        data.songs.forEach((s, i) => {
          const idx = catalogAllSongs.length - data.songs.length + i;
          const row = document.createElement('div');
          row.className = 'song-row' + (currentSong?.id === s.id ? ' active' : '');
          const imgHtml = artTag(s, '🎵');
          row.innerHTML =
            '<div class="song-row-num">' + (currentSong?.id === s.id ? '<div class="playing-bars"><span></span><span></span><span></span><span></span></div>' : (idx + 1)) + '</div>' +
            '<div class="song-row-art">' + imgHtml + '</div>' +
            '<div><div class="song-row-title">' + esc(s.name) + '</div></div>' +
            '<div class="song-row-artist">' + esc(s.creditedArtists || 'Juice WRLD') + '</div>' +
            '<div class="song-row-duration">' + (s.length || '\u2014') + '</div>' +
            '<div class="song-row-actions">' +
              '<button class="song-row-btn" onclick="event.stopPropagation(); addToQueueById(\'' + s.id + '\')" title="Add to queue">+</button>' +
            '</div>';
          row.addEventListener('click', () => navigateToDetail(s.id));
          container.appendChild(row);
        });
      } else {
        data.songs.forEach((s, i) => {
          const card = createSongCard(s, catalogAllSongs.length - data.songs.length + i);
          container.appendChild(card);
        });
      }
      catalogHasMore = data.pagination.page < data.pagination.totalPages;
    }
  } catch (err) {
    if (!append) container.innerHTML = '<div class="empty-state"><div class="es-icon">😕</div><h3>Failed to Load</h3></div>';
  } finally {
    catalogLoading = false;
    if (sentinel) sentinel.style.display = catalogHasMore ? 'flex' : 'none';
  }
}

function createSongCard(s, i) {
  const card = document.createElement('div');
  card.className = 'song-card';
  card.style.animationDelay = (i % 30) * 0.03 + 's';
  card.style.animation = 'fadeIn 0.3s var(--ease-out) both';
  card.dataset.songId = s.id;
  const imgHtml = artTag(s, '🎵');
  const cat = (s.category || '').replace(/_/g, ' ');
  const isLiked = userLikes[s.id] === true;
  
  // Get like count
  const likeCount = likeCounts[s.id] || s.likeCount || 0;
  const likeCountDisplay = likeCount > 0 ? `<span class="like-count ${isLiked ? 'has-likes' : ''}">${formatLikeCount(likeCount)}</span>` : '';
  
  // Friend likes
  let friendLikesHtml = '';
  const friends = friendLikes[s.id] || [];
  if (friends.length > 0) {
    friendLikesHtml = '<div class="friend-likes">' +
      '<div class="friend-likes-avatars">' +
        friends.slice(0, 2).map(f => `<span>${f.charAt(0).toUpperCase()}</span>`).join('') +
      '</div>' +
      '<span>' + (friends.length === 1 ? friends[0] + ' liked' : friends.length + ' friends liked') + '</span>' +
    '</div>';
  }

  card.innerHTML =
    '<div class="song-card-art">' +
      imgHtml +
      '<div class="song-card-actions">' +
        '<button class="sca-btn ' + (isLiked ? 'liked' : '') + '" onclick="event.stopPropagation();toggleLike(\'' + s.id + '\',this)" title="Like">' +
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="' + (isLiked ? 'currentColor' : 'none') + '" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>' +
          '<span class="like-tooltip">' + (isLiked ? 'Remove from Liked' : 'Add to Liked Songs') + '</span>' +
        '</button>' +
        '<button class="sca-btn" onclick="event.stopPropagation();openPlaylistModal(\'' + s.id + '\')" title="Add to playlist">' +
          '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>' +
        '</button>' +
      '</div>' +
      (s.hasFilePath !== false ? 
        '<button class="song-card-play" onclick="event.stopPropagation(); playSongById(\'' + s.id + '\')">' +
          '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>' +
        '</button>' :
        '<div style="position:absolute;bottom:10px;right:10px;padding:8px 12px;background:rgba(0,0,0,0.6);border-radius:var(--radius-full);font-size:0.7rem;color:var(--text-muted);">🔇 Unavailable</div>'
      ) +
      '<div class="swipe-hint">👈 Swipe to like</div>' +
    '</div>' +
    '<div class="song-card-info">' +
      '<div class="song-card-name">' + esc(s.name) + likeCountDisplay + '</div>' +
      '<div class="song-card-meta">' + esc(s.creditedArtists || 'Juice WRLD') + '</div>' +
      friendLikesHtml +
      '<div class="song-card-badges">' +
        (s.hasFilePath ? '<span class="song-badge badge-available">▶</span>' : '') +
        ((s.hasLyrics || s.hasRawLyrics) ? '<span class="song-badge badge-lyrics">Lyrics</span>' : '') +
        (cat ? '<span class="song-badge badge-category">' + esc(cat) + '</span>' : '') +
      '</div>' +
    '</div>';

  card.addEventListener('click', () => { if (s.id) navigateToDetail(s.id); });
  
  // Touch swipe support for mobile
  let touchStartX = 0;
  let touchEndX = 0;
  card.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
  }, {passive: true});
  card.addEventListener('touchend', e => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe(s.id, card, touchStartX, touchEndX);
  }, {passive: true});
  
  return card;
}

function formatLikeCount(count) {
  if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
  if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
  return count.toString();
}

function handleSwipe(songId, card, startX, endX) {
  const threshold = 100;
  const diff = startX - endX;
  
  if (Math.abs(diff) > threshold) {
    if (diff > 0) {
      // Swipe left - show hint or unlike
      card.classList.add('show-swipe-hint');
      setTimeout(() => card.classList.remove('show-swipe-hint'), 1000);
    } else {
      // Swipe right - like
      if (!userLikes[songId]) {
        toggleLike(songId);
        // Visual feedback
        card.style.transform = 'translateX(10px)';
        setTimeout(() => card.style.transform = '', 200);
      }
    }
  }
}

// ─── V2: Likes ──────────────────────────────────────────
async function loadUserLikes() {
  try {
    const data = await api('/playlists/likes/me');
    userLikes = data.likes || {};
    updateLibraryBadge();
    calculateLikeStats();
  } catch { userLikes = {}; }
}

async function toggleLike(songId, btn, skipAnimation = false) {
  const wasLiked = userLikes[songId] === true;
  const newState = wasLiked ? null : true;
  
  // Optimistic UI update
  if (newState === null) delete userLikes[songId];
  else userLikes[songId] = newState;
  
  // Update UI immediately
  if (btn) updateLikeButtonVisual(btn, newState, !skipAnimation);
  updateLibraryBadge();
  
  // Track in history
  if (newState) {
    addToRecentlyLiked(songId);
    incrementStreak();
  }
  
  // Show appropriate toast with undo option
  if (!newState && wasLiked) {
    showUnlikeToast(songId);
  } else {
    toast(newState ? 'Added to Liked Songs ❤️' : 'Removed from Liked Songs', 'info');
  }
  
  // Update like counts
  if (likeCounts[songId] !== undefined) {
    likeCounts[songId] = Math.max(0, likeCounts[songId] + (newState ? 1 : -1));
  }
  
  try {
    // Handle offline mode
    if (!isOnline) {
      queueLikeForSync(songId, newState);
      return;
    }
    
    await api('/playlists/like/' + songId, { method: 'POST', body: JSON.stringify({ liked: newState }) });
  } catch (err) { 
    // Revert on failure
    if (newState === null) userLikes[songId] = true;
    else delete userLikes[songId];
    if (btn) updateLikeButtonVisual(btn, !newState, false);
    updateLibraryBadge();
    toast('Failed: ' + err.message, 'error'); 
  }
}

function updateLikeButtonVisual(btn, isLiked, animate = false) {
  btn.classList.toggle('liked', !!isLiked);
  const svg = btn.querySelector('svg');
  if (svg) svg.setAttribute('fill', isLiked ? 'currentColor' : 'none');
  
  if (animate && isLiked) {
    btn.classList.add('animating');
    setTimeout(() => btn.classList.remove('animating'), 600);
  }
}

function updateAllLikeButtons(songId) {
  const isLiked = userLikes[songId] === true;
  
  // Update mini player button
  const miniBtn = document.getElementById('miniPlayerLikeBtn');
  if (miniBtn) updateLikeButtonVisual(miniBtn, isLiked, true);
  
  // Update fullscreen lyrics button
  const fsBtn = document.getElementById('fsLikeBtn');
  if (fsBtn) {
    updateLikeButtonVisual(fsBtn, isLiked, true);
    fsBtn.classList.toggle('liked', isLiked);
  }
  
  // Update player bar like button (if current song matches)
  if (currentSong && currentSong.id === songId) {
    const playerLikeBtn = document.getElementById('playerLikeBtn');
    if (playerLikeBtn) {
      updateLikeButtonVisual(playerLikeBtn, isLiked, true);
      playerLikeBtn.classList.toggle('liked', isLiked);
    }
  }
  
  // Update all sca-btn elements for this song
  document.querySelectorAll('.sca-btn').forEach(btn => {
    const onclick = btn.getAttribute('onclick') || '';
    if (onclick.includes(songId)) {
      updateLikeButtonVisual(btn, isLiked, false);
    }
  });
}

function toggleCurrentSongLike(btn) {
  if (!currentSong) return;
  toggleLike(currentSong.id, btn);
  updateAllLikeButtons(currentSong.id);
}

function openPlaylistModalForCurrentSong() {
  if (!currentSong) {
    toast('No song is currently playing', 'error');
    return;
  }
  openPlaylistModal(currentSong.id);
}

// Playlist detail helper functions
function formatDuration(seconds) {
  if (!seconds || seconds <= 0) return '';
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  if (hrs > 0) return `${hrs} hr ${mins} min`;
  return `${mins} min`;
}

function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  const now = new Date();
  const diff = now - date;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  if (days < 365) return `${Math.floor(days / 30)} months ago`;
  return `${Math.floor(days / 365)} years ago`;
}

async function shufflePlaylist(id) {
  try {
    const p = await api('/playlists/' + id);
    const playable = p.songs?.filter(s => s.hasFilePath);
    if (!playable.length) { 
      toast('No playable songs in this playlist', 'error'); 
      return; 
    }
    // Shuffle
    for (let i = playable.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [playable[i], playable[j]] = [playable[j], playable[i]];
    }
    queue = playable.slice(1);
    playSong(playable[0]);
    shuffleOn = true;
    toast('Shuffling ' + p.name, 'success');
  } catch (err) { 
    toast(err.message, 'error'); 
  }
}

async function togglePlaylistLike(id, btn) {
  try {
    const isLiked = btn.classList.contains('liked');
    if (isLiked) {
      await api('/playlists/' + id + '/unlike', { method: 'POST' });
      btn.classList.remove('liked');
      btn.querySelector('svg').setAttribute('fill', 'none');
      toast('Removed from liked playlists', 'info');
    } else {
      await api('/playlists/' + id + '/like', { method: 'POST' });
      btn.classList.add('liked');
      btn.querySelector('svg').setAttribute('fill', 'currentColor');
      toast('Added to liked playlists', 'success');
    }
  } catch (err) {
    toast(err.message, 'error');
  }
}

function togglePlaylistMenu(id, isOwner) {
  // Create dropdown menu
  const existing = document.querySelector('.playlist-dropdown');
  if (existing) {
    existing.remove();
    return;
  }
  
  const menu = document.createElement('div');
  menu.className = 'playlist-dropdown';
  menu.innerHTML = `
    <button onclick="sharePlaylist('${id}')">🔗 Share</button>
    <button onclick="copyPlaylistLink('${id}')">📋 Copy Link</button>
    ${isOwner ? `
      <button onclick="editPlaylist('${id}')">✏️ Edit Details</button>
      <button onclick="deletePlaylist('${id}')" class="danger">🗑️ Delete</button>
    ` : ''}
  `;
  
  document.body.appendChild(menu);
  
  // Position near the button
  const btn = document.querySelector('.playlist-more-btn');
  if (btn) {
    const rect = btn.getBoundingClientRect();
    menu.style.position = 'fixed';
    menu.style.top = rect.bottom + 8 + 'px';
    menu.style.right = window.innerWidth - rect.right + 'px';
  }
  
  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function close(e) {
      if (!menu.contains(e.target)) {
        menu.remove();
        document.removeEventListener('click', close);
      }
    });
  }, 100);
}

function filterPlaylistSongs(query) {
  const rows = document.querySelectorAll('.playlist-song-row');
  const lower = query.toLowerCase();
  rows.forEach(row => {
    const name = row.querySelector('.pl-song-name')?.textContent?.toLowerCase() || '';
    const artist = row.querySelector('.pl-song-artist')?.textContent?.toLowerCase() || '';
    row.style.display = (name.includes(lower) || artist.includes(lower)) ? '' : 'none';
  });
}

function sortPlaylistSongs(sortBy) {
  const list = document.getElementById('playlistSongsList');
  if (!list) return;
  const rows = Array.from(list.querySelectorAll('.playlist-song-row'));
  
  rows.sort((a, b) => {
    switch(sortBy) {
      case 'name':
        return a.querySelector('.pl-song-name').textContent.localeCompare(b.querySelector('.pl-song-name').textContent);
      case 'artist':
        return a.querySelector('.pl-song-artist').textContent.localeCompare(b.querySelector('.pl-song-artist').textContent);
      case 'added':
        return parseInt(b.dataset.index) - parseInt(a.dataset.index);
      default:
        return parseInt(a.dataset.index) - parseInt(b.dataset.index);
    }
  });
  
  rows.forEach((row, i) => {
    row.querySelector('.pl-song-num').textContent = i + 1;
    list.appendChild(row);
  });
}

function initPlaylistDragAndDrop() {
  const list = document.getElementById('playlistSongsList');
  if (!list) return;
  
  let dragged = null;
  
  list.querySelectorAll('.playlist-song-row').forEach(row => {
    row.addEventListener('dragstart', e => {
      dragged = row;
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    
    row.addEventListener('dragend', () => {
      row.classList.remove('dragging');
      dragged = null;
      // Update indices
      list.querySelectorAll('.playlist-song-row').forEach((r, i) => {
        r.dataset.index = i;
        r.querySelector('.pl-song-num').textContent = i + 1;
      });
      // Save new order to server
      savePlaylistOrder(list.dataset.playlistId);
    });
    
    row.addEventListener('dragover', e => {
      e.preventDefault();
      if (!dragged || dragged === row) return;
      
      const rect = row.getBoundingClientRect();
      const mid = rect.top + rect.height / 2;
      
      if (e.clientY < mid) {
        row.parentNode.insertBefore(dragged, row);
      } else {
        row.parentNode.insertBefore(dragged, row.nextSibling);
      }
    });
  });
}

async function savePlaylistOrder(playlistId) {
  const list = document.getElementById('playlistSongsList');
  if (!list) return;
  const songIds = Array.from(list.querySelectorAll('.playlist-song-row')).map(row => row.dataset.songId);
  
  try {
    await api('/playlists/' + playlistId + '/reorder', {
      method: 'POST',
      body: JSON.stringify({ songIds })
    });
  } catch (err) {
    console.error('Failed to save playlist order:', err);
  }
}

async function removeFromPlaylist(songId) {
  const list = document.getElementById('playlistSongsList');
  if (!list) return;
  const playlistId = list.dataset.playlistId;
  
  try {
    await api('/playlists/' + playlistId + '/songs/' + songId, { method: 'DELETE' });
    const row = list.querySelector(`[data-song-id="${songId}"]`);
    if (row) {
      row.style.opacity = '0';
      setTimeout(() => row.remove(), 300);
    }
    toast('Song removed from playlist', 'info');
  } catch (err) {
    toast(err.message, 'error');
  }
}

async function addPlaylistComment(playlistId) {
  const input = document.getElementById('playlistCommentInput');
  const text = input?.value?.trim();
  if (!text) return;
  
  try {
    await api('/playlists/' + playlistId + '/comments', {
      method: 'POST',
      body: JSON.stringify({ text })
    });
    input.value = '';
    loadPlaylistComments(playlistId);
    toast('Comment posted', 'success');
  } catch (err) {
    toast(err.message, 'error');
  }
}

async function loadPlaylistComments(playlistId) {
  try {
    const data = await api('/playlists/' + playlistId + '/comments');
    const container = document.getElementById('playlistCommentsList');
    const count = document.getElementById('playlistCommentCount');
    if (count) count.textContent = data.comments?.length || 0;
    
    if (!container) return;
    
    if (!data.comments?.length) {
      container.innerHTML = '<p class="no-comments">No comments yet. Be the first!</p>';
      return;
    }
    
    container.innerHTML = data.comments.map(c => `
      <div class="playlist-comment">
        <div class="comment-avatar">${c.user?.displayName?.charAt(0).toUpperCase() || 'U'}</div>
        <div class="comment-content">
          <div class="comment-header">
            <span class="comment-author">${esc(c.user?.displayName || 'Unknown')}</span>
            <span class="comment-time">${formatDate(c.createdAt)}</span>
          </div>
          <p class="comment-text">${esc(c.text)}</p>
        </div>
      </div>
    `).join('');
  } catch (err) {
    console.error('Failed to load comments:', err);
  }
}

async function sharePlaylist(id) {
  const dropdown = document.querySelector('.playlist-dropdown');
  if (dropdown) dropdown.remove();
  
  try {
    const data = await api('/playlists/' + id + '/share', { method: 'POST' });
    if (data.shareUrl) {
      await navigator.clipboard.writeText(data.shareUrl);
      toast('Share link copied to clipboard!', 'success');
    }
  } catch (err) {
    toast(err.message, 'error');
  }
}

function copyPlaylistLink(id) {
  const url = window.location.origin + '/playlist/' + id;
  navigator.clipboard.writeText(url);
  toast('Link copied to clipboard!', 'success');
  const dropdown = document.querySelector('.playlist-dropdown');
  if (dropdown) dropdown.remove();
}

async function editPlaylist(id) {
  const dropdown = document.querySelector('.playlist-dropdown');
  if (dropdown) dropdown.remove();
  
  const newName = prompt('Enter new playlist name:');
  if (!newName?.trim()) return;
  
  try {
    await api('/playlists/' + id, {
      method: 'PUT',
      body: JSON.stringify({ name: newName.trim() })
    });
    toast('Playlist updated', 'success');
    loadPlaylistDetail(id);
  } catch (err) {
    toast(err.message, 'error');
  }
}

async function deletePlaylist(id) {
  const dropdown = document.querySelector('.playlist-dropdown');
  if (dropdown) dropdown.remove();
  
  if (!confirm('Are you sure you want to delete this playlist?')) return;
  
  try {
    await api('/playlists/' + id, { method: 'DELETE' });
    toast('Playlist deleted', 'info');
    navigateTo('library');
  } catch (err) {
    toast(err.message, 'error');
  }
}

function updateLibraryBadge() {
  const badge = document.getElementById('libraryLikedBadge');
  if (badge) {
    const count = Object.keys(userLikes).length;
    badge.textContent = count > 99 ? '99+' : count;
    badge.style.display = count > 0 ? 'flex' : 'none';
  }
}

// ─── Recently Played ────────────────────────────────────
let recentlyPlayed = [];

function addToRecentlyPlayed(song) {
  // Remove if already exists
  recentlyPlayed = recentlyPlayed.filter(s => s.id !== song.id);
  // Add to front
  recentlyPlayed.unshift({ ...song, playedAt: Date.now() });
  // Keep only last 20
  if (recentlyPlayed.length > 20) recentlyPlayed = recentlyPlayed.slice(0, 20);
  // Save
  localStorage.setItem('jv_recently_played', JSON.stringify(recentlyPlayed));
  // Render if on home
  renderRecentlyPlayed();
}

function loadRecentlyPlayed() {
  const saved = localStorage.getItem('jv_recently_played');
  if (saved) {
    try { recentlyPlayed = JSON.parse(saved); } catch {}
  }
}

function renderRecentlyPlayed() {
  const section = document.getElementById('recentlyPlayedSection');
  const list = document.getElementById('recentlyPlayedList');
  if (!section || !list) return;
  
  if (!recentlyPlayed.length) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  list.innerHTML = '';
  
  recentlyPlayed.slice(0, 5).forEach((s, i) => {
    const row = document.createElement('div');
    row.className = 'song-row' + (currentSong?.id === s.id ? ' active' : '');
    const imgHtml = artTag(s, '🎵');
    const isLiked = userLikes[s.id] === true;
    
    row.innerHTML = `
      <div class="song-row-num">${i + 1}</div>
      <div class="song-row-art">${imgHtml}</div>
      <div><div class="song-row-title">${esc(s.name)}</div></div>
      <div class="song-row-artist">${esc(s.creditedArtists || 'Juice WRLD')}</div>
      <div class="song-row-duration">${formatTimeAgo(s.playedAt)}</div>
      <div class="song-row-actions">
        <button class="song-row-btn recent-like-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation();toggleLike('${s.id}', this)" title="Like">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        </button>
        <button class="song-row-btn" onclick="event.stopPropagation(); addToQueueById('${s.id}')" title="Add to queue">+</button>
      </div>
    `;
    row.addEventListener('click', () => playSongById(s.id));
    list.appendChild(row);
  });
}

function clearRecentlyPlayed() {
  recentlyPlayed = [];
  localStorage.removeItem('jv_recently_played');
  renderRecentlyPlayed();
}

// ─── V3: Enhanced Like System Functions ─────────────────

// 1. Bulk Like/Unlike
function toggleBulkSelectMode() {
  bulkSelectMode = !bulkSelectMode;
  selectedSongs.clear();
  
  document.getElementById('bulkSelectToggle').textContent = bulkSelectMode ? 'Done' : 'Select';
  
  const grid = document.getElementById('likedSongsGrid');
  grid.querySelectorAll('.song-card').forEach(card => {
    card.classList.toggle('bulk-select', bulkSelectMode);
    if (bulkSelectMode) {
      const checkbox = document.createElement('div');
      checkbox.className = 'bulk-checkbox';
      checkbox.onclick = (e) => { e.stopPropagation(); toggleSongSelection(card.dataset.songId, checkbox); };
      card.appendChild(checkbox);
    } else {
      card.querySelector('.bulk-checkbox')?.remove();
    }
  });
  
  // Show/hide bulk actions bar
  let bulkBar = document.getElementById('bulkActionsBar');
  if (bulkSelectMode) {
    if (!bulkBar) {
      bulkBar = document.createElement('div');
      bulkBar.id = 'bulkActionsBar';
      bulkBar.className = 'bulk-actions-bar';
      bulkBar.innerHTML = `
        <span id="bulkSelectCount">0 selected</span>
        <button class="bulk-btn bulk-btn-like" onclick="bulkLikeSelected()">❤️ Like All</button>
        <button class="bulk-btn bulk-btn-unlike" onclick="bulkUnlikeSelected()">💔 Unlike</button>
        <button class="bulk-btn-close" onclick="toggleBulkSelectMode()">✕</button>
      `;
      document.getElementById('page-library').appendChild(bulkBar);
    }
    bulkBar.style.display = 'flex';
  } else if (bulkBar) {
    bulkBar.style.display = 'none';
  }
}

function toggleSongSelection(songId, checkbox) {
  if (selectedSongs.has(songId)) {
    selectedSongs.delete(songId);
    checkbox.classList.remove('checked');
    checkbox.textContent = '';
  } else {
    selectedSongs.add(songId);
    checkbox.classList.add('checked');
    checkbox.textContent = '✓';
  }
  document.getElementById('bulkSelectCount').textContent = `${selectedSongs.size} selected`;
}

async function bulkLikeSelected() {
  const ids = Array.from(selectedSongs);
  if (!ids.length) return;
  
  toast(`Liking ${ids.length} songs...`, 'info');
  let success = 0;
  
  for (const id of ids) {
    try {
      if (!userLikes[id]) {
        await api('/playlists/like/' + id, { method: 'POST', body: JSON.stringify({ liked: true }) });
        userLikes[id] = true;
        success++;
      }
    } catch (e) {}
  }
  
  toast(`Liked ${success} songs! ❤️`, 'success');
  updateLibraryBadge();
  loadLibrary();
  toggleBulkSelectMode();
}

async function bulkUnlikeSelected() {
  const ids = Array.from(selectedSongs);
  if (!ids.length) return;
  
  // Fade out animation
  ids.forEach(id => {
    const card = document.querySelector(`.song-card[data-song-id="${id}"]`);
    if (card) card.classList.add('fading-out');
  });
  
  toast(`Removing ${ids.length} songs...`, 'info');
  
  setTimeout(async () => {
    for (const id of ids) {
      try {
        await api('/playlists/like/' + id, { method: 'POST', body: JSON.stringify({ liked: null }) });
        delete userLikes[id];
      } catch (e) {}
    }
    updateLibraryBadge();
    loadLibrary();
    toggleBulkSelectMode();
  }, 500);
}

// 2. Heart burst animation is handled in CSS with .animating class

// 3. Like counts - store locally and fetch from server
async function fetchLikeCounts(songIds) {
  try {
    const data = await api('/songs/like-counts', { 
      method: 'POST', 
      body: JSON.stringify({ songIds }) 
    });
    likeCounts = { ...likeCounts, ...data.counts };
  } catch {}
}

// 4. Most liked songs - load in loadHome
async function loadMostLikedSongs() {
  try {
    const data = await api('/songs?page=1&pageSize=15&sortBy=likeCount&sortOrder=desc');
    renderCarousel('mostLikedSongs', data.songs || []);
  } catch {
    document.getElementById('mostLikedSongs').innerHTML = '<div class="empty-state" style="padding:20px"><p>No data yet</p></div>';
  }
}

// 9. Unlike with undo
function showUnlikeToast(songId) {
  lastUnlikeSong = songId;
  
  const container = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast info undo-toast';
  t.innerHTML = `<span>Removed from Liked Songs</span><button onclick="undoUnlike()">Undo</button>`;
  container.appendChild(t);
  
  undoTimeout = setTimeout(() => {
    t.style.opacity = '0'; 
    t.style.transform = 'translateY(10px)'; 
    setTimeout(() => t.remove(), 300);
    lastUnlikeSong = null;
  }, 5000);
}

function undoUnlike() {
  if (!lastUnlikeSong) return;
  
  clearTimeout(undoTimeout);
  toggleLike(lastUnlikeSong, null, true);
  updateAllLikeButtons(lastUnlikeSong);
  
  // Remove undo toast
  document.querySelectorAll('.undo-toast').forEach(t => t.remove());
  toast('Restored to Liked Songs', 'success');
  lastUnlikeSong = null;
}

// 10. Recently liked songs
function addToRecentlyLiked(songId) {
  const existing = recentlyLiked.findIndex(r => r.songId === songId);
  if (existing > -1) recentlyLiked.splice(existing, 1);
  
  recentlyLiked.unshift({ songId, timestamp: Date.now() });
  if (recentlyLiked.length > 10) recentlyLiked = recentlyLiked.slice(0, 10);
  
  localStorage.setItem('jv_recently_liked', JSON.stringify(recentlyLiked));
}

async function renderRecentlyLiked() {
  const section = document.getElementById('recentlyLikedSection');
  const list = document.getElementById('recentlyLikedList');
  
  const saved = localStorage.getItem('jv_recently_liked');
  if (saved) {
    try { recentlyLiked = JSON.parse(saved); } catch {}
  }
  
  if (!recentlyLiked.length) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  list.innerHTML = '';
  
  const recentIds = recentlyLiked.slice(0, 5);
  const songs = await Promise.all(
    recentIds.map(r => api('/songs/' + r.songId).catch(() => null))
  );
  
  songs.filter(Boolean).forEach((s, i) => {
    const item = document.createElement('div');
    item.className = 'recently-liked-item';
    item.onclick = () => navigateToDetail(s.id);
    const img = artTag(s, '🎵');
    item.innerHTML = `
      ${img.replace('<img', '<img style="width:32px;height:32px;border-radius:50%;object-fit:cover;"')}
      <div>
        <div class="rli-name">${esc(s.name)}</div>
        <div class="rli-time">${formatTimeAgo(recentIds[i].timestamp)}</div>
      </div>
    `;
    list.appendChild(item);
  });
}

function formatTimeAgo(timestamp) {
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'Just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  return `${Math.floor(hours / 24)}d ago`;
}

// 12. Sort liked songs
function changeLikedSort(sort) {
  likedSongsSort = sort;
  loadLibrary();
}

// 13. Filter liked songs
function changeLikedFilter(filter) {
  likedSongsFilter = filter;
  loadLibrary();
}

// 14. Share liked songs
async function shareLikedSongs() {
  const likedIds = Object.keys(userLikes);
  const shareText = `I have ${likedIds.length} liked songs on JuiceVault! 🧃❤️`;
  
  if (navigator.share) {
    try {
      await navigator.share({
        title: 'My JuiceVault Liked Songs',
        text: shareText,
        url: window.location.origin + '/library'
      });
    } catch {}
  } else {
    navigator.clipboard.writeText(shareText + '\n' + window.location.origin);
    toast('Copied to clipboard!', 'success');
  }
}

// 15. Export liked songs to playlist
async function exportLikedToPlaylist() {
  const name = prompt('Playlist name:', 'My Liked Songs');
  if (!name) return;
  
  try {
    const data = await api('/playlists', { method: 'POST', body: JSON.stringify({ name }) });
    const playlistId = data.playlist.id;
    
    const likedIds = Object.keys(userLikes);
    for (const songId of likedIds.slice(0, 50)) {
      try {
        await api('/playlists/' + playlistId + '/songs', { 
          method: 'POST', 
          body: JSON.stringify({ songId }) 
        });
      } catch {}
    }
    
    toast(`Created "${name}" with ${Math.min(likedIds.length, 50)} songs!`, 'success');
    loadUserPlaylists();
  } catch (err) {
    toast(err.message, 'error');
  }
}

// 16. Auto-playlist: Play all liked songs
async function playLikedSongs() {
  const likedIds = Object.keys(userLikes);
  if (!likedIds.length) {
    toast('No liked songs yet!', 'info');
    return;
  }
  
  try {
    const songs = await Promise.all(
      likedIds.slice(0, 20).map(id => api('/songs/' + id).catch(() => null))
    );
    const playable = songs.filter(s => s && s.hasFilePath);
    
    if (playable.length) {
      queue = playable.slice(1);
      playSong(playable[0]);
      toast(`Playing ${playable.length} liked songs!`, 'success');
    } else {
      toast('No playable songs in liked list', 'error');
    }
  } catch {}
}

// 17. Like statistics
function calculateLikeStats() {
  const likedIds = Object.keys(userLikes);
  const stats = {
    total: likedIds.length,
    released: 0,
    unreleased: 0,
    byEra: {}
  };
  
  // These will be populated when songs are loaded
  return stats;
}

async function renderLikeStats() {
  const section = document.getElementById('likeStatsSection');
  const likedIds = Object.keys(userLikes);
  
  if (!likedIds.length) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'grid';
  
  // Fetch song details for stats
  try {
    const songs = await Promise.all(
      likedIds.slice(0, 50).map(id => api('/songs/' + id).catch(() => null))
    );
    const valid = songs.filter(Boolean);
    
    const released = valid.filter(s => s.category === 'released').length;
    const unreleased = valid.filter(s => s.category === 'unreleased').length;
    
    section.innerHTML = `
      <div class="like-stat-card">
        <div class="like-stat-value">${likedIds.length}</div>
        <div class="like-stat-label">Total Liked</div>
      </div>
      <div class="like-stat-card">
        <div class="like-stat-value" style="color:var(--green);">${released}</div>
        <div class="like-stat-label">Released</div>
      </div>
      <div class="like-stat-card">
        <div class="like-stat-value" style="color:var(--purple-300);">${unreleased}</div>
        <div class="like-stat-label">Unreleased</div>
      </div>
      <div class="like-stat-card">
        <div class="like-stat-value" style="color:var(--cyan);">${valid.filter(s => s.hasFilePath).length}</div>
        <div class="like-stat-label">Streamable</div>
      </div>
    `;
  } catch {
    section.innerHTML = `
      <div class="like-stat-card">
        <div class="like-stat-value">${likedIds.length}</div>
        <div class="like-stat-label">Total Liked</div>
      </div>
    `;
  }
}

// 18. Streak counter
function incrementStreak() {
  const now = new Date();
  const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
  weekStart.setHours(0, 0, 0, 0);
  
  if (!likeStreak.weekStart || new Date(likeStreak.weekStart) < weekStart) {
    likeStreak = { count: 1, weekStart: weekStart.toISOString() };
  } else {
    likeStreak.count++;
  }
  
  localStorage.setItem('jv_like_streak', JSON.stringify(likeStreak));
  renderStreakBanner();
}

function renderStreakBanner() {
  const saved = localStorage.getItem('jv_like_streak');
  if (saved) {
    try { likeStreak = JSON.parse(saved); } catch {}
  }
  
  const banner = document.getElementById('streakBanner');
  if (!banner) return;
  
  if (likeStreak.count >= 3) {
    banner.style.display = 'flex';
    banner.innerHTML = `
      <span class="streak-icon">🔥</span>
      <div class="streak-text">
        <div class="streak-title">On Fire! You've liked ${likeStreak.count} songs this week!</div>
        <div class="streak-subtitle">Keep discovering amazing tracks</div>
      </div>
    `;
  } else {
    banner.style.display = 'none';
  }
}

// 20. Unlike without immediate removal - handled by CSS fade

// 21. Like all songs in a playlist
async function likeAllInPlaylist(playlistId) {
  try {
    const p = await api('/playlists/' + playlistId);
    const songIds = p.songs.map(s => s.id);
    
    toast(`Liking ${songIds.length} songs from playlist...`, 'info');
    
    let count = 0;
    for (const id of songIds) {
      if (!userLikes[id]) {
        try {
          await api('/playlists/like/' + id, { method: 'POST', body: JSON.stringify({ liked: true }) });
          userLikes[id] = true;
          count++;
        } catch {}
      }
    }
    
    updateLibraryBadge();
    toast(`Liked ${count} new songs! ❤️`, 'success');
  } catch {}
}

// 22. Like current radio song
async function likeCurrentRadio() {
  if (!currentSong) {
    toast('No song playing', 'info');
    return;
  }
  toggleLike(currentSong.id);
  updateAllLikeButtons(currentSong.id);
}

// 26. Like sync indicator
function queueLikeForSync(songId, state) {
  offlineLikeQueue.push({ songId, state, timestamp: Date.now() });
  localStorage.setItem('jv_offline_likes', JSON.stringify(offlineLikeQueue));
  showLikeSyncIndicator();
}

function showLikeSyncIndicator() {
  let indicator = document.getElementById('likeSyncIndicator');
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.id = 'likeSyncIndicator';
    indicator.className = 'like-sync-indicator offline';
    document.body.appendChild(indicator);
  }
  indicator.innerHTML = `📴 ${offlineLikeQueue.length} likes queued for sync`;
  indicator.style.display = 'flex';
}

async function syncOfflineLikes() {
  if (!offlineLikeQueue.length) return;
  
  const queue = [...offlineLikeQueue];
  offlineLikeQueue = [];
  localStorage.setItem('jv_offline_likes', '[]');
  
  const indicator = document.getElementById('likeSyncIndicator');
  if (indicator) {
    indicator.classList.remove('offline');
    indicator.classList.add('syncing');
    indicator.innerHTML = '⏳ Syncing likes...';
  }
  
  for (const item of queue) {
    try {
      await api('/playlists/like/' + item.songId, { 
        method: 'POST', 
        body: JSON.stringify({ liked: item.state }) 
      });
    } catch {}
  }
  
  if (indicator) indicator.style.display = 'none';
  toast('Likes synced!', 'success');
}

// 29. Collaborative likes - friend activity
async function loadFriendLikes() {
  try {
    const data = await api('/social/friend-likes');
    friendLikes = data.friendLikes || {};
  } catch {}
}

// 30. Like recommendations
async function loadLikeRecommendations() {
  const section = document.getElementById('likeRecommendations');
  const grid = document.getElementById('recommendationsGrid');
  
  const likedIds = Object.keys(userLikes);
  if (likedIds.length < 3) {
    section.style.display = 'none';
    return;
  }
  
  try {
    const data = await api('/songs/recommendations?basedOnLikes=true&limit=6');
    if (data.songs?.length) {
      section.style.display = 'block';
      grid.innerHTML = '';
      data.songs.forEach((s, i) => {
        const card = createSongCard(s, i);
        const reason = document.createElement('div');
        reason.className = 'like-rec-reason';
        reason.textContent = 'Based on your likes';
        card.querySelector('.song-card-info').appendChild(reason);
        grid.appendChild(card);
      });
    } else {
      section.style.display = 'none';
    }
  } catch {
    section.style.display = 'none';
  }
}

// Network status monitoring
window.addEventListener('online', () => {
  isOnline = true;
  syncOfflineLikes();
});

window.addEventListener('offline', () => {
  isOnline = false;
});

// Load offline queue on startup
const savedOffline = localStorage.getItem('jv_offline_likes');
if (savedOffline) {
  try { offlineLikeQueue = JSON.parse(savedOffline); } catch {}
}

// ─── V2: Playlists ──────────────────────────────────────
async function loadUserPlaylists() {
  try {
    const data = await api('/playlists');
    userPlaylists = data.playlists || [];
  } catch { userPlaylists = []; }
}

function openPlaylistModal(songId) {
  playlistModalSongId = songId;
  const list = document.getElementById('modalPlaylistList');
  list.innerHTML = userPlaylists.filter(p => p.isOwner).map(p =>
    '<div class="modal-playlist-item" onclick="addSongToPlaylist(\'' + p.id + '\')">' +
      '<span class="mpi-icon">🎵</span>' +
      '<span class="mpi-name">' + esc(p.name) + '</span>' +
      '<span class="mpi-count">' + p.songCount + ' songs</span>' +
    '</div>'
  ).join('') || '<p style="text-align:center;color:var(--text-muted);padding:20px;">No playlists yet</p>';
  document.getElementById('playlistModal').classList.add('open');
}

function closePlaylistModal() {
  document.getElementById('playlistModal').classList.remove('open');
  playlistModalSongId = null;
}

async function addSongToPlaylist(playlistId) {
  if (!playlistModalSongId) return;
  try {
    await api('/playlists/' + playlistId + '/songs', { method: 'POST', body: JSON.stringify({ songId: playlistModalSongId }) });
    toast('Added to playlist!', 'success');
    closePlaylistModal();
    await loadUserPlaylists();
  } catch (err) {
    toast(err.message === 'Song already in playlist' ? 'Already in that playlist' : err.message, 'error');
  }
}

async function createPlaylistFromModal() {
  const name = prompt('Playlist name:');
  if (!name) return;
  try {
    const data = await api('/playlists', { method: 'POST', body: JSON.stringify({ name }) });
    toast('Playlist "' + name + '" created!', 'success');
    await loadUserPlaylists();
    if (playlistModalSongId) {
      await addSongToPlaylist(data.playlist.id);
    } else {
      closePlaylistModal();
    }
  } catch (err) { toast(err.message, 'error'); }
}

async function loadLibrary() {
  await Promise.all([loadUserLikes(), loadUserPlaylists()]);
  
  // Render statistics, streak, and recently liked
  renderLikeStats();
  renderStreakBanner();
  renderRecentlyLiked();
  loadLikeRecommendations();

  // Liked songs
  let likedIds = Object.entries(userLikes).filter(([,v]) => v === true).map(([k]) => k);
  const likedGrid = document.getElementById('likedSongsGrid');
  
  if (likedIds.length) {
    likedGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
      // Fetch all liked songs
      let songs = await Promise.all(
        likedIds.map(id => api('/songs/' + id).catch(() => null))
      );
      songs = songs.filter(Boolean);
      
      // Apply category filter
      if (likedSongsFilter) {
        songs = songs.filter(s => s.category === likedSongsFilter);
      }
      
      // Apply sorting
      songs.sort((a, b) => {
        switch (likedSongsSort) {
          case 'name':
            return (a.name || '').localeCompare(b.name || '');
          case 'playCount':
            return (b.playCount || 0) - (a.playCount || 0);
          case 'recently-liked':
          default:
            // Sort by recently liked (from userLikes order)
            const idxA = likedIds.indexOf(a.id);
            const idxB = likedIds.indexOf(b.id);
            return idxA - idxB;
        }
      });
      
      likedGrid.innerHTML = '';
      likedGrid.className = 'song-grid';
      
      if (bulkSelectMode) {
        likedGrid.classList.add('bulk-select-mode');
      }
      
      songs.forEach((s, i) => {
        const card = createSongCard(s, i);
        card.dataset.songId = s.id;
        if (bulkSelectMode) {
          card.classList.add('bulk-select');
          const checkbox = document.createElement('div');
          checkbox.className = 'bulk-checkbox';
          if (selectedSongs.has(s.id)) {
            checkbox.classList.add('checked');
            checkbox.textContent = '✓';
          }
          checkbox.onclick = (e) => { e.stopPropagation(); toggleSongSelection(s.id, checkbox); };
          card.appendChild(checkbox);
        }
        likedGrid.appendChild(card);
      });
      
      // Re-show bulk bar if in select mode
      if (bulkSelectMode) {
        const bulkBar = document.getElementById('bulkActionsBar');
        if (bulkBar) bulkBar.style.display = 'flex';
      }
    } catch { 
      likedGrid.innerHTML = '<div class="empty-state"><p>Could not load liked songs</p></div>'; 
    }
  } else {
    likedGrid.innerHTML = '<div class="empty-state" style="padding:20px"><p style="color:var(--text-muted)">No liked songs yet. Hit the ❤️ on any song!</p></div>';
  }

  // Playlists
  const grid = document.getElementById('playlistGrid');
  grid.innerHTML = '';
  const createCard = document.createElement('div');
  createCard.className = 'create-playlist-card';
  createCard.onclick = () => { createPlaylistFromModal(); };
  createCard.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span>New Playlist</span>';
  grid.appendChild(createCard);

  userPlaylists.forEach(p => {
    const card = document.createElement('div');
    card.className = 'playlist-card';
    card.onclick = () => { navigateTo('playlist'); loadPlaylistDetail(p.id); };
    const imgs = (p.previewImages || []).slice(0, 4);
    let artHtml = '';
    if (imgs.length >= 4) {
      artHtml = imgs.map(u => '<img src="' + esc(u) + '" loading="lazy">').join('');
    } else {
      artHtml = '<div class="pca-empty">🎵</div>';
    }
    card.innerHTML = '<div class="playlist-card-art">' + artHtml + '</div><div class="playlist-card-info"><div class="playlist-card-name">' + esc(p.name) + '</div><div class="playlist-card-meta">' + p.songCount + ' songs</div></div>';
    grid.appendChild(card);
  });
}

async function loadPlaylistDetail(id) {
  const container = document.getElementById('playlistDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  
  try {
    const p = await api('/playlists/' + id);
    const isOwner = p.createdBy?.id === user?.id;
    const totalDuration = p.songs?.reduce((acc, s) => acc + (s.duration || 0), 0) || 0;
    const durationText = totalDuration > 0 ? formatDuration(totalDuration) : '';
    
    // Build hero section with playlist info
    let heroHtml = `
      <button class="playlist-back-btn" onclick="navigateTo('library')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg> Back to Library
      </button>
      
      <div class="playlist-hero">
        <div class="playlist-hero-art">
          ${p.songs?.length > 0 ? `
            <div class="playlist-art-grid">
              ${p.songs.slice(0, 4).map((s, i) => `
                <div class="playlist-art-item" style="animation-delay: ${i * 0.1}s">
                  ${artTag(s, '🎵')}
                </div>
              `).join('')}
            </div>
          ` : `
            <div class="playlist-art-placeholder">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 18V5l12-2v13"/>
                <circle cx="6" cy="18" r="3"/>
                <circle cx="18" cy="16" r="3"/>
              </svg>
            </div>
          `}
        </div>
        
        <div class="playlist-hero-info">
          <div class="playlist-type">Playlist</div>
          <h1 class="playlist-name">${esc(p.name)}</h1>
          <div class="playlist-meta">
            <span class="playlist-creator">By ${esc(p.createdBy?.displayName || 'Unknown')}</span>
            <span class="playlist-dot">•</span>
            <span class="playlist-count">${p.songs?.length || 0} songs</span>
            ${durationText ? `<span class="playlist-dot">•</span><span class="playlist-duration">${durationText}</span>` : ''}
          </div>
          
          <div class="playlist-hero-actions">
            <button class="playlist-play-btn" onclick="playPlaylist('${id}')">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              Play
            </button>
            <button class="playlist-shuffle-btn" onclick="shufflePlaylist('${id}')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="16 3 21 3 21 8"/>
                <line x1="4" y1="20" x2="21" y2="3"/>
                <polyline points="21 16 21 21 16 21"/>
                <line x1="15" y1="15" x2="21" y2="21"/>
                <line x1="4" y1="4" x2="9" y2="9"/>
              </svg>
              Shuffle
            </button>
            <button class="playlist-like-btn ${p.isLiked ? 'liked' : ''}" onclick="togglePlaylistLike('${id}', this)">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="${p.isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
            </button>
            <button class="playlist-more-btn" onclick="togglePlaylistMenu('${id}', ${isOwner})">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
              </svg>
            </button>
          </div>
          
          ${p.collaborators?.length > 0 ? `
            <div class="playlist-collaborators">
              <span class="collab-label">Collaborators:</span>
              <div class="collab-avatars">
                ${p.collaborators.map(c => `
                  <div class="collab-avatar" title="${esc(c.displayName)}">${c.displayName.charAt(0).toUpperCase()}</div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      </div>
      
      <div class="playlist-toolbar">
        <div class="playlist-search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
          <input type="text" id="playlistSearchInput" placeholder="Search in playlist..." oninput="filterPlaylistSongs(this.value)">
        </div>
        <div class="playlist-sort">
          <select id="playlistSort" onchange="sortPlaylistSongs(this.value)">
            <option value="custom">Custom Order</option>
            <option value="name">Name A-Z</option>
            <option value="artist">Artist</option>
            <option value="added">Recently Added</option>
          </select>
        </div>
      </div>
      
      <div class="playlist-songs-container">
        ${p.songs?.length > 0 ? `
          <div class="playlist-songs-header">
            <span class="pl-col-num">#</span>
            <span class="pl-col-title">Title</span>
            <span class="pl-col-album">Album</span>
            <span class="pl-col-date">Date Added</span>
            <span class="pl-col-duration">⏱</span>
            <span class="pl-col-actions"></span>
          </div>
          <div class="playlist-songs-list" id="playlistSongsList" data-playlist-id="${id}">
            ${p.songs.map((s, i) => createPlaylistSongRow(s, i, isOwner)).join('')}
          </div>
        ` : `
          <div class="playlist-empty">
            <div class="playlist-empty-icon">🎵</div>
            <h3>Start building your playlist</h3>
            <p>Add songs from the catalog to get started</p>
            <button class="hero-btn hero-btn-primary" onclick="navigateTo('catalog')">Browse Songs</button>
          </div>
        `}
      </div>
      
      ${p.songs?.length > 0 ? `
        <div class="playlist-comments-section">
          <div class="section-header-v2">
            <h3>Comments</h3>
            <span class="comment-count" id="playlistCommentCount">0</span>
          </div>
          <div class="comment-input-wrap">
            <div class="comment-avatar">${user?.displayName?.charAt(0).toUpperCase() || 'U'}</div>
            <div class="comment-input-area">
              <textarea id="playlistCommentInput" placeholder="Add a comment..." rows="2"></textarea>
              <button class="comment-submit-btn" onclick="addPlaylistComment('${id}')">Post</button>
            </div>
          </div>
          <div class="playlist-comments-list" id="playlistCommentsList"></div>
        </div>
      ` : ''}
    `;
    
    container.innerHTML = heroHtml;
    
    // Load comments
    if (p.songs?.length > 0) {
      loadPlaylistComments(id);
    }
    
    // Initialize drag and drop for reordering
    if (isOwner && p.songs?.length > 1) {
      initPlaylistDragAndDrop();
    }
    
  } catch (err) {
    container.innerHTML = `
      <div class="playlist-error">
        <div class="error-icon">⚠️</div>
        <h3>Failed to load playlist</h3>
        <p>${esc(err.message)}</p>
        <button class="hero-btn" onclick="navigateTo('library')">Back to Library</button>
      </div>
    `;
  }
}

// Helper function to create playlist song row HTML
function createPlaylistSongRow(song, index, isOwner) {
  const isLiked = userLikes[song.id] === true;
  return `
    <div class="playlist-song-row" data-song-id="${song.id}" data-index="${index}" draggable="${isOwner}">
      <span class="pl-song-num">${index + 1}</span>
      <div class="pl-song-drag-handle" style="display: ${isOwner ? 'flex' : 'none'}">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/>
          <circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/>
        </svg>
      </div>
      <div class="pl-song-art">
        ${artTag(song, '🎵')}
        <button class="pl-song-play" onclick="playSongById('${song.id}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
        </button>
      </div>
      <div class="pl-song-info">
        <div class="pl-song-name">${esc(song.name)}</div>
        <div class="pl-song-artist">${esc(song.creditedArtists || 'Juice WRLD')}</div>
      </div>
      <div class="pl-song-album">${esc(song.era?.name || '—')}</div>
      <div class="pl-song-date">${formatDate(song.addedAt) || 'Recently'}</div>
      <div class="pl-song-duration">${song.length || '—'}</div>
      <div class="pl-song-actions">
        <button class="pl-action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${song.id}', this); updateAllLikeButtons('${song.id}')" title="Like">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </button>
        ${isOwner ? `
          <button class="pl-action-btn" onclick="removeFromPlaylist('${song.id}')" title="Remove">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        ` : ''}
      </div>
    </div>
  `;
}

async function playPlaylist(id) {
  try {
    const p = await api('/playlists/' + id);
    const playable = p.songs.filter(s => s.hasFilePath);
    if (!playable.length) { toast('No playable songs in this playlist', 'error'); return; }
    queue = playable.slice(1);
    playSong(playable[0]);
    toast('Playing ' + p.name, 'success');
  } catch (err) { toast(err.message, 'error'); }
}

// ─── V2: Load Eras for Filter ───────────────────────────
async function loadEras() {
  try {
    const data = await api('/songs/eras');
    const select = document.getElementById('eraFilter');
    if (select && data.eras && data.eras.length) {
      // Clear existing options except "All Eras"
      while (select.options.length > 1) select.remove(1);
      data.eras.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.name;
        opt.textContent = e.name + (e.songCount ? ' (' + e.songCount + ')' : '');
        select.appendChild(opt);
      });
    }
  } catch (err) {
    console.warn('Failed to load eras:', err);
  }
}

// ─── V2: Volume Improvements ────────────────────────────
function setVolume(e) {
  const bar = document.getElementById('volumeBar');
  const rect = bar.getBoundingClientRect();
  volume = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  audio.volume = volume;
  updateVolumeUI();
  localStorage.setItem('jv_volume', volume);
}

function updateVolumeUI() {
  document.getElementById('volumeFill').style.width = (audio.volume * 100) + '%';
  const pct = Math.round(audio.volume * 100);
  const tip = document.getElementById('volumeTooltip');
  if (tip) tip.textContent = pct + '%';

  // Update icon
  const icon = document.getElementById('volumeIcon');
  if (icon) {
    if (audio.volume === 0) {
      icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>';
    } else if (audio.volume < 0.5) {
      icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 010 7.07"/>';
    } else {
      icon.innerHTML = '<polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 010 14.14"/><path d="M15.54 8.46a5 5 0 010 7.07"/>';
    }
  }
}

// Volume scroll wheel
document.getElementById('volumeBar')?.addEventListener('wheel', (e) => {
  e.preventDefault();
  const delta = e.deltaY > 0 ? -0.05 : 0.05;
  audio.volume = Math.max(0, Math.min(1, audio.volume + delta));
  volume = audio.volume;
  updateVolumeUI();
  localStorage.setItem('jv_volume', volume);
}, { passive: false });

// Restore volume from storage
const savedVol = localStorage.getItem('jv_volume');
if (savedVol !== null) { volume = parseFloat(savedVol); audio.volume = volume; updateVolumeUI(); }

// ─── V2: Queue Badge ────────────────────────────────────
function updateQueueBadge() {
  const badge = document.getElementById('queueBadge');
  if (badge) {
    if (queue.length > 0) {
      badge.textContent = queue.length;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }
}

// ─── V2: EQ System ──────────────────────────────────────
function initEQ() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (eqFilters.length) return;

  EQ_BANDS.forEach(band => {
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'peaking';
    filter.frequency.value = band.freq;
    filter.Q.value = 1.4;
    filter.gain.value = 0;
    eqFilters.push(filter);
  });

  // Chain filters
  for (let i = 0; i < eqFilters.length - 1; i++) {
    eqFilters[i].connect(eqFilters[i + 1]);
  }
  eqFilters[eqFilters.length - 1].connect(audioCtx.destination);
}

function connectEQ() {
  if (eqConnected) return;
  initEQ();
  if (!eqSourceNode) {
    eqSourceNode = audioCtx.createMediaElementSource(audio);
  }
  eqSourceNode.disconnect();
  eqSourceNode.connect(eqFilters[0]);
  eqConnected = true;
}

function applyEQPreset(name) {
  const preset = EQ_PRESETS[name];
  if (!preset) return;
  currentEQPreset = name;
  connectEQ();

  preset.gains.forEach((g, i) => {
    if (eqFilters[i]) eqFilters[i].gain.value = g;
    customEQGains[i] = g;
    const slider = document.getElementById('eq-slider-' + i);
    if (slider) slider.value = g;
    const val = document.getElementById('eq-val-' + i);
    if (val) val.textContent = (g >= 0 ? '+' : '') + g + 'dB';
  });

  document.querySelectorAll('.eq-preset-btn').forEach(b => b.classList.toggle('active', b.dataset.preset === name));
  drawEQCurve();
  localStorage.setItem('jv_eq_preset', name);
  localStorage.setItem('jv_eq_gains', JSON.stringify(customEQGains));
}

function setEQBand(idx, val) {
  connectEQ();
  val = parseFloat(val);
  if (eqFilters[idx]) eqFilters[idx].gain.value = val;
  customEQGains[idx] = val;
  const valEl = document.getElementById('eq-val-' + idx);
  if (valEl) valEl.textContent = (val >= 0 ? '+' : '') + val + 'dB';
  currentEQPreset = 'custom';
  document.querySelectorAll('.eq-preset-btn').forEach(b => b.classList.remove('active'));
  drawEQCurve();
  localStorage.setItem('jv_eq_gains', JSON.stringify(customEQGains));
}

function resetEQ() { applyEQPreset('flat'); }

function saveCustomEQPreset() {
  const name = prompt('Preset name:');
  if (!name) return;
  const saved = JSON.parse(localStorage.getItem('jv_eq_custom') || '{}');
  saved[name] = [...customEQGains];
  localStorage.setItem('jv_eq_custom', JSON.stringify(saved));
  renderEQPage();
  toast('Preset "' + name + '" saved!', 'success');
}

function drawEQCurve() {
  const canvas = document.getElementById('eqCurve');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  // Background grid
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  for (let y = 0; y < h; y += h/4) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
  }

  // Center line
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke();

  // Curve
  const grad = ctx.createLinearGradient(0, 0, w, 0);
  grad.addColorStop(0, '#9b5de5');
  grad.addColorStop(1, '#f15bb5');
  ctx.strokeStyle = grad;
  ctx.lineWidth = 2;
  ctx.beginPath();

  customEQGains.forEach((g, i) => {
    const x = (i / (customEQGains.length - 1)) * w;
    const y = h/2 - (g / 12) * (h/2);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill under curve
  const lastX = w;
  const lastY = h/2 - (customEQGains[customEQGains.length-1] / 12) * (h/2);
  ctx.lineTo(lastX, h);
  ctx.lineTo(0, h);
  ctx.closePath();
  const fillGrad = ctx.createLinearGradient(0, 0, 0, h);
  fillGrad.addColorStop(0, 'rgba(155,93,229,0.15)');
  fillGrad.addColorStop(1, 'rgba(155,93,229,0)');
  ctx.fillStyle = fillGrad;
  ctx.fill();
}

function renderEQPage() {
  // Presets
  const presetsEl = document.getElementById('eqPresets');
  if (!presetsEl) return;

  let presetsHtml = '';
  Object.entries(EQ_PRESETS).forEach(([key, p]) => {
    presetsHtml += '<button class="eq-preset-btn' + (currentEQPreset === key ? ' active' : '') + '" data-preset="' + key + '" onclick="applyEQPreset(\'' + key + '\')">' + p.name + '</button>';
  });

  // Custom presets
  const custom = JSON.parse(localStorage.getItem('jv_eq_custom') || '{}');
  Object.keys(custom).forEach(name => {
    presetsHtml += '<button class="eq-preset-btn" onclick="customEQGains=[' + custom[name].join(',') + '];applyEQPreset(\'flat\');customEQGains.forEach((g,i)=>{eqFilters[i].gain.value=g;const s=document.getElementById(\'eq-slider-\'+i);if(s)s.value=g;const v=document.getElementById(\'eq-val-\'+i);if(v)v.textContent=(g>=0?\'+\':\'\')+g+\'dB\'});drawEQCurve()">🎧 ' + esc(name) + '</button>';
  });
  presetsEl.innerHTML = presetsHtml;

  // Sliders
  const slidersEl = document.getElementById('eqSliders');
  if (!slidersEl) return;
  slidersEl.innerHTML = EQ_BANDS.map((band, i) =>
    '<div class="eq-band">' +
      '<span class="eq-band-val" id="eq-val-' + i + '">' + (customEQGains[i] >= 0 ? '+' : '') + customEQGains[i] + 'dB</span>' +
      '<input type="range" id="eq-slider-' + i + '" min="-12" max="12" step="1" value="' + customEQGains[i] + '" oninput="setEQBand(' + i + ',this.value)">' +
      '<span class="eq-band-label">' + band.label + '</span>' +
    '</div>'
  ).join('');

  drawEQCurve();
}

// Restore EQ from storage
function restoreEQ() {
  const savedGains = localStorage.getItem('jv_eq_gains');
  if (savedGains) {
    try { customEQGains = JSON.parse(savedGains); } catch {}
  }
  const savedPreset = localStorage.getItem('jv_eq_preset');
  if (savedPreset && EQ_PRESETS[savedPreset]) {
    currentEQPreset = savedPreset;
  }
}
restoreEQ();

// ═══════════════════════════════════════════════════════
// ═══ V3: PLAYLIST QOL ENHANCEMENTS (30 Features) ═══════
// ═══════════════════════════════════════════════════════

// State for playlist enhancements
let currentPlaylistId = null;
let currentPlaylistData = null;
selectedSongs = new Set();
let dragSrcEl = null;
let draggedSongId = null;
let editingPlaylistId = null;
let smartRules = [];
let tempCoverImage = null;
let currentPlaylistSort = 'custom';
let lastPlaylistPosition = {}; // playlistId -> last played song index
let playlistHistory = {}; // playlistId -> { playCount, lastPlayed, completedSongs }

// 1. DRAG AND DROP REORDER
function initDragAndDrop(el, songId) {
  el.draggable = true;
  el.addEventListener('dragstart', handleDragStart);
  el.addEventListener('dragover', handleDragOver);
  el.addEventListener('drop', handleDrop);
  el.addEventListener('dragend', handleDragEnd);
  el.addEventListener('dragenter', handleDragEnter);
  el.addEventListener('dragleave', handleDragLeave);
}

function handleDragStart(e) {
  dragSrcEl = this;
  draggedSongId = this.dataset.songId;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', draggedSongId);
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleDragEnter(e) {
  if (this !== dragSrcEl) {
    this.classList.add('drag-over');
  }
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}

function handleDrop(e) {
  e.stopPropagation();
  e.preventDefault();
  
  if (dragSrcEl !== this) {
    const targetSongId = this.dataset.songId;
    const container = document.getElementById('playlistSongs');
    const songs = Array.from(container.children);
    const fromIndex = songs.indexOf(dragSrcEl);
    const toIndex = songs.indexOf(this);
    
    if (fromIndex < toIndex) {
      this.after(dragSrcEl);
    } else {
      this.before(dragSrcEl);
    }
    
    // Update order in backend
    reorderPlaylistSong(draggedSongId, toIndex + 1);
  }
  
  return false;
}

function handleDragEnd(e) {
  this.classList.remove('dragging');
  document.querySelectorAll('.song-card, .playlist-song-row').forEach(el => {
    el.classList.remove('drag-over');
  });
}

async function reorderPlaylistSong(songId, newPosition) {
  if (!currentPlaylistId) return;
  try {
    await api('/playlists/' + currentPlaylistId + '/reorder', {
      method: 'POST',
      body: JSON.stringify({ songId, newPosition })
    });
    toast('Song reordered', 'success');
  } catch (err) {
    toast('Failed to reorder: ' + err.message, 'error');
  }
}

// 2. PLAYLIST FOLDERS/CATEGORIES
let playlistFolders = JSON.parse(localStorage.getItem('jv_playlist_folders') || '[]');

function createPlaylistFolder(name) {
  const folder = { id: Date.now().toString(), name, playlistIds: [] };
  playlistFolders.push(folder);
  savePlaylistFolders();
  return folder;
}

function savePlaylistFolders() {
  localStorage.setItem('jv_playlist_folders', JSON.stringify(playlistFolders));
}

function addPlaylistToFolder(playlistId, folderId) {
  const folder = playlistFolders.find(f => f.id === folderId);
  if (folder && !folder.playlistIds.includes(playlistId)) {
    folder.playlistIds.push(playlistId);
    savePlaylistFolders();
  }
}

function removePlaylistFromFolder(playlistId, folderId) {
  const folder = playlistFolders.find(f => f.id === folderId);
  if (folder) {
    folder.playlistIds = folder.playlistIds.filter(id => id !== playlistId);
    savePlaylistFolders();
  }
}

// 3. RICH TEXT DESCRIPTION (handled in edit modal)
function formatDesc(command) {
  document.execCommand(command, false, null);
  document.getElementById('playlistDescInput').focus();
}

// 4. CUSTOM COVER IMAGE
function handleCoverUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    tempCoverImage = e.target.result;
    const area = document.getElementById('coverUploadArea');
    area.innerHTML = `<img src="${tempCoverImage}"><div class="cover-upload-overlay"><span style="font-size: 1.5rem;">📷</span><span style="font-size: 0.75rem;">Change</span></div>`;
    area.classList.add('has-image');
  };
  reader.readAsDataURL(file);
}

// 5. SMART PLAYLISTS
function toggleSmartRules() {
  const section = document.getElementById('smartRulesSection');
  section.style.display = document.getElementById('playlistSmartToggle').checked ? 'block' : 'none';
  if (smartRules.length === 0) addSmartRule();
}

function addSmartRule() {
  const container = document.getElementById('smartRulesContainer');
  const ruleId = Date.now();
  const ruleEl = document.createElement('div');
  ruleEl.className = 'smart-rule-row';
  ruleEl.dataset.ruleId = ruleId;
  ruleEl.innerHTML = `
    <select class="smart-rule-field">
      <option value="category">Category</option>
      <option value="era">Era</option>
      <option value="liked">Liked Status</option>
      <option value="playCount">Play Count</option>
      <option value="hasLyrics">Has Lyrics</option>
    </select>
    <select class="smart-rule-operator">
      <option value="is">is</option>
      <option value="isNot">is not</option>
      <option value="contains">contains</option>
      <option value="greaterThan">greater than</option>
      <option value="lessThan">less than</option>
    </select>
    <input type="text" class="smart-rule-value" placeholder="Value" style="padding: 8px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.85rem; color: var(--text);">
    <button class="smart-rule-remove" onclick="this.parentElement.remove()">✕</button>
  `;
  container.appendChild(ruleEl);
}

function getSmartRules() {
  const rules = [];
  document.querySelectorAll('.smart-rule-row').forEach(row => {
    rules.push({
      field: row.querySelector('.smart-rule-field').value,
      operator: row.querySelector('.smart-rule-operator').value,
      value: row.querySelector('.smart-rule-value').value
    });
  });
  return rules;
}

function applySmartRules(rules, songs) {
  return songs.filter(song => {
    return rules.some(rule => {
      let value = song[rule.field];
      if (rule.field === 'liked') value = userLikes[song.id] ? 'liked' : 'not liked';
      if (rule.field === 'hasLyrics') value = (song.hasLyrics || song.hasRawLyrics) ? 'yes' : 'no';
      
      switch(rule.operator) {
        case 'is': return String(value).toLowerCase() === rule.value.toLowerCase();
        case 'isNot': return String(value).toLowerCase() !== rule.value.toLowerCase();
        case 'contains': return String(value).toLowerCase().includes(rule.value.toLowerCase());
        case 'greaterThan': return parseFloat(value) > parseFloat(rule.value);
        case 'lessThan': return parseFloat(value) < parseFloat(rule.value);
        default: return false;
      }
    });
  });
}

// 6. DUPLICATE PLAYLIST
async function duplicatePlaylist(playlistId) {
  try {
    const original = await api('/playlists/' + playlistId);
    const newName = original.name + ' (Copy)';
    const data = await api('/playlists', {
      method: 'POST',
      body: JSON.stringify({ name: newName, description: original.description })
    });
    
    // Copy songs
    for (const song of original.songs) {
      await api('/playlists/' + data.playlist.id + '/songs', {
        method: 'POST',
        body: JSON.stringify({ songId: song.id })
      }).catch(() => {});
    }
    
    toast('Playlist duplicated!', 'success');
    await loadUserPlaylists();
    if (currentPage === 'library') loadLibrary();
  } catch (err) {
    toast('Failed to duplicate: ' + err.message, 'error');
  }
}

// 7. MERGE PLAYLISTS
function openMergeModal() {
  if (!currentPlaylistId) return;
  const list = document.getElementById('mergePlaylistList');
  list.innerHTML = userPlaylists
    .filter(p => p.id !== currentPlaylistId && p.isOwner)
    .map(p => `
      <div class="modal-playlist-item" onclick="mergePlaylists('${p.id}')">
        <span class="mpi-icon">🎵</span>
        <span class="mpi-name">${esc(p.name)}</span>
        <span class="mpi-count">${p.songCount} songs</span>
      </div>
    `).join('') || '<p style="text-align:center;color:var(--text-muted);padding:20px;">No other playlists</p>';
  document.getElementById('mergePlaylistModal').classList.add('open');
}

function closeMergeModal() {
  document.getElementById('mergePlaylistModal').classList.remove('open');
}

async function mergePlaylists(sourceId) {
  try {
    const removeDups = document.getElementById('mergeRemoveDuplicates').checked;
    const source = await api('/playlists/' + sourceId);
    const existingIds = new Set(currentPlaylistData.songs.map(s => s.id));
    
    let added = 0;
    for (const song of source.songs) {
      if (removeDups && existingIds.has(song.id)) continue;
      await api('/playlists/' + currentPlaylistId + '/songs', {
        method: 'POST',
        body: JSON.stringify({ songId: song.id })
      }).catch(() => {});
      added++;
    }
    
    toast(`Merged ${added} songs!`, 'success');
    closeMergeModal();
    loadPlaylistDetail(currentPlaylistId);
  } catch (err) {
    toast('Merge failed: ' + err.message, 'error');
  }
}

// 8. PLAYLIST STATS
function calculatePlaylistStats(songs) {
  const stats = {
    totalDuration: 0,
    byCategory: {},
    avgPlayCount: 0,
    totalPlays: 0,
    moods: [],
    genres: []
  };
  
  if (!songs.length) return stats;
  
  songs.forEach(s => {
    // Parse duration (e.g., "3:45" to seconds)
    if (s.length) {
      const parts = s.length.split(':');
      if (parts.length === 2) {
        stats.totalDuration += parseInt(parts[0]) * 60 + parseInt(parts[1]);
      }
    }
    
    // By category
    const cat = s.category || 'Unknown';
    stats.byCategory[cat] = (stats.byCategory[cat] || 0) + 1;
    
    // Play count
    stats.totalPlays += s.playCount || 0;
  });
  
  stats.avgPlayCount = Math.round(stats.totalPlays / songs.length);
  stats.moods = detectPlaylistMoods(songs);
  
  return stats;
}

function detectPlaylistMoods(songs) {
  const moodKeywords = {
    sad: ['sad', 'hurt', 'pain', 'cry', 'broken', 'alone', 'depressed'],
    hype: ['hype', 'fire', 'lit', 'banger', 'energy', 'up'],
    chill: ['chill', 'relax', 'calm', 'vibe', 'smooth', 'mellow'],
    love: ['love', 'heart', 'girl', 'baby', 'romance', 'crush'],
    dark: ['dark', 'demons', 'wicked', 'evil', 'hell', 'devil']
  };
  
  const moodScores = {};
  songs.forEach(s => {
    const text = (s.name + ' ' + (s.rawLyrics || '')).toLowerCase();
    Object.entries(moodKeywords).forEach(([mood, keywords]) => {
      keywords.forEach(kw => {
        if (text.includes(kw)) {
          moodScores[mood] = (moodScores[mood] || 0) + 1;
        }
      });
    });
  });
  
  return Object.entries(moodScores)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3)
    .map(([mood]) => mood);
}

function formatDuration(seconds) {
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  if (hrs > 0) return `${hrs}h ${mins}m`;
  return `${mins}m`;
}

// 9. COLLABORATIVE PLAYLISTS
async function addCollaborator(playlistId, userEmail) {
  try {
    await api('/playlists/' + playlistId + '/collaborators', {
      method: 'POST',
      body: JSON.stringify({ email: userEmail })
    });
    toast('Collaborator added!', 'success');
  } catch (err) {
    toast('Failed to add collaborator: ' + err.message, 'error');
  }
}

// 10. PLAYLIST COMMENTS
async function addPlaylistComment(playlistId, text) {
  if (!text.trim()) return;
  try {
    await api('/playlists/' + playlistId + '/comments', {
      method: 'POST',
      body: JSON.stringify({ text })
    });
    document.getElementById('playlistCommentInput').value = '';
    loadPlaylistComments(playlistId);
    logActivity(playlistId, 'commented', text);
  } catch (err) {
    toast('Failed to add comment', 'error');
  }
}

async function loadPlaylistComments(playlistId) {
  try {
    const data = await api('/playlists/' + playlistId + '/comments');
    const container = document.getElementById('playlistComments');
    if (!container) return;
    
    container.innerHTML = data.comments.map(c => `
      <div class="comment-item">
        <div class="comment-header">
          <div class="comment-avatar">${c.user.name.charAt(0).toUpperCase()}</div>
          <span class="comment-author">${esc(c.user.name)}</span>
          <span class="comment-time">${new Date(c.createdAt).toLocaleDateString()}</span>
        </div>
        <div class="comment-text">${esc(c.text)}</div>
      </div>
    `).join('');
  } catch (err) {
    console.error('Failed to load comments:', err);
  }
}

// 11. SHARE PLAYLIST
function openShareModal(playlistId) {
  const shareUrl = window.location.origin + '/playlist/' + playlistId;
  document.getElementById('shareLinkInput').value = shareUrl;
  currentPlaylistId = playlistId;
  document.getElementById('sharePlaylistModal').classList.add('open');
}

function closeShareModal() {
  document.getElementById('sharePlaylistModal').classList.remove('open');
}

function copyShareLink() {
  const input = document.getElementById('shareLinkInput');
  input.select();
  document.execCommand('copy');
  toast('Link copied to clipboard!', 'success');
}

// 12. EXPORT PLAYLIST
function exportPlaylist(format) {
  if (!currentPlaylistData) return;
  
  let content, filename, mimeType;
  
  switch(format) {
    case 'json':
      content = JSON.stringify({
        name: currentPlaylistData.name,
        description: currentPlaylistData.description,
        created: new Date().toISOString(),
        songs: currentPlaylistData.songs.map(s => ({
          id: s.id,
          name: s.name,
          artist: s.creditedArtists || 'Juice WRLD',
          category: s.category,
          length: s.length
        }))
      }, null, 2);
      filename = currentPlaylistData.name + '.json';
      mimeType = 'application/json';
      break;
      
    case 'csv':
      content = 'Name,Artist,Category,Length\n';
      content += currentPlaylistData.songs.map(s => 
        `"${s.name}","${s.creditedArtists || 'Juice WRLD'}","${s.category || ''}","${s.length || ''}"`
      ).join('\n');
      filename = currentPlaylistData.name + '.csv';
      mimeType = 'text/csv';
      break;
      
    case 'spotify':
      content = currentPlaylistData.songs.map(s => 
        `spotify:search:${encodeURIComponent(s.name + ' ' + (s.creditedArtists || 'Juice WRLD'))}`
      ).join('\n');
      filename = currentPlaylistData.name + '_spotify_uris.txt';
      mimeType = 'text/plain';
      break;
  }
  
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('Playlist exported!', 'success');
}

// 13. IMPORT PLAYLIST
function openImportModal() {
  document.getElementById('importPlaylistModal').classList.add('open');
}

function closeImportModal() {
  document.getElementById('importPlaylistModal').classList.remove('open');
}

function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      let songs = [];
      
      if (file.name.endsWith('.json')) {
        const data = JSON.parse(e.target.result);
        songs = data.songs || [];
      } else if (file.name.endsWith('.csv')) {
        const lines = e.target.result.split('\n');
        // Skip header, parse CSV
        for (let i = 1; i < lines.length; i++) {
          const parts = lines[i].split(',');
          if (parts[0]) songs.push({ name: parts[0].replace(/"/g, ''), artist: parts[1]?.replace(/"/g, '') });
        }
      }
      
      await createPlaylistFromImport(file.name.replace(/\.[^.]+$/, ''), songs);
    } catch (err) {
      toast('Import failed: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
}

async function importFromUrl() {
  const url = document.getElementById('importUrlInput').value;
  if (!url.includes('spotify.com/playlist/')) {
    toast('Only Spotify playlists are supported currently', 'error');
    return;
  }
  
  toast('Importing from Spotify...', 'info');
  try {
    // Extract playlist ID
    const match = url.match(/playlist\/([a-zA-Z0-9]+)/);
    if (!match) throw new Error('Invalid URL');
    
    const data = await api('/playlists/import/spotify?playlistId=' + match[1]);
    toast(`Imported "${data.name}" with ${data.songs?.length || 0} songs!`, 'success');
    await loadUserPlaylists();
    closeImportModal();
  } catch (err) {
    toast('Import failed: ' + err.message, 'error');
  }
}

async function createPlaylistFromImport(name, songs) {
  try {
    const data = await api('/playlists', {
      method: 'POST',
      body: JSON.stringify({ name })
    });
    
    let added = 0;
    for (const song of songs) {
      // Try to find matching song
      try {
        const searchResults = await api('/search?q=' + encodeURIComponent(song.name) + '&mode=local&pageSize=5');
        if (searchResults.results?.length) {
          await api('/playlists/' + data.playlist.id + '/songs', {
            method: 'POST',
            body: JSON.stringify({ songId: searchResults.results[0].id })
          });
          added++;
        }
      } catch {}
    }
    
    toast(`Created "${name}" with ${added} songs!`, 'success');
    await loadUserPlaylists();
    closeImportModal();
  } catch (err) {
    toast('Import failed: ' + err.message, 'error');
  }
}

// 14. PLAYLIST SEARCH
function searchPlaylistSongs(query) {
  if (!currentPlaylistData) return;
  query = query.toLowerCase();
  
  const container = document.getElementById('playlistSongs');
  const songs = currentPlaylistData.songs;
  
  container.innerHTML = '';
  songs.filter(s => 
    s.name.toLowerCase().includes(query) ||
    (s.creditedArtists || '').toLowerCase().includes(query) ||
    (s.category || '').toLowerCase().includes(query)
  ).forEach((s, i) => {
    container.appendChild(createPlaylistSongRowV2(s, i, currentPlaylistData));
  });
}

// 15. SORT PLAYLIST
function sortPlaylistSongs(sortBy) {
  if (!currentPlaylistData) return;
  currentPlaylistSort = sortBy;
  
  const songs = [...currentPlaylistData.songs];
  
  switch(sortBy) {
    case 'name':
      songs.sort((a, b) => a.name.localeCompare(b.name));
      break;
    case 'artist':
      songs.sort((a, b) => (a.creditedArtists || 'Unknown').localeCompare(b.creditedArtists || 'Unknown'));
      break;
    case 'recently-added':
      songs.sort((a, b) => new Date(b.addedAt || 0) - new Date(a.addedAt || 0));
      break;
    case 'dateAdded':
      // Assuming songs have createdAt, otherwise use current order
      break;
    case 'playCount':
      songs.sort((a, b) => (b.playCount || 0) - (a.playCount || 0));
      break;
    case 'shuffle':
      for (let i = songs.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [songs[i], songs[j]] = [songs[j], songs[i]];
      }
      break;
    case 'custom':
    default:
      // Use original order
      break;
  }
  
  const container = document.getElementById('playlistSongs');
  container.innerHTML = '';
  songs.forEach((s, i) => {
    if (sortBy === 'custom') {
      container.appendChild(createPlaylistSongRowV2(s, i, currentPlaylistData));
    } else {
      // For other sorts, use the V2 row as well for consistency
      container.appendChild(createPlaylistSongRowV2(s, i, currentPlaylistData));
    }
  });
}

// 16. BULK SELECT
function togglePlaylistSongSelection(songId) {
  const row = document.querySelector(`[data-song-id="${songId}"]`);
  if (selectedSongs.has(songId)) {
    selectedSongs.delete(songId);
    row?.classList.remove('selected');
  } else {
    selectedSongs.add(songId);
    row?.classList.add('selected');
  }
  updateBulkActionsBar();
}

function updateBulkActionsBar() {
  const bar = document.getElementById('bulkActionsBar');
  if (selectedSongs.size > 0) {
    bar.classList.add('visible');
    bar.querySelector('span').textContent = `${selectedSongs.size} song${selectedSongs.size > 1 ? 's' : ''} selected`;
  } else {
    bar.classList.remove('visible');
  }
}

function selectAllSongs() {
  if (!currentPlaylistData) return;
  currentPlaylistData.songs.forEach(s => {
    selectedSongs.add(s.id);
    document.querySelector(`[data-song-id="${s.id}"]`)?.classList.add('selected');
  });
  updateBulkActionsBar();
}

function clearSelection() {
  selectedSongs.clear();
  document.querySelectorAll('.playlist-song-row, .song-card').forEach(el => {
    el.classList.remove('selected');
  });
  updateBulkActionsBar();
}

async function removeSelectedSongs() {
  if (!currentPlaylistId || selectedSongs.size === 0) return;
  
  try {
    for (const songId of selectedSongs) {
      await api('/playlists/' + currentPlaylistId + '/songs/' + songId, { method: 'DELETE' });
    }
    toast(`Removed ${selectedSongs.size} songs`, 'success');
    selectedSongs.clear();
    updateBulkActionsBar();
    loadPlaylistDetail(currentPlaylistId);
    logActivity(currentPlaylistId, 'removed', `${selectedSongs.size} songs`);
  } catch (err) {
    toast('Failed to remove songs', 'error');
  }
}

// 17. MOVE TO POSITION
let songToMove = null;

function openMovePositionModal(songId) {
  songToMove = songId;
  document.getElementById('movePositionInput').value = '';
  document.getElementById('movePositionModal').classList.add('open');
}

function closeMovePositionModal() {
  document.getElementById('movePositionModal').classList.remove('open');
  songToMove = null;
}

function confirmMovePosition() {
  const position = parseInt(document.getElementById('movePositionInput').value);
  if (!position || !songToMove) return;
  
  reorderPlaylistSong(songToMove, position);
  closeMovePositionModal();
}

// 18. PLAYLIST QUEUE (add without replacing)
async function addPlaylistToQueue(playlistId) {
  try {
    const p = await api('/playlists/' + playlistId);
    const playable = p.songs.filter(s => s.hasFilePath);
    queue.push(...playable);
    renderQueue();
    toast(`Added ${playable.length} songs to queue`, 'success');
  } catch (err) {
    toast(err.message, 'error');
  }
}

// 19. CONTINUE FROM LAST POSITION
function savePlaylistPosition(playlistId, songIndex) {
  lastPlaylistPosition[playlistId] = songIndex;
  localStorage.setItem('jv_playlist_positions', JSON.stringify(lastPlaylistPosition));
}

function getPlaylistPosition(playlistId) {
  const saved = localStorage.getItem('jv_playlist_positions');
  if (saved) lastPlaylistPosition = JSON.parse(saved);
  return lastPlaylistPosition[playlistId] || 0;
}

function showContinueBanner(playlistId, position) {
  const banner = document.getElementById('continueBanner');
  if (!banner) return;
  
  banner.classList.add('visible');
  banner.querySelector('span').textContent = `Continue from where you left off?`;
  banner.dataset.playlistId = playlistId;
  banner.dataset.position = position;
}

function continuePlaylist() {
  const banner = document.getElementById('continueBanner');
  const playlistId = banner.dataset.playlistId;
  const position = parseInt(banner.dataset.position);
  
  playPlaylistFromPosition(playlistId, position);
  banner.classList.remove('visible');
}

async function playPlaylistFromPosition(playlistId, position) {
  try {
    const p = await api('/playlists/' + playlistId);
    const playable = p.songs.filter(s => s.hasFilePath);
    if (!playable.length) { toast('No playable songs', 'error'); return; }
    
    const startIndex = Math.min(position, playable.length - 1);
    queue = playable.slice(startIndex + 1);
    playSong(playable[startIndex]);
    savePlaylistPosition(playlistId, startIndex);
    toast('Continuing playlist...', 'success');
  } catch (err) { toast(err.message, 'error'); }
}

// 20. PLAYLIST HISTORY
function logActivity(playlistId, action, details) {
  const key = 'jv_playlist_activity_' + playlistId;
  const activities = JSON.parse(localStorage.getItem(key) || '[]');
  activities.unshift({
    action,
    details,
    user: user?.displayName || 'You',
    time: Date.now()
  });
  // Keep last 50 activities
  if (activities.length > 50) activities.pop();
  localStorage.setItem(key, JSON.stringify(activities));
}

function getPlaylistActivity(playlistId) {
  const key = 'jv_playlist_activity_' + playlistId;
  return JSON.parse(localStorage.getItem(key) || '[]');
}

function updatePlaylistHistory(playlistId, completedSongs) {
  if (!playlistHistory[playlistId]) {
    playlistHistory[playlistId] = { playCount: 0, completedSongs: 0, lastPlayed: null };
  }
  playlistHistory[playlistId].playCount++;
  playlistHistory[playlistId].completedSongs += completedSongs;
  playlistHistory[playlistId].lastPlayed = Date.now();
  localStorage.setItem('jv_playlist_history', JSON.stringify(playlistHistory));
}

// 21. PIN PLAYLISTS
let pinnedPlaylists = JSON.parse(localStorage.getItem('jv_pinned_playlists') || '[]');

function pinPlaylist(playlistId) {
  if (!pinnedPlaylists.includes(playlistId)) {
    pinnedPlaylists.push(playlistId);
    localStorage.setItem('jv_pinned_playlists', JSON.stringify(pinnedPlaylists));
    toast('Playlist pinned to top', 'success');
    if (currentPage === 'library') loadLibrary();
  }
}

function unpinPlaylist(playlistId) {
  pinnedPlaylists = pinnedPlaylists.filter(id => id !== playlistId);
  localStorage.setItem('jv_pinned_playlists', JSON.stringify(pinnedPlaylists));
  toast('Playlist unpinned', 'info');
  if (currentPage === 'library') loadLibrary();
}

function isPlaylistPinned(playlistId) {
  return pinnedPlaylists.includes(playlistId);
}

// 22. ARCHIVE PLAYLISTS
let archivedPlaylists = JSON.parse(localStorage.getItem('jv_archived_playlists') || '[]');

function archivePlaylist(playlistId) {
  if (!archivedPlaylists.includes(playlistId)) {
    archivedPlaylists.push(playlistId);
    localStorage.setItem('jv_archived_playlists', JSON.stringify(archivedPlaylists));
    toast('Playlist archived', 'success');
    if (currentPage === 'library') loadLibrary();
  }
}

function unarchivePlaylist(playlistId) {
  archivedPlaylists = archivedPlaylists.filter(id => id !== playlistId);
  localStorage.setItem('jv_archived_playlists', JSON.stringify(archivedPlaylists));
  toast('Playlist restored', 'success');
  if (currentPage === 'library') loadLibrary();
}

function isPlaylistArchived(playlistId) {
  return archivedPlaylists.includes(playlistId);
}

// 23. PLAYLIST TEMPLATES
const PLAYLIST_TEMPLATES = [
  { id: 'deep_cuts', name: '💎 Deep Cuts', desc: 'Less played hidden gems', filter: s => (s.playCount || 0) < 10 && s.hasFilePath },
  { id: 'liked_songs', name: '❤️ Liked Songs Mix', desc: 'Your liked songs', filter: s => userLikes[s.id] },
  { id: 'lyrics_ready', name: '🎤 Lyrics Ready', desc: 'Songs with synced lyrics', filter: s => s.hasLyrics },
  { id: 'most_played', name: '🔥 Most Played', desc: 'Your top played songs', filter: s => (s.playCount || 0) > 5 },
  { id: 'unreleased', name: '🔒 Unreleased Only', desc: 'Leaked tracks', filter: s => s.category === 'unreleased' }
];

async function createFromTemplate(templateId) {
  const template = PLAYLIST_TEMPLATES.find(t => t.id === templateId);
  if (!template) return;
  
  try {
    // Get songs (multiple pages to get enough matches)
    let allSongs = [];
    for (let p = 1; p <= 5; p++) {
      const data = await api('/songs?page=' + p + '&pageSize=100');
      allSongs = allSongs.concat(data.songs || []);
      if (!data.pagination || p >= data.pagination.totalPages) break;
    }
    const matching = allSongs.filter(template.filter).slice(0, 50);
    
    if (matching.length === 0) {
      toast('No songs match this template', 'error');
      return;
    }
    
    // Create playlist
    const newPlaylist = await api('/playlists', {
      method: 'POST',
      body: JSON.stringify({ name: template.name, description: template.desc })
    });
    
    // Add songs
    for (const song of matching) {
      await api('/playlists/' + newPlaylist.playlist.id + '/songs', {
        method: 'POST',
        body: JSON.stringify({ songId: song.id })
      }).catch(() => {});
    }
    
    toast(`Created "${template.name}" with ${matching.length} songs!`, 'success');
    await loadUserPlaylists();
    if (currentPage === 'library') loadLibrary();
  } catch (err) {
    toast('Failed to create from template', 'error');
  }
}

// 24. RECENTLY MODIFIED
function getRecentlyModifiedPlaylists() {
  return userPlaylists
    .filter(p => p.updatedAt)
    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
    .slice(0, 5);
}

// 25. ACTIVITY LOG
function renderActivityLog(playlistId) {
  const activities = getPlaylistActivity(playlistId);
  const container = document.getElementById('playlistActivityLog');
  if (!container) return;
  
  if (!activities.length) {
    container.innerHTML = '<p style="color:var(--text-muted);font-size:0.8rem;text-align:center;padding:20px;">No activity yet</p>';
    return;
  }
  
  container.innerHTML = activities.slice(0, 10).map(a => {
    const timeAgo = getTimeAgo(a.time);
    return `
      <div class="activity-item">
        <span class="activity-user">${esc(a.user)}</span>
        <span>${a.action} ${esc(a.details || '')}</span>
        <span class="activity-time">${timeAgo}</span>
      </div>
    `;
  }).join('');
}

function getTimeAgo(timestamp) {
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return `${minutes}m ago`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  return `${days}d ago`;
}

// 26. AUTO-GENERATED DESCRIPTION
function generatePlaylistDescription(songs) {
  if (songs.length === 0) return 'An empty playlist waiting to be filled.';
  
  const artists = [...new Set(songs.map(s => s.creditedArtists).filter(Boolean))];
  const categories = [...new Set(songs.map(s => s.category).filter(Boolean))];
  const moods = detectPlaylistMoods(songs);
  
  let desc = `A collection of ${songs.length} songs`;
  
  if (categories.length === 1) {
    desc += ` from the ${categories[0]} category`;
  } else if (categories.length > 1) {
    desc += ` spanning ${categories.slice(0, 3).join(', ')}`;
  }
  
  if (moods.length) {
    desc += `. Features a ${moods.join('/')} vibe.`;
  } else {
    desc += '.';
  }
  
  if (artists.length > 1) {
    desc += ` Includes tracks by ${artists.slice(0, 3).join(', ')}${artists.length > 3 ? ' and more' : ''}.`;
  }
  
  return desc;
}

// 27. MOOD/GENRE DETECTION (handled in detectPlaylistMoods above)
function renderMoodTags(songs) {
  const moods = detectPlaylistMoods(songs);
  if (!moods.length) return '';
  
  return `
    <div class="mood-tags">
      ${moods.map(m => `<span class="mood-tag">${m}</span>`).join('')}
    </div>
  `;
}

// 28. COMPARE PLAYLISTS
function openCompareModal() {
  if (!currentPlaylistId) return;
  const list = document.getElementById('comparePlaylistList');
  list.innerHTML = userPlaylists
    .filter(p => p.id !== currentPlaylistId)
    .map(p => `
      <div class="modal-playlist-item" onclick="compareWithPlaylist('${p.id}')">
        <span class="mpi-icon">🎵</span>
        <span class="mpi-name">${esc(p.name)}</span>
        <span class="mpi-count">${p.songCount} songs</span>
      </div>
    `).join('') || '<p style="text-align:center;color:var(--text-muted);padding:20px;">No other playlists</p>';
  
  document.getElementById('compareResults').style.display = 'none';
  document.getElementById('comparePlaylistModal').classList.add('open');
}

function closeCompareModal() {
  document.getElementById('comparePlaylistModal').classList.remove('open');
}

async function compareWithPlaylist(otherId) {
  try {
    const [current, other] = await Promise.all([
      api('/playlists/' + currentPlaylistId),
      api('/playlists/' + otherId)
    ]);
    
    const currentIds = new Set(current.songs.map(s => s.id));
    const otherIds = new Set(other.songs.map(s => s.id));
    
    const duplicates = current.songs.filter(s => otherIds.has(s.id));
    const onlyInCurrent = current.songs.filter(s => !otherIds.has(s.id));
    const onlyInOther = other.songs.filter(s => !currentIds.has(s.id));
    
    const results = document.getElementById('compareResults');
    results.style.display = 'block';
    results.innerHTML = `
      <div class="compare-result">
        <div class="compare-column">
          <h4>🎵 In Both (${duplicates.length})</h4>
          ${duplicates.map(s => `<div class="compare-song compare-song-duplicate">${esc(s.name)}</div>`).join('') || '<div class="compare-song">None</div>'}
        </div>
        <div class="compare-column">
          <h4>📁 Only in "${esc(current.name)}" (${onlyInCurrent.length})</h4>
          ${onlyInCurrent.map(s => `<div class="compare-song compare-song-unique">${esc(s.name)}</div>`).join('') || '<div class="compare-song">None</div>'}
        </div>
        <div class="compare-column">
          <h4>📁 Only in "${esc(other.name)}" (${onlyInOther.length})</h4>
          ${onlyInOther.map(s => `<div class="compare-song">${esc(s.name)}</div>`).join('') || '<div class="compare-song">None</div>'}
        </div>
      </div>
    `;
  } catch (err) {
    toast('Compare failed: ' + err.message, 'error');
  }
}

// 29. PLAYLIST RADIO
async function generatePlaylistRadio() {
  if (!currentPlaylistData) return;
  
  document.getElementById('playlistRadioModal').classList.add('open');
  const results = document.getElementById('playlistRadioResults');
  results.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  
  try {
    const existingIds = new Set(currentPlaylistData.songs.map(s => s.id));
    const radioSongs = [];
    
    // Get radio suggestions based on playlist songs
    for (let i = 0; i < 10 && radioSongs.length < 8; i++) {
      try {
        const data = await api('/radio/random');
        if (data.localSong?.id && !existingIds.has(data.localSong.id)) {
          const song = await api('/songs/' + data.localSong.id);
          if (song) {
            radioSongs.push(song);
            existingIds.add(song.id);
          }
        }
      } catch {}
    }
    
    if (radioSongs.length) {
      results.innerHTML = '<div class="song-grid" id="radioResultsGrid"></div>';
      const grid = document.getElementById('radioResultsGrid');
      radioSongs.forEach((s, i) => grid.appendChild(createSongCard(s, i)));
      window.radioSongsCache = radioSongs;
    } else {
      results.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:40px;">No recommendations found</p>';
    }
  } catch (err) {
    results.innerHTML = '<p style="text-align:center;color:var(--red);padding:40px;">Failed to generate radio</p>';
  }
}

function closePlaylistRadioModal() {
  document.getElementById('playlistRadioModal').classList.remove('open');
}

async function addRadioToPlaylist() {
  if (!currentPlaylistId || !window.radioSongsCache) return;
  
  try {
    for (const song of window.radioSongsCache) {
      await api('/playlists/' + currentPlaylistId + '/songs', {
        method: 'POST',
        body: JSON.stringify({ songId: song.id })
      }).catch(() => {});
    }
    toast(`Added ${window.radioSongsCache.length} songs!`, 'success');
    closePlaylistRadioModal();
    loadPlaylistDetail(currentPlaylistId);
  } catch (err) {
    toast('Failed to add songs', 'error');
  }
}

// 30. BACKGROUND ART COLLAGE
function generatePlaylistCollage(songs) {
  const artworks = songs.slice(0, 20).map(s => artSrc(s)).filter(Boolean);
  if (artworks.length < 4) return '';
  
  return `
    <div class="bg-collage">
      ${artworks.map(url => `<img src="${url}" loading="lazy">`).join('')}
    </div>
  `;
}

// ═══ ENHANCED PLAYLIST UI FUNCTIONS ═══

function openPlaylistEditModal(playlistId = null) {
  editingPlaylistId = playlistId;
  document.getElementById('playlistEditTitle').textContent = playlistId ? 'Edit Playlist' : 'Create Playlist';
  
  if (playlistId) {
    const p = userPlaylists.find(pl => pl.id === playlistId);
    document.getElementById('playlistNameInput').value = p?.name || '';
    document.getElementById('playlistDescInput').innerHTML = p?.description || '';
  } else {
    document.getElementById('playlistNameInput').value = '';
    document.getElementById('playlistDescInput').innerHTML = '';
    document.getElementById('coverUploadArea').innerHTML = `
      <span style="font-size: 2rem;">🖼️</span>
      <span style="font-size: 0.8rem; color: var(--text-muted);">Click to upload cover</span>
      <div class="cover-upload-overlay">
        <span style="font-size: 1.5rem;">📷</span>
        <span style="font-size: 0.75rem;">Change</span>
      </div>
    `;
    document.getElementById('coverUploadArea').classList.remove('has-image');
    tempCoverImage = null;
  }
  
  document.getElementById('playlistEditModal').classList.add('open');
}

function closePlaylistEditModal() {
  document.getElementById('playlistEditModal').classList.remove('open');
  editingPlaylistId = null;
  tempCoverImage = null;
  smartRules = [];
  document.getElementById('smartRulesContainer').innerHTML = '';
}

async function savePlaylistEdit() {
  const name = document.getElementById('playlistNameInput').value.trim();
  if (!name) { toast('Please enter a name', 'error'); return; }
  
  const description = document.getElementById('playlistDescInput').innerHTML;
  const isSmart = document.getElementById('playlistSmartToggle').checked;
  const isPublic = document.getElementById('playlistPublicToggle').checked;
  
  try {
    if (editingPlaylistId) {
      await api('/playlists/' + editingPlaylistId, {
        method: 'PUT',
        body: JSON.stringify({ name, description })
      });
      toast('Playlist updated!', 'success');
    } else {
      const data = await api('/playlists', {
        method: 'POST',
        body: JSON.stringify({ 
          name, 
          description,
          isSmart,
          smartRules: isSmart ? getSmartRules() : null,
          isPublic,
          coverImage: tempCoverImage
        })
      });
      
      // Apply smart rules immediately if it's a smart playlist
      if (isSmart) {
        const allSongs = await api('/songs?page=1&pageSize=1000');
        const matching = applySmartRules(getSmartRules(), allSongs.songs || []);
        for (const song of matching.slice(0, 100)) {
          await api('/playlists/' + data.playlist.id + '/songs', {
            method: 'POST',
            body: JSON.stringify({ songId: song.id })
          }).catch(() => {});
        }
      }
      
      toast('Playlist created!', 'success');
    }
    
    await loadUserPlaylists();
    closePlaylistEditModal();
    if (currentPage === 'library') loadLibrary();
  } catch (err) {
    toast(err.message, 'error');
  }
}

function createPlaylistSongRow(s, i) {
  const row = document.createElement('div');
  row.className = 'playlist-song-row';
  row.dataset.songId = s.id;
  initDragAndDrop(row, s.id);
  
  const imgHtml = artTag(s, '🎵');
  const isSelected = selectedSongs.has(s.id);
  if (isSelected) row.classList.add('selected');
  
  row.innerHTML = `
    <div style="display: flex; align-items: center; gap: 8px;">
      <input type="checkbox" class="song-checkbox" ${isSelected ? 'checked' : ''} onchange="togglePlaylistSongSelection('${s.id}')">
      <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
    </div>
    <div class="song-row-art">${imgHtml}</div>
    <div>
      <div class="song-row-title">${esc(s.name)}</div>
    </div>
    <div class="song-row-artist">${esc(s.creditedArtists || 'Juice WRLD')}</div>
    <div class="song-row-duration">${s.length || '—'}</div>
    <div class="song-row-actions">
      <button class="song-row-btn" onclick="event.stopPropagation(); openMovePositionModal('${s.id}')" title="Move to position">⇅</button>
      <button class="song-row-btn" onclick="event.stopPropagation(); removeFromPlaylist('${s.id}')" title="Remove">✕</button>
    </div>
  `;
  
  row.addEventListener('click', (e) => {
    if (!e.target.closest('button') && !e.target.closest('input')) {
      playSongById(s.id);
    }
  });
  
  return row;
}

async function removeFromPlaylist(songId) {
  if (!currentPlaylistId) return;
  try {
    await api('/playlists/' + currentPlaylistId + '/songs/' + songId, { method: 'DELETE' });
    loadPlaylistDetail(currentPlaylistId);
    logActivity(currentPlaylistId, 'removed', '1 song');
  } catch (err) {
    toast('Failed to remove', 'error');
  }
}

// ═══ OVERRIDE EXISTING FUNCTIONS WITH ENHANCED VERSIONS ═══

const originalLoadLibrary = loadLibrary;
loadLibrary = async function() {
  await Promise.all([loadUserLikes(), loadUserPlaylists()]);
  
  // Liked songs
  const likedIds = Object.entries(userLikes).filter(([,v]) => v === true).map(([k]) => k);
  const likedGrid = document.getElementById('likedSongsGrid');
  if (likedIds.length) {
    likedGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
      const promises = likedIds.slice(0, 20).map(id => api('/songs/' + id).catch(() => null));
      const songs = (await Promise.all(promises)).filter(Boolean);
      likedGrid.innerHTML = '';
      likedGrid.className = 'song-grid';
      songs.forEach((s, i) => likedGrid.appendChild(createSongCard(s, i)));
    } catch { likedGrid.innerHTML = '<div class="empty-state"><p>Could not load liked songs</p></div>'; }
  } else {
    likedGrid.innerHTML = '<div class="empty-state" style="padding:20px"><p style="color:var(--text-muted)">No liked songs yet. Hit the ❤️ on any song!</p></div>';
  }
  
  // Playlists with folders and pinning
  const grid = document.getElementById('playlistGrid');
  grid.innerHTML = '';
  
  // Template section
  const templateSection = document.createElement('div');
  templateSection.style.cssText = 'grid-column: 1/-1; margin-bottom: 16px;';
  templateSection.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
      <h4 style="font-size: 0.9rem; color: var(--text-secondary);">🎨 Templates</h4>
      <button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem;">Toggle</button>
    </div>
    <div class="template-grid">
      ${PLAYLIST_TEMPLATES.map(t => `
        <div class="template-card" onclick="createFromTemplate('${t.id}')">
          <div class="template-card-icon">${t.name.split(' ')[0]}</div>
          <div class="template-card-name">${esc(t.name.replace(/^\S+\s/, ''))}</div>
          <div class="template-card-desc">${esc(t.desc)}</div>
        </div>
      `).join('')}
    </div>
  `;
  grid.appendChild(templateSection);
  
  // Import button
  const importCard = document.createElement('div');
  importCard.className = 'create-playlist-card';
  importCard.onclick = openImportModal;
  importCard.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span>Import Playlist</span>';
  grid.appendChild(importCard);
  
  // Create new
  const createCard = document.createElement('div');
  createCard.className = 'create-playlist-card';
  createCard.onclick = () => openPlaylistEditModal();
  createCard.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span>New Playlist</span>';
  grid.appendChild(createCard);
  
  // Sort playlists: pinned first, then regular, archived last
  const sorted = [...userPlaylists].sort((a, b) => {
    const aPinned = isPlaylistPinned(a.id) ? 1 : 0;
    const bPinned = isPlaylistPinned(b.id) ? 1 : 0;
    const aArchived = isPlaylistArchived(a.id) ? -1 : 0;
    const bArchived = isPlaylistArchived(b.id) ? -1 : 0;
    return (bPinned + aArchived) - (aPinned + bArchived);
  });
  
  sorted.forEach(p => {
    const card = document.createElement('div');
    card.className = 'playlist-card';
    if (isPlaylistPinned(p.id)) card.classList.add('pinned');
    if (isPlaylistArchived(p.id)) card.classList.add('archived');
    
    card.innerHTML = renderPlaylistCard(p);
    
    // Context menu
    card.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showPlaylistContextMenu(e, p);
    });
    
    card.querySelector('.playlist-card-art')?.addEventListener('click', () => {
      navigateTo('playlist');
      loadPlaylistDetail(p.id);
    });
    
    grid.appendChild(card);
  });
  
  // Recently modified section
  const recent = getRecentlyModifiedPlaylists();
  if (recent.length > 0) {
    const recentSection = document.createElement('div');
    recentSection.style.cssText = 'grid-column: 1/-1; margin-top: 24px;';
    recentSection.innerHTML = `
      <h4 style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;">🕐 Recently Modified</h4>
      <div class="recently-modified">
        ${recent.map(p => `
          <div class="recent-item" onclick="navigateTo('playlist'); loadPlaylistDetail('${p.id}');">
            <span>🎵 ${esc(p.name)}</span>
            <span class="recent-item-time">${p.updatedAt ? new Date(p.updatedAt).toLocaleDateString() : ''}</span>
          </div>
        `).join('')}
      </div>
    `;
    grid.appendChild(recentSection);
  }
};

function renderPlaylistCard(p) {
  const imgs = (p.previewImages || []).slice(0, 4);
  let artHtml = '';
  if (imgs.length >= 4) {
    artHtml = imgs.map(u => '<img src="' + esc(u) + '" loading="lazy">').join('');
  } else if (p.coverImage) {
    artHtml = '<img src="' + p.coverImage + '" loading="lazy" style="grid-column: 1/-1; grid-row: 1/-1;">';
  } else {
    artHtml = '<div class="pca-empty">🎵</div>';
  }
  
  const pinIcon = isPlaylistPinned(p.id) ? '📌 ' : '';
  const archiveBadge = isPlaylistArchived(p.id) ? '<span style="position:absolute;top:8px;right:8px;background:var(--text-muted);padding:2px 8px;border-radius:var(--radius-full);font-size:0.65rem;">Archived</span>' : '';
  const smartBadge = p.isSmart ? '<span class="smart-badge" style="margin-left:8px;">🤖 Smart</span>' : '';
  
  return `
    <div class="playlist-card-art">${artHtml}${archiveBadge}</div>
    <div class="playlist-card-info">
      <div class="playlist-card-name">${pinIcon}${esc(p.name)}${smartBadge}</div>
      <div class="playlist-card-meta">${p.songCount} songs</div>
    </div>
  `;
}

function showPlaylistContextMenu(e, playlist) {
  // Remove existing menus
  document.querySelectorAll('.playlist-context-menu').forEach(m => m.remove());
  
  const menu = document.createElement('div');
  menu.className = 'playlist-context-menu';
  menu.style.cssText = `
    position: fixed;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 8px 0;
    z-index: 1000;
    min-width: 180px;
    box-shadow: var(--shadow-lg);
  `;
  
  const items = [
    { label: '▶ Play', action: () => playPlaylist(playlist.id) },
    { label: '＋ Add to Queue', action: () => addPlaylistToQueue(playlist.id) },
    { label: isPlaylistPinned(playlist.id) ? '📌 Unpin' : '📌 Pin to Top', action: () => isPlaylistPinned(playlist.id) ? unpinPlaylist(playlist.id) : pinPlaylist(playlist.id) },
    { label: '✏️ Edit', action: () => openPlaylistEditModal(playlist.id) },
    { label: '📋 Duplicate', action: () => duplicatePlaylist(playlist.id) },
    { label: '🔗 Share', action: () => openShareModal(playlist.id) },
    isPlaylistArchived(playlist.id) 
      ? { label: '↩ Restore', action: () => unarchivePlaylist(playlist.id) }
      : { label: '🗃️ Archive', action: () => archivePlaylist(playlist.id) },
    { label: '🗑️ Delete', action: () => deletePlaylist(playlist.id), danger: true }
  ];
  
  items.forEach(item => {
    const div = document.createElement('div');
    div.textContent = item.label;
    div.style.cssText = `
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      color: ${item.danger ? 'var(--red)' : 'var(--text)'};
    `;
    div.onmouseover = () => div.style.background = 'var(--glass-hover)';
    div.onmouseout = () => div.style.background = 'none';
    div.onclick = () => { item.action(); menu.remove(); };
    menu.appendChild(div);
  });
  
  menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(e.clientY, window.innerHeight - 300) + 'px';
  
  document.body.appendChild(menu);
  
  const closeMenu = () => {
    menu.remove();
    document.removeEventListener('click', closeMenu);
  };
  setTimeout(() => document.addEventListener('click', closeMenu), 10);
}

async function deletePlaylist(id) {
  if (!confirm('Are you sure you want to delete this playlist?')) return;
  try {
    await api('/playlists/' + id, { method: 'DELETE' });
    toast('Playlist deleted', 'success');
    await loadUserPlaylists();
    if (currentPage === 'library') loadLibrary();
  } catch (err) {
    toast('Failed to delete: ' + err.message, 'error');
  }
}

const originalLoadPlaylistDetail = loadPlaylistDetail;
loadPlaylistDetail = async function(id) {
  currentPlaylistId = id;
  selectedSongs.clear();
  updateBulkActionsBar();
  
  const container = document.getElementById('playlistDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  
  try {
    const p = await api('/playlists/' + id);
    currentPlaylistData = p;
    
    // Check for continue banner
    const lastPos = getPlaylistPosition(id);
    const showContinue = lastPos > 0 && lastPos < p.songs.length - 1;
    
    // Calculate stats
    const stats = calculatePlaylistStats(p.songs);
    
    // Generate description if none
    if (!p.description && p.songs.length > 0) {
      p.description = generatePlaylistDescription(p.songs);
    }
    
    // Calculate total duration in minutes
    const totalMinutes = Math.floor(stats.totalDuration / 60);
    const totalHours = Math.floor(totalMinutes / 60);
    const durationDisplay = totalHours > 0 ? `${totalHours}h ${totalMinutes % 60}m` : `${totalMinutes}m`;
    
    // Check if user has liked this playlist
    const isLiked = p.isLiked || false;
    
    // Generate gradient for cover if no image
    const gradientColors = [
      ['#9b5de5', '#f15bb5'],
      ['#7432b8', '#00f5d4'],
      ['#ff9e2c', '#f15bb5'],
      ['#2ed573', '#00f5d4'],
      ['#ff4757', '#ff9e2c']
    ];
    const gradientIndex = (p.name.length + id.length) % gradientColors.length;
    const [gradStart, gradEnd] = gradientColors[gradientIndex];
    
    // Render collaborators
    const collaboratorsHtml = (p.collaborators || []).map(c => `
      <div class="playlist-collaborator" title="${esc(c.username || c.email || 'Collaborator')}">
        <div class="collab-avatar" style="background: linear-gradient(135deg, var(--purple-500), var(--pink));">
          ${(c.username || c.email || 'C').charAt(0).toUpperCase()}
        </div>
      </div>
    `).join('');
    
    container.innerHTML = `
      <!-- Back Button -->
      <button class="playlist-back-btn" onclick="navigateTo('library')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        Back to Library
      </button>
      
      <!-- Continue Banner -->
      ${showContinue ? `
        <div id="continueBanner" class="continue-banner visible">
          <span>⏯️ Continue from where you left off?</span>
          <button onclick="continuePlaylist()">Continue</button>
          <button style="background:none;color:var(--text-muted);" onclick="this.parentElement.classList.remove('visible')">Dismiss</button>
        </div>
      ` : ''}
      
      <!-- Hero Section -->
      <div class="playlist-hero">
        <div class="playlist-hero-cover">
          ${p.coverImage ? `<img src="${esc(p.coverImage)}" alt="${esc(p.name)}">` : 
            p.previewImages?.length >= 4 ? `<div class="playlist-cover-grid">${p.previewImages.slice(0,4).map(u => `<img src="${esc(u)}" loading="lazy">`).join('')}</div>` :
            `<div class="playlist-cover-gradient" style="background: linear-gradient(135deg, ${gradStart}, ${gradEnd});">
              <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
            </div>`}
        </div>
        
        <div class="playlist-hero-info">
          <div class="playlist-hero-type">
            ${p.isSmart ? '<span class="smart-badge">🤖 Smart Playlist</span>' : '🎵 Playlist'}
            ${isPlaylistPinned(p.id) ? '<span class="pinned-badge">📌 Pinned</span>' : ''}
          </div>
          
          <h1 class="playlist-hero-title">${esc(p.name)}</h1>
          
          ${p.description ? `
            <p class="playlist-hero-description ${p.description.length > 120 ? 'collapsible' : ''}" id="playlistDesc">
              ${esc(p.description)}
            </p>
            ${p.description.length > 120 ? `<button class="desc-toggle" onclick="toggleDesc(this)">Show more</button>` : ''}
          ` : ''}
          
          <div class="playlist-hero-meta">
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M12 2a10 10 0 0 1 10 10"/><circle cx="12" cy="12" r="3"/></svg>
              ${p.songs.length} ${p.songs.length === 1 ? 'song' : 'songs'}
            </span>
            <span class="meta-separator">•</span>
            <span class="meta-item">${durationDisplay}</span>
            <span class="meta-separator">•</span>
            <span class="meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              Created by ${esc(p.createdBy?.username || p.createdBy?.email || 'You')}
            </span>
            ${p.createdAt ? `
              <span class="meta-separator">•</span>
              <span class="meta-item">${new Date(p.createdAt).toLocaleDateString()}</span>
            ` : ''}
          </div>
          
          ${(p.collaborators || []).length > 0 ? `
            <div class="playlist-collaborators-row">
              <span class="collab-label">Collaborators:</span>
              <div class="collab-avatars">
                ${collaboratorsHtml}
                ${p.isOwner ? `<button class="add-collab-btn" onclick="openAddCollaboratorModal('${id}')" title="Add collaborator">+</button>` : ''}
              </div>
            </div>
          ` : p.isOwner ? `
            <div class="playlist-collaborators-row">
              <button class="add-collab-btn-text" onclick="openAddCollaboratorModal('${id}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Add collaborators
              </button>
            </div>
          ` : ''}
          
          <div class="playlist-hero-actions">
            <button class="hero-btn hero-btn-primary" onclick="playPlaylist('${id}')">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Play All
            </button>
            <button class="hero-btn hero-btn-secondary" onclick="shufflePlaylist('${id}')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>
              Shuffle
            </button>
            <button class="hero-btn hero-btn-secondary" onclick="addPlaylistToQueue('${id}')">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add to Queue
            </button>
            <button class="hero-btn-icon ${isLiked ? 'liked' : ''}" onclick="togglePlaylistLike('${id}', this)" title="${isLiked ? 'Unlike' : 'Like'} playlist">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </button>
            <div class="playlist-actions-dropdown">
              <button class="hero-btn-icon" onclick="togglePlaylistActionsMenu(this, '${id}')" title="More options">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stats Bar -->
      <div class="playlist-stats-bar-v2">
        <div class="stat-item">
          <span class="stat-value">${p.songs.length}</span>
          <span class="stat-label">Songs</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${durationDisplay}</span>
          <span class="stat-label">Duration</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${stats.avgPlayCount}</span>
          <span class="stat-label">Avg Plays</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">${p.likeCount || 0}</span>
          <span class="stat-label">Likes</span>
        </div>
        <div class="stat-categories">
          ${Object.entries(stats.byCategory).slice(0, 3).map(([cat, count]) => 
            `<span class="category-chip">${esc(cat.replace(/_/g, ' '))}</span>`
          ).join('') || '<span class="category-chip">Mixed</span>'}
        </div>
      </div>
      
      <!-- Toolbar -->
      <div class="playlist-toolbar">
        <div class="playlist-search-box-v2">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" placeholder="Search songs in playlist..." oninput="searchPlaylistSongs(this.value)">
        </div>
        <select class="sort-dropdown-v2" onchange="sortPlaylistSongs(this.value)">
          <option value="custom">↕️ Custom Order</option>
          <option value="name">🔤 Name A-Z</option>
          <option value="artist">🎤 Artist</option>
          <option value="playCount">▶ Most Played</option>
          <option value="recently-added">📅 Recently Added</option>
          <option value="shuffle">🔀 Shuffle</option>
        </select>
        <button class="toolbar-btn" onclick="selectAllSongs()">Select All</button>
        <button class="toolbar-btn" onclick="clearSelection()">Clear</button>
      </div>
      
      <!-- Bulk Actions Bar -->
      <div id="bulkActionsBar" class="bulk-actions-bar">
        <span class="bulk-count">0 songs selected</span>
        <div class="bulk-actions">
          <button class="bulk-action-btn" onclick="addSelectedToQueue()">Add to Queue</button>
          <button class="bulk-action-btn" onclick="addSelectedToPlaylist()">Add to Playlist</button>
          ${p.isOwner ? `<button class="bulk-action-btn danger" onclick="removeSelectedSongs()">Remove</button>` : ''}
          <button class="bulk-action-btn secondary" onclick="clearSelection()">Cancel</button>
        </div>
      </div>
      
      <!-- Song List Header -->
      <div class="playlist-songs-header">
        <span class="col-num">#</span>
        <span class="col-title">Title</span>
        <span class="col-artist">Artist</span>
        <span class="col-album">Album</span>
        <span class="col-date">Date Added</span>
        <span class="col-duration">⏱</span>
        <span class="col-actions"></span>
      </div>
      
      <!-- Song List -->
      <div id="playlistSongs" class="playlist-songs-list"></div>
      
      ${p.songs.length === 0 ? `
        <div class="playlist-empty-state">
          <div class="empty-icon">🎵</div>
          <h3>No songs yet</h3>
          <p>This playlist is waiting for some fire tracks!</p>
          ${p.isOwner ? `<button class="hero-btn hero-btn-primary" onclick="navigateTo('catalog')">Browse Catalog</button>` : ''}
        </div>
      ` : ''}
      
      <!-- Comments Section -->
      <div class="playlist-comments-section">
        <div class="section-header-v2">
          <h3>💬 Comments</h3>
          <span class="comment-count">${p.comments?.length || 0}</span>
        </div>
        <div class="comment-input-wrap">
          <div class="comment-avatar">${(user?.displayName || user?.username || user?.email || 'Y').charAt(0).toUpperCase()}</div>
          <div class="comment-input-area">
            <textarea class="comment-input" id="playlistCommentInput" placeholder="Add a comment..."></textarea>
            <button class="comment-submit" onclick="addPlaylistComment('${id}', document.getElementById('playlistCommentInput').value)">Post</button>
          </div>
        </div>
        <div id="playlistComments" class="playlist-comments-list"></div>
      </div>
      
      <!-- Activity Log -->
      <div class="playlist-activity-section">
        <h3 class="section-header-v2">📜 Recent Activity</h3>
        <div id="playlistActivityLog" class="activity-log-list"></div>
      </div>
    `;
    
    // Render songs with new row style
    const songsContainer = document.getElementById('playlistSongs');
    if (p.songs.length > 0) {
      p.songs.forEach((s, i) => {
        songsContainer.appendChild(createPlaylistSongRowV2(s, i, p));
      });
    }
    
    // Load comments and activity
    loadPlaylistComments(id);
    renderActivityLog(id);
    
    // Log view
    logActivity(id, 'viewed', '');
    
  } catch (err) {
    container.innerHTML = '<div class="empty-state"><p>' + esc(err.message) + '</p></div>';
  }
};

// ═══ PLAYLIST DETAIL V2 HELPER FUNCTIONS ═══

function toggleDesc(btn) {
  const desc = document.getElementById('playlistDesc');
  if (desc.classList.contains('collapsed')) {
    desc.classList.remove('collapsed');
    btn.textContent = 'Show less';
  } else {
    desc.classList.add('collapsed');
    btn.textContent = 'Show more';
  }
}

async function shufflePlaylist(id) {
  try {
    const p = await api('/playlists/' + id);
    const playable = p.songs.filter(s => s.hasFilePath);
    if (!playable.length) { toast('No playable songs in this playlist', 'error'); return; }
    
    // Shuffle
    for (let i = playable.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [playable[i], playable[j]] = [playable[j], playable[i]];
    }
    
    queue = playable.slice(1);
    playSong(playable[0]);
    shuffleOn = true;
    document.getElementById('btnShuffle')?.classList.add('active');
    toast('Shuffling ' + p.name + '!', 'success');
  } catch (err) { toast(err.message, 'error'); }
}

async function togglePlaylistLike(id, btn) {
  try {
    const isLiked = btn.classList.contains('liked');
    if (isLiked) {
      await api('/playlists/' + id + '/like', { method: 'DELETE' });
      btn.classList.remove('liked');
      btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
      btn.title = 'Like playlist';
      toast('Removed from liked playlists', 'info');
    } else {
      await api('/playlists/' + id + '/like', { method: 'POST' });
      btn.classList.add('liked');
      btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
      btn.title = 'Unlike playlist';
      toast('Added to liked playlists!', 'success');
    }
  } catch (err) { toast(err.message, 'error'); }
}

function togglePlaylistActionsMenu(btn, playlistId) {
  // Remove existing menus
  document.querySelectorAll('.playlist-actions-menu').forEach(m => m.remove());
  
  const p = currentPlaylistData;
  if (!p) return;
  
  const menu = document.createElement('div');
  menu.className = 'playlist-actions-menu';
  
  const items = [
    { label: '🔗 Share', action: () => openShareModal(playlistId) },
    { label: '📋 Copy Link', action: () => { copyPlaylistLink(playlistId); } },
    ...(p.isOwner ? [
      { label: isPlaylistPinned(playlistId) ? '📌 Unpin' : '📌 Pin', action: () => isPlaylistPinned(playlistId) ? unpinPlaylist(playlistId) : pinPlaylist(playlistId) },
      { label: '✏️ Edit Details', action: () => openPlaylistEditModal(playlistId) },
      { label: '👥 Manage Collaborators', action: () => openAddCollaboratorModal(playlistId) },
    ] : []),
    { label: '📻 Generate Radio', action: () => generatePlaylistRadio() },
    ...(p.isOwner ? [
      { label: '🗑️ Delete', action: () => deletePlaylist(playlistId), danger: true }
    ] : [])
  ];
  
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'playlist-actions-menu-item' + (item.danger ? ' danger' : '');
    div.textContent = item.label;
    div.onclick = () => { item.action(); menu.remove(); };
    menu.appendChild(div);
  });
  
  btn.parentElement.appendChild(menu);
  
  const closeMenu = (e) => {
    if (!menu.contains(e.target) && e.target !== btn) {
      menu.remove();
      document.removeEventListener('click', closeMenu);
    }
  };
  setTimeout(() => document.addEventListener('click', closeMenu), 10);
}

function copyPlaylistLink(id) {
  const url = window.location.origin + '/playlist/' + id;
  navigator.clipboard.writeText(url).then(() => {
    toast('Link copied to clipboard!', 'success');
  });
}

function createPlaylistSongRowV2(s, i, playlist) {
  const row = document.createElement('div');
  row.className = 'playlist-song-row-v2' + (currentSong?.id === s.id ? ' active' : '');
  row.dataset.songId = s.id;
  
  const imgHtml = artTag(s, '🎵');
  const isLiked = userLikes[s.id] === true;
  const isOwner = playlist?.isOwner;
  const isPlaying = currentSong?.id === s.id;
  
  // Parse date added if available
  const dateAdded = s.addedAt ? new Date(s.addedAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) : '—';
  
  row.innerHTML = `
    <div class="psr-num">
      ${isPlaying ? '<div class="psr-playing-indicator"><span></span><span></span><span></span><span></span></div>' : 
        `<span class="psr-drag-handle" title="Drag to reorder">⋮⋮</span>${i + 1}`}
    </div>
    <div class="psr-art">${imgHtml}</div>
    <div class="psr-title-section">
      <div class="psr-title">
        ${esc(s.name)}
        ${s.isExplicit ? '<span class="psr-explicit">E</span>' : ''}
      </div>
    </div>
    <div class="psr-artist">${esc(s.creditedArtists || 'Juice WRLD')}</div>
    <div class="psr-album">${esc(s.album || '—')}</div>
    <div class="psr-date">${dateAdded}</div>
    <div class="psr-duration">${s.length || '—'}</div>
    <div class="psr-actions">
      <button class="psr-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation();togglePlaylistSongLike('${s.id}', this)" title="${isLiked ? 'Unlike' : 'Like'}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </button>
      <button class="psr-btn" onclick="event.stopPropagation();openPlaylistModal('${s.id}')" title="Add to playlist">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      ${isOwner ? `
        <button class="psr-btn remove" onclick="event.stopPropagation();removeSongFromPlaylist('${s.id}')" title="Remove from playlist">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      ` : ''}
    </div>
  `;
  
  // Click to play
  row.addEventListener('click', (e) => {
    if (e.target.closest('.psr-btn') || e.target.closest('.psr-drag-handle')) return;
    playSongById(s.id);
  });
  
  // Drag and drop for reordering
  if (isOwner) {
    initDragAndDropV2(row, s.id, playlist.id);
  }
  
  return row;
}

async function togglePlaylistSongLike(songId, btn) {
  try {
    const wasLiked = btn.classList.contains('liked');
    await toggleLike(songId, null, true);
    
    if (wasLiked) {
      btn.classList.remove('liked');
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
      btn.title = 'Like';
    } else {
      btn.classList.add('liked');
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
      btn.title = 'Unlike';
      // Like animation
      btn.style.transform = 'scale(1.3)';
      setTimeout(() => btn.style.transform = 'scale(1)', 200);
    }
  } catch (err) {
    toast('Failed to update like', 'error');
  }
}

async function removeSongFromPlaylist(songId) {
  if (!currentPlaylistId) return;
  
  try {
    await api('/playlists/' + currentPlaylistId + '/songs/' + songId, { method: 'DELETE' });
    toast('Song removed from playlist', 'success');
    loadPlaylistDetail(currentPlaylistId);
    logActivity(currentPlaylistId, 'removed', 'song');
  } catch (err) {
    toast('Failed to remove song', 'error');
  }
}

function initDragAndDropV2(row, songId, playlistId) {
  row.draggable = true;
  
  row.addEventListener('dragstart', (e) => {
    e.dataTransfer.setData('text/plain', songId);
    row.classList.add('dragging');
  });
  
  row.addEventListener('dragend', () => {
    row.classList.remove('dragging');
    document.querySelectorAll('.playlist-song-row-v2').forEach(r => {
      r.style.borderTop = '';
      r.style.borderBottom = '';
    });
  });
  
  row.addEventListener('dragover', (e) => {
    e.preventDefault();
    const afterElement = getDragAfterElement(row.parentElement, e.clientY);
    if (afterElement == null) {
      row.style.borderBottom = '2px solid var(--purple-500)';
    } else {
      row.style.borderTop = '2px solid var(--purple-500)';
    }
  });
  
  row.addEventListener('dragleave', () => {
    row.style.borderTop = '';
    row.style.borderBottom = '';
  });
  
  row.addEventListener('drop', async (e) => {
    e.preventDefault();
    const draggedSongId = e.dataTransfer.getData('text/plain');
    if (draggedSongId === songId) return;
    
    const afterElement = getDragAfterElement(row.parentElement, e.clientY);
    
    try {
      // Calculate new position
      const container = document.getElementById('playlistSongs');
      const allRows = [...container.querySelectorAll('.playlist-song-row-v2')];
      const draggedIndex = allRows.findIndex(r => r.dataset.songId === draggedSongId);
      const targetIndex = allRows.findIndex(r => r.dataset.songId === songId);
      
      let newPosition;
      if (afterElement == null) {
        newPosition = allRows.length;
      } else {
        const afterIndex = allRows.indexOf(afterElement);
        newPosition = draggedIndex < afterIndex ? afterIndex : afterIndex + 1;
      }
      
      await api(`/playlists/${playlistId}/songs/${draggedSongId}/move`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPosition })
      });
      
      // Reorder visually
      const draggedRow = allRows[draggedIndex];
      if (afterElement == null) {
        container.appendChild(draggedRow);
      } else {
        container.insertBefore(draggedRow, afterElement);
      }
      
      // Renumber
      allRows.forEach((r, i) => {
        const numEl = r.querySelector('.psr-num');
        if (numEl && !r.querySelector('.psr-playing-indicator')) {
          numEl.innerHTML = `<span class="psr-drag-handle" title="Drag to reorder">⋮⋮</span>${i + 1}`;
        }
      });
      
      toast('Song reordered', 'success');
    } catch (err) {
      toast('Failed to reorder', 'error');
      loadPlaylistDetail(playlistId); // Refresh on error
    }
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.playlist-song-row-v2:not(.dragging)')];
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

async function addSelectedToQueue() {
  if (selectedSongs.size === 0) return;
  
  const songsToAdd = [];
  for (const songId of selectedSongs) {
    try {
      const song = await api('/songs/' + songId);
      if (song.hasFilePath) songsToAdd.push(song);
    } catch {}
  }
  
  queue.push(...songsToAdd);
  renderQueue();
  toast(`Added ${songsToAdd.length} songs to queue`, 'success');
  clearSelection();
}

function addSelectedToPlaylist() {
  if (selectedSongs.size === 0) return;
  
  // Open playlist modal with first selected song
  const firstSongId = Array.from(selectedSongs)[0];
  openPlaylistModal(firstSongId);
  // Note: The modal will need to be enhanced to support adding multiple songs
  toast('Select a playlist to add the selected songs', 'info');
}

async function openAddCollaboratorModal(playlistId) {
  const username = prompt('Enter username or email to invite:');
  if (!username) return;
  
  try {
    await api(`/playlists/${playlistId}/collaborators`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    toast('Collaborator invited!', 'success');
    loadPlaylistDetail(playlistId);
  } catch (err) {
    toast(err.message, 'error');
  }
}

const originalPlayPlaylist = playPlaylist;
playPlaylist = async function(id) {
  try {
    const p = await api('/playlists/' + id);
    const playable = p.songs.filter(s => s.hasFilePath);
    if (!playable.length) { toast('No playable songs', 'error'); return; }
    
    queue = playable.slice(1);
    playSong(playable[0]);
    savePlaylistPosition(id, 0);
    toast('Playing ' + p.name, 'success');
    
    // Track history
    updatePlaylistHistory(id, 0);
    logActivity(id, 'played', '');
  } catch (err) { toast(err.message, 'error'); }
};

// ═══ INIT ═══
loadRecentlyPlayed();

// Initialize lyrics settings
document.documentElement.style.setProperty('--lyrics-font-size', '2.2rem');
document.documentElement.style.setProperty('--lyrics-align', 'center');
document.documentElement.style.setProperty('--lyrics-spacing', '4px');

// Restore saved lyrics settings
const savedLyricsSettings = localStorage.getItem('jv_lyrics_settings');
if (savedLyricsSettings) {
  try {
    const settings = JSON.parse(savedLyricsSettings);
    document.documentElement.style.setProperty('--lyrics-font-size', settings.fontSize + 'rem');
    document.documentElement.style.setProperty('--lyrics-align', settings.align);
    document.documentElement.style.setProperty('--lyrics-spacing', settings.spacing + 'px');
  } catch {}
}

checkAuth();
loadAuthCovers(); // Load real album covers for auth screen

// ─── Auth Screen: Dynamic Album Covers from DB ──────────
async function loadAuthCovers() {
  const placeholder = '/assets/JuiceVaultAlbumCoverPlaceHolder.png';
  const rows = 7;
  const itemsPerVisibleRow = 12;
  const totalUniqueNeeded = Math.max(48, itemsPerVisibleRow * rows * 2);
  
  try {
    // Fetch more covers for better variety - try to get up to 100
    const res = await fetch('/api/cover-gallery?limit=100');
    const data = await res.json();
    let covers = data.covers || [];
    
    // If we don't have enough unique covers, supplement with placeholders
    if (covers.length < totalUniqueNeeded) {
      while (covers.length < totalUniqueNeeded) {
        covers.push(placeholder);
      }
    }
    
    // Shuffle the covers array for randomness (Fisher-Yates)
    for (let i = covers.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [covers[i], covers[j]] = [covers[j], covers[i]];
    }
    
    // Generate covers for each row - each row gets different covers
    for (let r = 0; r < rows; r++) {
      const row = document.getElementById('albumRow' + r);
      if (!row) continue;
      row.innerHTML = '';
      
      // Calculate slice for this row - ensure no overlap between rows
      const rowStartIdx = (r * itemsPerVisibleRow * 2) % covers.length;
      const rowCovers = [];
      
      // Build this row's unique cover set
      for (let i = 0; i < itemsPerVisibleRow; i++) {
        const coverIdx = (rowStartIdx + i) % covers.length;
        rowCovers.push(covers[coverIdx] || placeholder);
      }
      
      // Create original set
      for (let c = 0; c < itemsPerVisibleRow; c++) {
        const src = rowCovers[c];
        const div = document.createElement('div');
        div.className = 'album-cover';
        div.innerHTML = '<img src="' + src + '" alt="" loading="lazy" onerror="this.src=\'' + placeholder + '\'">';
        row.appendChild(div);
      }
      
      // Duplicate the EXACT same set for seamless scroll
      for (let c = 0; c < itemsPerVisibleRow; c++) {
        const src = rowCovers[c];
        const div = document.createElement('div');
        div.className = 'album-cover';
        div.innerHTML = '<img src="' + src + '" alt="" loading="lazy" onerror="this.src=\'' + placeholder + '\'">';
        row.appendChild(div);
      }
    }
  } catch (err) {
    console.error('Failed to load auth covers:', err);
    // Fallback: create rows with placeholders
    for (let r = 0; r < rows; r++) {
      const row = document.getElementById('albumRow' + r);
      if (!row) continue;
      row.innerHTML = '';
      for (let c = 0; c < itemsPerVisibleRow * 2; c++) {
        const div = document.createElement('div');
        div.className = 'album-cover';
        div.innerHTML = '<img src="' + placeholder + '" alt="">';
        row.appendChild(div);
      }
    }
  }
}

// ─── Flag Song as Broken ────────────────────────────────
async function flagSongAsBroken(songId, songName, errorDetail) {
  try {
    const result = await api('/songs/' + songId + '/flag-broken', {
      method: 'POST',
      body: JSON.stringify({
        reason: 'Playback failed: ' + (songName || 'unknown'),
        proxyError: errorDetail || '',
        errorLog: 'User agent: ' + navigator.userAgent + '\nTime: ' + new Date().toISOString() + '\nError: ' + (errorDetail || 'Unknown playback error'),
      }),
    });
    toast('Song flagged as broken — admin notified', 'success');
    return result;
  } catch (err) {
    toast('Could not flag song: ' + err.message, 'error');
  }
}

// ===== JAVASCRIPT IMPROVEMENTS INJECTION =====
// ===== 60 IMPROVEMENTS JAVASCRIPT ADDITIONS =====

// 1. Toast notification limit - prevent stacking
const originalToast = window.toast;
window.toast = function(msg, type = 'info') {
  const container = document.getElementById('toastContainer');
  // Remove old toasts if more than 3
  while (container.children.length >= 3) {
    const oldToast = container.firstChild;
    oldToast.classList.add('removing');
    setTimeout(() => oldToast.remove(), 300);
  }
  originalToast(msg, type);
};

// 2. Search clear functionality
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    const searchBox = searchInput.closest('.search-box');
    if (searchBox) {
      const clearBtn = document.createElement('button');
      clearBtn.className = 'search-clear';
      clearBtn.innerHTML = '✕';
      clearBtn.title = 'Clear search';
      clearBtn.onclick = () => {
        searchInput.value = '';
        searchInput.focus();
        // Clear search results and go back to previous page
        if (currentPage === 'search') {
          navigateTo('home');
        }
      };
      searchBox.appendChild(clearBtn);
    }
  }
});

// 3. Audio player progress bar - wait for metadata before updating
audio.addEventListener('loadedmetadata', () => {
  updateProgressBar();
});


// === NEW FEATURES FROM MEGA UPDATE ===

// Scroll position restoration
const scrollPositions = {};

// Save queue to localStorage
function saveQueue() {
  const queueIds = queue.map(s => s.id);
  localStorage.setItem('jv_queue', JSON.stringify(queueIds));
}

// Restore queue from localStorage
function restoreQueue() {
  const saved = localStorage.getItem('jv_queue');
  if (saved) {
    const ids = JSON.parse(saved);
    Promise.all(ids.map(id => api('/songs/' + id).catch(() => null)))
      .then(songs => {
        queue = songs.filter(Boolean);
        renderQueue();
      });
  }
}

// Update sidebar active state
function updateSidebarActive() {
  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.page === currentPage);
  });
}

// Enhanced shuffle toggle
function toggleShuffle() {
  shuffleOn = !shuffleOn;
  const btn = document.getElementById('btnShuffle');
  btn.classList.toggle('active', shuffleOn);
  toast(shuffleOn ? 'Shuffle on' : 'Shuffle off', 'info');
  localStorage.setItem('jv_shuffle', shuffleOn);
}

// Enhanced repeat toggle  
function toggleRepeat() {
  repeatMode = (repeatMode + 1) % 3;
  const btn = document.getElementById('btnRepeat');
  const labels = ['Repeat off', 'Repeat all', 'Repeat one'];
  btn.classList.toggle('active', repeatMode > 0);
  toast(labels[repeatMode], 'info');
  localStorage.setItem('jv_repeat', repeatMode);
}

// Save playback position
setInterval(() => {
  if (currentSong && audio.currentTime > 0) {
    localStorage.setItem('jv_last_played', currentSong.id);
    localStorage.setItem('jv_last_position', audio.currentTime);
  }
  saveQueue();
}, 5000);

// Restore on load
window.addEventListener('load', () => {
  restoreQueue();
  updateSidebarActive();
});

// End of JavaScript
</script>
</body>
</html>
